class MusicCollectionApp{constructor(){this.currentFilter="all",this.currentSearch="",this.currentStyleFilter="",this.editingAlbum=null,this.autocompleteTimeout=null,this.artistAutocompleteTimeout=null,this.albumAutocompleteTimeout=null,this.isAuthenticated=!1}async fetchWithCache(e,t={}){const s={cache:"default",headers:{"Content-Type":"application/json",...t.headers}};return fetch(e,{...s,...t})}async init(){this.checkAuthStatus(),this.loadStats(),this.loadAlbums(),this.bindEvents(),this.setupAutocomplete(),await this.loadThemeColors()}async checkAuthStatus(){try{const e=await this.fetchWithCache("api/music_api.php?action=auth_check"),t=await e.json();t.success&&(this.isAuthenticated=t.data.authenticated)}catch(e){this.isAuthenticated=!1}this.updateAuthUI()}updateAuthUI(){const e=document.getElementById("addAlbumBtn"),t=document.getElementById("loginBtn"),s=document.getElementById("logoutBtn");e&&(this.isAuthenticated?(e.textContent="+ Add Album",e.style.opacity="1",e.style.cursor="pointer"):(e.textContent="+ Add Album (Login Required)",e.style.opacity="1",e.style.cursor="pointer")),t&&(t.style.display=this.isAuthenticated?"none":"flex"),s&&(s.style.display=this.isAuthenticated?"flex":"none")}bindEvents(){const e=document.getElementById("searchInput"),t=document.getElementById("clearSearch");e.addEventListener("input",(e=>{this.currentSearch=e.target.value,this.debounceSearch(),e.target.value.length>0?t.classList.add("visible"):t.classList.remove("visible"),this.handleStyleSearchSuggestions(e.target.value)})),t.addEventListener("click",(()=>{e.value="",this.currentSearch="",this.currentStyleFilter="",e.disabled=!1,this.debounceSearch(),t.classList.remove("visible"),e.focus();const s=document.getElementById("message");s&&s.classList.contains("info")&&(s.style.display="none")}));const s=document.getElementById("togglePassword"),a=document.getElementById("password"),o=s.querySelector(".eye-icon"),n=s.querySelector(".eye-slash-icon");s.addEventListener("click",(()=>{const e="password"===a.getAttribute("type")?"text":"password";a.setAttribute("type",e),"text"===e?(o.style.display="none",n.style.display="block"):(o.style.display="block",n.style.display="none")}));[{inputId:"reset_current_password",buttonId:"toggleResetCurrentPassword"},{inputId:"reset_new_password",buttonId:"toggleResetNewPassword"},{inputId:"reset_confirm_password",buttonId:"toggleResetConfirmPassword"}].forEach((e=>{const t=document.getElementById(e.buttonId),s=document.getElementById(e.inputId),a=t.querySelector(".eye-icon"),o=t.querySelector(".eye-slash-icon");t.addEventListener("click",(()=>{const e="password"===s.getAttribute("type")?"text":"password";s.setAttribute("type",e),"text"===e?(a.style.display="none",o.style.display="block"):(a.style.display="block",o.style.display="none")}))})),document.querySelectorAll(".filter-btn").forEach((e=>{e.addEventListener("click",(e=>{this.setFilter(e.target.dataset.filter)}))})),document.getElementById("addAlbumBtn").addEventListener("click",(()=>{this.showModal()})),document.getElementById("albumModal").addEventListener("click",(e=>{"albumModal"===e.target.id&&this.hideModal()})),document.getElementById("coverModal").addEventListener("click",(e=>{"coverModal"===e.target.id&&this.hideCoverModal()})),document.getElementById("tracklistModal").addEventListener("click",(e=>{"tracklistModal"===e.target.id&&this.hideTracklistModal()})),document.querySelectorAll(".close").forEach((e=>{e.addEventListener("click",(t=>{t.preventDefault(),t.stopPropagation();const s=e.closest(".modal");s&&("albumModal"===s.id?this.hideModal():"coverModal"===s.id?this.hideCoverModal():"tracklistModal"===s.id?this.hideTracklistModal():"loginModal"===s.id?this.hideLoginModal():"statsModal"===s.id?this.hideStatsModal():"resetPasswordModal"===s.id?this.hideResetPasswordModal():"setupModal"===s.id&&this.hideSetupModal())})),e.addEventListener("touchend",(t=>{t.preventDefault(),t.stopPropagation();const s=e.closest(".modal");s&&("albumModal"===s.id?this.hideModal():"coverModal"===s.id?this.hideCoverModal():"tracklistModal"===s.id?this.hideTracklistModal():"loginModal"===s.id?this.hideLoginModal():"statsModal"===s.id?this.hideStatsModal():"resetPasswordModal"===s.id?this.hideResetPasswordModal():"setupModal"===s.id&&this.hideSetupModal())}))})),document.getElementById("loginModal").addEventListener("click",(e=>{"loginModal"===e.target.id&&this.hideLoginModal()})),document.getElementById("loginForm").addEventListener("submit",(e=>{e.preventDefault(),this.handleLogin(e)})),document.querySelector("#loginModal .btn-cancel").addEventListener("click",(()=>{this.hideLoginModal()})),document.getElementById("statsModal").addEventListener("click",(e=>{"statsModal"===e.target.id&&this.hideStatsModal()})),document.querySelector("#statsModal .btn-cancel").addEventListener("click",(()=>{this.hideStatsModal()})),document.getElementById("resetPasswordModal").addEventListener("click",(e=>{"resetPasswordModal"===e.target.id&&this.hideResetPasswordModal()})),document.getElementById("resetPasswordForm").addEventListener("submit",(e=>{e.preventDefault(),this.handleResetPassword(e)})),document.querySelector("#resetPasswordModal .btn-cancel").addEventListener("click",(()=>{this.hideResetPasswordModal()})),document.querySelector("#resetPasswordModal .close").addEventListener("click",(()=>{this.hideResetPasswordModal()})),document.getElementById("setupModal").addEventListener("click",(e=>{"setupModal"===e.target.id&&this.hideSetupModal()})),document.getElementById("setupForm").addEventListener("submit",(e=>{e.preventDefault(),this.handleSetupConfig(e)})),document.querySelector("#setupModal .btn-cancel").addEventListener("click",(()=>{this.hideSetupModal()})),document.querySelector("#setupModal .close").addEventListener("click",(()=>{this.hideSetupModal()})),document.getElementById("setupPasswordBtn").addEventListener("click",(()=>{this.hideSetupModal(),this.showResetPasswordModal()})),document.getElementById("albumsTable").addEventListener("click",(e=>{if(e.target.classList.contains("album-cover")){const t=e.target.dataset.artist,s=e.target.dataset.album,a=e.target.dataset.year,o=e.target.dataset.cover,n=e.target.closest("tr").dataset.id;this.showCoverModal(t,s,a,o,n)}if(e.target.classList.contains("album-link")){e.preventDefault();const t=e.target.dataset.artist,s=e.target.dataset.album,a=e.target.dataset.year,o=e.target.closest("tr").dataset.id;this.showTracklist(t,s,a,o)}if(e.target.classList.contains("btn-edit")){const t=e.target.dataset.id;t&&this.editAlbum(parseInt(t))}if(e.target.classList.contains("btn-delete")){const t=e.target.dataset.id;t&&this.deleteAlbum(parseInt(t))}})),document.getElementById("albumForm").addEventListener("submit",(e=>{e.preventDefault(),this.saveAlbum()})),document.getElementById("cancelBtn").addEventListener("click",(()=>{this.hideModal()}))}setupAutocomplete(){const e=document.getElementById("artistName"),t=document.getElementById("albumName");this.updateAlbumInputState(),e.addEventListener("input",(e=>{this.debounceArtistAutocomplete(e.target.value),this.updateAlbumInputState()})),t.addEventListener("input",(t=>{const s=e.value.trim();s&&s.length>0?this.debounceAlbumAutocomplete(s,t.target.value):this.hideAutocomplete("albumAutocomplete")})),e.addEventListener("input",(e=>{e.target.value.trim()||(this.hideAutocomplete("albumAutocomplete"),t.value="",this.updateAlbumInputState())})),e.addEventListener("blur",(e=>{setTimeout((()=>{this.hideAutocomplete("artistAutocomplete")}),500)})),t.addEventListener("blur",(e=>{setTimeout((()=>{this.hideAutocomplete("albumAutocomplete")}),500)})),document.addEventListener("click",(e=>{e.target.closest(".autocomplete-container")||(this.hideAutocomplete("artistAutocomplete"),this.hideAutocomplete("albumAutocomplete"))}));const s=document.getElementById("formatFilter");s&&s.addEventListener("change",(s=>{const a=e.value.trim(),o=t.value.trim();a&&o&&o.length>=2&&this.debounceAlbumAutocomplete(a,o)})),this.setupDropdown()}setupDropdown(){const e=document.querySelector(".dropdown"),t=document.querySelector(".dropdown-menu");e&&t&&(t.addEventListener("click",(e=>{e.stopPropagation()})),document.addEventListener("click",(t=>{e.contains(t.target)||e.classList.remove("active")})),e.addEventListener("keydown",(t=>{"Escape"===t.key&&(e.classList.remove("active"),e.querySelector(".dropdown-toggle").blur())})))}updateAlbumInputState(){const e=document.getElementById("artistName"),t=document.getElementById("albumName");if(e&&t){const s=e.value.trim();s&&s.length>0?(t.disabled=!1,t.placeholder="Enter album name..."):(t.disabled=!0,t.placeholder="Select an artist first...")}}debounceArtistAutocomplete(e){clearTimeout(this.artistAutocompleteTimeout),this.artistAutocompleteTimeout=setTimeout((()=>{this.handleArtistAutocomplete(e)}),300)}debounceAlbumAutocomplete(e,t){clearTimeout(this.albumAutocompleteTimeout),this.albumAutocompleteTimeout=setTimeout((()=>{this.handleAlbumAutocomplete(e,t)}),300)}async handleArtistAutocomplete(e){if(e.length<2)this.hideAutocomplete("artistAutocomplete");else{this.showAutocompleteLoading("artistAutocomplete");try{const t=`api/music_api.php?action=artists&search=${encodeURIComponent(e)}`,s=await this.fetchWithCache(t),a=await s.json();a.success?this.showAutocomplete("artistAutocomplete",a.data,"artist_name"):this.hideAutocomplete("artistAutocomplete")}catch(e){this.hideAutocomplete("artistAutocomplete")}}}async handleAlbumAutocomplete(e,t){if(t.length<2)this.hideAutocomplete("albumAutocomplete");else{this.showAutocompleteLoading("albumAutocomplete");try{const s=document.getElementById("formatFilter")?.value||"";let a=`api/music_api.php?action=albums_by_artist&artist=${encodeURIComponent(e)}&search=${encodeURIComponent(t)}`;s&&(a+=`&format=${encodeURIComponent(s)}`);const o=await this.fetchWithCache(a),n=await o.json();n.success?this.showAutocomplete("albumAutocomplete",n.data,"album_name"):this.hideAutocomplete("albumAutocomplete")}catch(e){this.hideAutocomplete("albumAutocomplete")}}}showAutocomplete(e,t,s){const a=document.getElementById(e);let o=a.querySelector(".autocomplete-list");o||(o=document.querySelector(`[data-original-container="${e}"]`)),o&&(o.innerHTML="",t.forEach((t=>{if(t&&t[s]&&"undefined"!==t[s]){const a=document.createElement("div");a.className="autocomplete-item";const n=document.createElement("span");if("album_name"===s&&t.year?n.textContent=`${t[s]} (${t.year})`:n.textContent=t[s],"album_name"===s&&t.format&&(n.innerHTML=n.textContent+'<br><span class="format-text">'+t.format+"</span>"),a.appendChild(n),t.cover_url){const e=document.createElement("img");e.src=t.cover_url,e.className="autocomplete-cover",e.alt="Album cover",e.onerror=()=>{e.remove()},e.onload=()=>{},a.appendChild(e)}a.addEventListener("click",(a=>{a.preventDefault(),a.stopPropagation(),this.selectAutocompleteItem(e,t[s],t)})),o.appendChild(a)}})),o.children.length>0?(o.style.display="block",o.style.visibility="visible",o.style.opacity="1",o.style.zIndex="10000",o.style.position="absolute",o.style.backgroundColor="white",o.style.border="1px solid #ddd",o.style.borderRadius="4px",o.style.boxShadow="0 2px 8px rgba(0,0,0,0.1)",o.style.maxHeight="800px",o.style.overflowY="auto",this.adjustAutocompletePosition(a,o),setTimeout((()=>{this.adjustAutocompletePosition(a,o)}),10)):o.style.display="none")}showAutocompleteLoading(e){let t=document.getElementById(e).querySelector(".autocomplete-list");t||(t=document.querySelector(`[data-original-container="${e}"]`)),t&&(t.innerHTML='<div class="autocomplete-loading">Searching...</div>',t.style.display="block")}hideAutocomplete(e){let t=document.getElementById(e).querySelector(".autocomplete-list");if(t||(t=document.querySelector(`[data-original-container="${e}"]`)),t&&(t.style.display="none",t.style.visibility="hidden",t.style.opacity="0",t.parentNode===document.body&&t.dataset.originalContainer)){const e=document.getElementById(t.dataset.originalContainer);e&&(e.appendChild(t),t.style.position="",t.style.top="",t.style.left="",t.style.width="",t.style.zIndex="",delete t.dataset.originalContainer)}}selectAutocompleteItem(e,t,s=null){const a=document.getElementById(e).querySelector("input");if(a&&(a.value=t,s))if("artistAutocomplete"===e)this.selectedArtist=s;else if("albumAutocomplete"===e){this.selectedAlbum=s,this.selectedDiscogsReleaseId=s.id||null,this.selectedCoverUrl=s.cover_url||null;const e=document.getElementById("releaseYear");e&&(s.master_year?e.value=s.master_year:s.id?(e.value="",this.fetchMasterYearForSelection(s.id,e,s.year)):e.value=s.year||"")}this.hideAutocomplete(e)}debounceSearch(){clearTimeout(this.autocompleteTimeout),this.autocompleteTimeout=setTimeout((()=>{this.loadAlbums()}),300)}setFilter(e){this.currentFilter=e,this.currentStyleFilter="",document.querySelectorAll(".filter-btn").forEach((e=>{e.classList.remove("active")})),document.querySelector(`[data-filter="${e}"]`).classList.add("active"),this.loadAlbums()}filterByStyle(e){this.hideStatsModal(),this.currentStyleFilter=e;const t=document.getElementById("searchInput"),s=document.getElementById("clearSearch");t&&(t.value=`Style: ${e}`,t.disabled=!0,s.classList.add("visible")),this.showMessage(`Filtering by style: ${e}`,"info"),this.loadAlbums()}clearStyleFilter(){this.currentStyleFilter="";const e=document.getElementById("searchInput");e&&(e.value="",e.disabled=!1),this.loadAlbums()}handleStyleSearchSuggestions(e){const t=e.toLowerCase();if(t.startsWith("style:")||t.startsWith("genre:")||t.startsWith("type:")){const t=e.replace(/^(style|genre|type):\s*/i,"").trim();if(""===t)this.showMessage('Type a style name after "style:" (e.g., style: rock, style: jazz)',"info");else if(t.length>0){const e=document.getElementById("message");e&&e.classList.contains("info")&&(e.style.display="none")}}}async loadStats(){try{const e=await this.fetchWithCache("api/music_api.php?action=stats"),t=await e.json();t.success&&this.updateStats(t.data)}catch(e){}}updateStats(e){document.getElementById("modalTotalAlbums").textContent=e.total_albums||0,document.getElementById("modalOwnedAlbums").textContent=e.owned_count||0,document.getElementById("modalWantedAlbums").textContent=e.wanted_count||0,document.getElementById("modalUniqueArtists").textContent=e.unique_artists||0;const t=document.getElementById("styleStatsList");if(t&&e.style_counts){const s=Object.entries(e.style_counts);if(s.length>0){const e=s;t.innerHTML=e.map((([e,t])=>`\n                  <div class="style-stat-item" data-style="${this.escapeHtml(e)}">\n                      <span class="style-name">${this.escapeHtml(e)}</span>\n                      <span class="style-count">${t}</span>\n                  </div>\n              `)).join(""),t.querySelectorAll(".style-stat-item").forEach((e=>{e.addEventListener("click",(t=>{t.preventDefault();const s=e.dataset.style;this.filterByStyle(s)}))}))}else t.innerHTML='<p class="no-styles">No style information available</p>'}}async loadAlbums(){this.showLoading();const e=document.querySelector(".table-container");e&&e.classList.add("loading");try{const e=this.currentSearch.toLowerCase(),t=["style:","genre:","type:"].some((t=>e.startsWith(t)))?"":this.currentSearch,s=new URLSearchParams({action:"albums",filter:this.currentFilter,search:t}),a=await this.fetchWithCache(`api/music_api.php?${s}`),o=await a.json();if(o.success){let e=o.data;if(this.currentStyleFilter&&(e=e.filter((e=>{if(!e.style)return!1;return e.style.split(",").map((e=>e.trim())).includes(this.currentStyleFilter)}))),this.currentSearch&&!this.currentStyleFilter){const t=this.currentSearch.toLowerCase();if(["style:","genre:","type:"].some((e=>t.startsWith(e)))){const t=this.currentSearch.replace(/^(style|genre|type):\s*/i,"").trim();t&&(e=e.filter((e=>{if(!e.style)return!1;const s=e.style.toLowerCase(),a=t.toLowerCase();return s.split(",").map((e=>e.trim().toLowerCase())).some((e=>e.includes(a)))})))}}this.renderAlbums(e)}else this.showMessage("Error loading albums: "+o.message,"error")}catch(e){this.showMessage("Error loading albums","error")}finally{this.hideLoading(),e&&e.classList.remove("loading")}}renderAlbums(e){const t=document.querySelector("#albumsTable tbody");0!==e.length?(t.innerHTML=e.map((e=>`\n          <tr data-id="${e.id}">\n              <td class="cover-cell">\n                  ${e.cover_url?`<img data-src="${e.cover_url}" data-medium="${e.cover_url_medium||e.cover_url}" data-large="${e.cover_url_large||e.cover_url}" class="album-cover lazy" alt="Album cover" data-artist="${this.escapeHtml(e.artist_name)}" data-album="${this.escapeHtml(e.album_name)}" data-year="${e.release_year||""}" data-cover="${e.cover_url_large||e.cover_url}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" onload="this.classList.add('loaded')" width="60" height="60">\n                       <div class="no-cover" style="display: none;">No Cover</div>`:'<div class="no-cover">No Cover</div>'}\n                  <div class="mobile-status">\n                      ${e.is_owned?'<span class="status-owned">Own</span>':""}\n                      ${e.want_to_own?'<span class="status-wanted">Want</span>':""}\n                      ${e.is_owned||e.want_to_own?"":'<span class="status-none">-</span>'}\n                  </div>\n              </td>\n              <td>\n                  <div class="album-info">\n                      <div class="artist-name">${this.escapeHtml(e.artist_name)}</div>\n                      <div class="album-name">\n                          <a href="#" class="album-link" data-artist="${this.escapeHtml(e.artist_name)}" data-album="${this.escapeHtml(e.album_name)}" data-year="${e.release_year||""}">\n                              ${this.escapeHtml(e.album_name)}\n                          </a>\n                      </div>\n                      <div class="mobile-year">${e.release_year?`<span class="year-badge">${e.release_year}</span>`:'<span class="year-badge">-</span>'}</div>\n                      <div class="mobile-actions">\n                          <button class="btn-edit" data-id="${e.id}">Edit</button>\n                          <button class="btn-delete" data-id="${e.id}">Delete</button>\n                      </div>\n                  </div>\n              </td>\n              <td>\n                  ${e.release_year?`<span class="year-badge">${e.release_year}</span>`:'<span class="year-badge">-</span>'}\n              </td>\n              <td>\n                  ${e.is_owned?'<span class="checkmark">✓</span>':'<span class="checkmark">&nbsp;</span>'}\n              </td>\n              <td>\n                  ${e.want_to_own?'<span class="checkmark">✓</span>':'<span class="checkmark">&nbsp;</span>'}\n              </td>\n              <td>\n                  <div class="action-buttons">\n                      <button class="btn-edit" data-id="${e.id}">Edit</button>\n                      <button class="btn-delete" data-id="${e.id}">Delete</button>\n                  </div>\n              </td>\n          </tr>\n      `)).join(""),this.initLazyLoading()):t.innerHTML='\n              <tr>\n                  <td colspan="6" class="empty-state">\n                      <h3>No albums found</h3>\n                      <p>Try adjusting your search or filter criteria</p>\n                  </td>\n              </tr>\n          '}async fetchMasterYearForSelection(e,t,s=null){try{const a=await this.fetchWithCache(`api/music_api.php?action=master_year&release_id=${e}`),o=await a.json();o.success&&o.data&&o.data.master_year?t&&(t.value=o.data.master_year):s&&t&&(t.value=s)}catch(e){s&&t&&(t.value=s)}}async editAlbum(e){try{const t=await this.fetchWithCache(`api/music_api.php?action=album&id=${e}`),s=await t.json();s.success?(this.editingAlbum=s.data,this.showModal(s.data)):this.showMessage("Error loading album: "+s.message,"error")}catch(e){this.showMessage("Error loading album","error")}}async deleteAlbum(e){if(this.isAuthenticated){if(confirm("Are you sure you want to delete this album?"))try{const t=new AbortController,s=setTimeout((()=>t.abort()),1e4),a=await fetch("api/music_api.php?action=delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e}),signal:t.signal});clearTimeout(s);const o=await a.json();o.success?(this.showMessage("Album deleted successfully","success"),this.loadAlbums(),this.loadStats()):o.auth_required?this.showLoginModal():this.showMessage("Error deleting album: "+o.message,"error")}catch(e){"AbortError"===e.name?this.showMessage("Delete request timed out. Please try again.","error"):this.showMessage("Error deleting album","error")}}else this.showLoginModal()}showModal(e=null){const t=document.getElementById("albumModal"),s=document.getElementById("albumForm"),a=document.querySelector("#albumModal h2");if(s.reset(),this.hideModalMessage(),e){a.textContent="Edit Album",document.getElementById("artistName").value=e.artist_name,document.getElementById("albumName").value=e.album_name,document.getElementById("releaseYear").value=e.release_year||"",this.selectedCoverUrl=e.cover_url||null,this.selectedDiscogsReleaseId=e.discogs_release_id||null,1==e.is_owned?document.getElementById("isOwned").checked=!0:1==e.want_to_own&&(document.getElementById("wantToOwn").checked=!0);const t=document.getElementById("albumName");t.disabled=!1,t.placeholder="Enter album name..."}else a.textContent="Add New Album",this.editingAlbum=null,this.selectedCoverUrl=null,this.selectedDiscogsReleaseId=null,this.updateAlbumInputState();t.style.display="block",document.getElementById("artistName").focus()}hideModal(){document.getElementById("albumModal").style.display="none",this.editingAlbum=null,this.selectedCoverUrl=null,this.selectedDiscogsReleaseId=null,this.hideModalMessage()}hideModalMessage(){const e=document.getElementById("modalMessage");e.style.display="none",e.textContent="",e.className="modal-message"}async saveAlbum(){if(!this.isAuthenticated)return void this.showLoginModal();const e=document.getElementById("albumForm"),t=new FormData(e),s=t.get("albumStatus");if(!s)return void this.showModalMessage('Please select either "I own this album" or "I want to own this album"',"error");const a={artist_name:t.get("artistName"),album_name:t.get("albumName"),release_year:t.get("releaseYear"),is_owned:"owned"===s,want_to_own:"wanted"===s,cover_url:this.selectedCoverUrl||null,discogs_release_id:this.selectedDiscogsReleaseId||null},o=this.editingAlbum?"update":"add";this.editingAlbum&&(a.id=this.editingAlbum.id);try{const e=await fetch(`api/music_api.php?action=${o}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);const t=await e.text();if(!t.trim())throw new Error("Empty response from server");let s;try{s=JSON.parse(t)}catch(e){throw new Error(`Invalid JSON response: ${e.message}`)}s.success?(this.hideModal(),this.showMessage(s.message,"success"),this.loadAlbums(),this.loadStats(),this.editingAlbum=null):s.auth_required?this.showLoginModal():this.showModalMessage(s.message||"Unknown error occurred","error")}catch(e){this.showModalMessage("Network error: "+e.message,"error")}}showLoading(){document.getElementById("loading").style.display="block"}hideLoading(){document.getElementById("loading").style.display="none"}showModalMessage(e,t){const s=document.getElementById("modalMessage");s.textContent=e,s.className=`modal-message ${t}`,s.style.display="block",setTimeout((()=>{s.style.display="none"}),5e3)}showMessage(e,t){const s=document.getElementById("message");s.textContent=e,s.className=`message ${t}`,s.style.display="block",setTimeout((()=>{s.style.display="none"}),5e3)}async showCoverModal(e,t,s,a,o=null){const n=document.getElementById("coverModal"),l=document.getElementById("coverModalImage"),i=document.getElementById("coverModalInfo");if(l.src=a,l.alt=`${t} by ${e}`,i.innerHTML=`\n          <div class="artist-name">${this.escapeHtml(e)}</div>\n          <div class="album-name">${this.escapeHtml(t)}</div>\n          ${s?`<div class="album-year">${s}</div>`:""}\n      `,n.style.display="block",o)try{const a=new URLSearchParams({artist:e,album:t});s&&a.append("year",s),a.append("album_id",o);const n=await this.fetchWithCache(`api/tracklist_api.php?${a}`),l=await n.json();if(l.success&&l.data&&l.data.master_year){const e=i.querySelector(".album-year");e&&(e.textContent=l.data.master_year)}}catch(e){}}hideCoverModal(){document.getElementById("coverModal").style.display="none"}async showTracklist(e,t,s,a=null){const o=document.getElementById("tracklistModal"),n=document.getElementById("tracklistModalTitle"),l=document.getElementById("tracklistModalInfo"),i=document.getElementById("tracklistModalTracks"),d=document.getElementById("tracklistModalDiscogsLink"),r=document.getElementById("tracklistModalCover"),c=document.getElementById("tracklistModalNoCover");n.textContent=`${t}`,l.innerHTML=`\n          <div><strong>Artist:</strong> ${e}</div>\n          ${s?`<div><strong>Year:</strong> ${s}</div>`:""}\n      `,r.style.display="none",c.style.display="none",c.textContent="";let u=null;if(a){const e=document.querySelector(`tr[data-id="${a}"]`);if(e){const t=e.querySelector(".album-cover");t&&t.src&&t.src!==window.location.href&&(u=t.src)}}u&&(r.src=u,r.style.display="block",c.style.display="none",r.classList.add("loaded")),i.innerHTML='<div class="tracklist-loading">Loading tracklist...</div>',o.style.display="block";try{const o=new URLSearchParams({artist:e,album:t});s&&o.append("year",s),a&&o.append("album_id",a);const n=await this.fetchWithCache(`api/tracklist_api.php?${o}`),m=await n.json();if(m.success&&m.data){const e=m.data;let t="";if(e.released)try{let s=e.released,a=!1;s.match(/^\d{4}-\d{2}-00$/)&&(a=!0,s=s.replace("-00","-01"));const o=s.split("-"),n=parseInt(o[0]),l=parseInt(o[1])-1,i=parseInt(o[2]),d=new Date(n,l,i);if(isNaN(d.getTime()))t=e.released;else{const e=d.getMonth(),s=d.getDate();t=a||11===e&&31===s?n.toString():d.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}}catch(s){t=e.released}let s="";if(e.rating_count){const t=1===e.rating_count?"review":"reviews";s=e.has_reviews_with_content?`<div class="rating-count">(based on <a href="${e.discogs_url}#release-reviews" target="_blank" rel="noopener noreferrer" style="padding-left: .25em;">${e.rating_count} ${t}</a>)</div>`:`<div class="rating-count">(based on ${e.rating_count} ${t})</div>`}const a=e=>e?e.replace(/\s*\(\d+\)\s*$/,""):e;if(l.innerHTML=`\n                  <div><strong>Artist:</strong> <span>${a(e.artist)}</span></div>\n                  ${t?`<div><strong>Year:</strong> <span>${t}</span></div>`:""}\n                  ${e.label?`<div><strong>Label:</strong> <span>${a(e.label)}</span></div>`:""}\n                  ${e.year?`<div><strong>Released:</strong> <span>${e.year}</span></div>`:""}\n                  ${e.format?`<div><strong>Format:</strong> <span>${e.format}</span></div>`:""}\n                  ${e.producer?`<div><strong>Producer:</strong> <span>${a(e.producer)}</span></div>`:""}\n                  ${e.rating?`<div><strong>Rating:</strong> <span class="rating-value">${e.rating}${this.generateStarRating(e.rating)}</span>${s}</div>`:""}\n              `,!u&&e.cover_url){const t=e.cover_url_medium||e.cover_url;t.includes("api/image_proxy.php")?(r.style.display="none",c.style.display="none",c.textContent=""):(c.textContent="Loading Cover...",c.style.display="flex",r.style.display="none"),r.src=t;const s=setTimeout((()=>{"none"===r.style.display&&(r.style.display="none",c.textContent="No Cover",c.style.display="flex")}),1e4);r.onload=function(){clearTimeout(s),r.style.display="block",c.style.display="none",r.classList.add("loaded")},r.onerror=function(){clearTimeout(s),r.style.display="none",c.textContent="No Cover",c.style.display="flex"}}else u||e.cover_url||(r.style.display="none",c.textContent="No Cover",c.style.display="flex");if(d.href=e.discogs_url,e.matched_reason){const t=document.createElement("div");t.className="tracklist-match-info",t.innerHTML=`<small>Matched: ${e.matched_reason}</small>`,i.appendChild(t)}e.tracklist&&e.tracklist.length>0?i.innerHTML=`\n                      <div class="tracklist-modal-tracks">\n                          ${e.tracklist.map((e=>`\n                              <div class="track-item">\n                                  <span class="track-position">${e.position}</span>\n                                  <span class="track-title">${this.escapeHtml(e.title)}</span>\n                                  <span class="track-duration">${e.duration||""}</span>\n                              </div>\n                          `)).join("")}\n                      </div>\n                  `:i.innerHTML='<div class="tracklist-error">No tracklist available for this album</div>'}else{let s="Could not load tracklist";m.message&&!m.message.includes("Discogs API request failed")&&(s=m.message),i.innerHTML=`<div class="tracklist-error">${s}</div>`,d.href=`https://www.discogs.com/search/?q=${encodeURIComponent(e+" "+t)}&type=release`}}catch(s){i.innerHTML='<div class="tracklist-error">Could not load tracklist. Please try again later.</div>',d.href=`https://www.discogs.com/search/?q=${encodeURIComponent(e+" "+t)}&type=release`}}hideTracklistModal(){document.getElementById("tracklistModal").style.display="none"}showLoginModal(){document.getElementById("loginModal").style.display="block",document.getElementById("password").focus(),document.getElementById("loginMessage").style.display="none"}showStatsModal(){document.getElementById("statsModal").style.display="block"}hideStatsModal(){document.getElementById("statsModal").style.display="none"}showResetPasswordModal(){this.isAuthenticated?(this.checkPasswordStatus(),document.getElementById("resetPasswordMessage").style.display="none",document.getElementById("resetPasswordForm").reset(),document.getElementById("resetPasswordModal").style.display="block",document.getElementById("reset_current_password").focus()):this.showLoginModal()}hideResetPasswordModal(){document.getElementById("resetPasswordModal").style.display="none",document.getElementById("resetPasswordForm").reset(),document.getElementById("resetPasswordMessage").style.display="none"}async checkPasswordStatus(){try{const e=await fetch("api/music_api.php?action=auth_check"),t=await e.json();if(t.success){const e=document.getElementById("passwordStatusText"),s=document.getElementById("passwordStatus");t.data.authenticated?(e.textContent="Set",s.className="password-status set"):(e.textContent="Not set",s.className="password-status not-set")}}catch(e){console.error("Error checking password status:",e)}}async handleResetPassword(e){e.preventDefault();const t=document.getElementById("reset_current_password").value,s=document.getElementById("reset_new_password").value,a=document.getElementById("reset_confirm_password").value,o=document.getElementById("resetPasswordMessage");try{const e=await fetch("api/music_api.php?action=reset_password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({current_password:t,new_password:s,confirm_password:a})}),n=await e.json();n.success?(o.textContent=n.message,o.className="modal-message success",o.style.display="block",document.getElementById("resetPasswordForm").reset(),this.checkPasswordStatus(),setTimeout((()=>{this.hideResetPasswordModal()}),3e3)):(o.textContent=n.message,o.className="modal-message error",o.style.display="block")}catch(e){o.textContent="Network error. Please try again.",o.className="modal-message error",o.style.display="block"}}showSetupModal(){this.isAuthenticated?(this.loadSetupStatus(),document.getElementById("setupMessage").style.display="none",document.getElementById("setupForm").reset(),document.getElementById("setupModal").style.display="block",this.setupThemeCustomization(),document.getElementById("setup_discogs_api_key").focus()):this.showLoginModal()}hideSetupModal(){document.getElementById("setupModal").style.display="none",document.getElementById("setupForm").reset(),document.getElementById("setupMessage").style.display="none"}async loadSetupStatus(){try{const e=await fetch("api/music_api.php?action=get_setup_status"),t=await e.json();if(t.success){const e=t.data,s=document.getElementById("apiKeyStatus"),a=document.getElementById("currentApiKeyDisplay"),o=document.getElementById("currentApiKeyText");e.api_key_set?(s.textContent="✅ Set",s.className="status-value set",a.style.display="block",o.textContent=e.current_api_key):(s.textContent="❌ Not set",s.className="status-value not-set",a.style.display="none");const n=document.getElementById("passwordStatus"),l=document.getElementById("passwordActionText");e.password_set?(n.textContent="✅ Set",n.className="status-value set",l.textContent="Change Password"):(n.textContent="❌ Not set",n.className="status-value not-set",l.textContent="Set Password");const i=document.getElementById("overallStatus");e.setup_complete?(i.textContent="✅ Complete",i.className="status-value set"):(i.textContent="⚠️ Incomplete",i.className="status-value not-set")}}catch(e){console.error("Error loading setup status:",e)}}async handleSetupConfig(e){e.preventDefault();const t=document.getElementById("setup_discogs_api_key").value,s=document.getElementById("setupMessage");try{const e=await fetch("api/music_api.php?action=setup_config",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({discogs_api_key:t})}),a=await e.json();a.success?(s.textContent=a.message,s.className="modal-message success",s.style.display="block",document.getElementById("setupForm").reset(),this.loadSetupStatus(),setTimeout((()=>{this.hideSetupModal()}),3e3)):(s.textContent=a.message,s.className="modal-message error",s.style.display="block")}catch(e){s.textContent="Network error. Please try again.",s.className="modal-message error",s.style.display="block"}}hideLoginModal(){const e=document.getElementById("loginModal");e&&(e.style.display="none"),document.getElementById("password").value="";const t=document.getElementById("loginMessage");t&&(t.style.display="none")}async handleLogin(e){e.preventDefault();const t=document.getElementById("password").value,s=document.getElementById("loginMessage");if(!t)return s.textContent="Please enter a password.",s.className="modal-message error",void(s.style.display="block");try{const e=new AbortController,a=setTimeout((()=>e.abort()),1e4),o=await fetch("api/music_api.php?action=login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:t}),signal:e.signal});clearTimeout(a);const n=await o.json();n.success?(this.isAuthenticated=!0,this.updateAuthUI(),this.hideLoginModal(),this.showMessage("Login successful","success")):(s.textContent=n.message,s.className="modal-message error",s.style.display="block")}catch(e){"AbortError"===e.name?s.textContent="Login request timed out. Please try again.":s.textContent="Login failed. Please try again.",s.className="modal-message error",s.style.display="block"}}async handleLogout(){try{const e=await fetch("api/music_api.php?action=logout",{method:"POST",headers:{"Content-Type":"application/json"}});(await e.json()).success&&(this.isAuthenticated=!1,this.updateAuthUI(),this.showMessage("Logged out successfully","success"))}catch(e){}}initLazyLoading(){if("IntersectionObserver"in window){const e=new IntersectionObserver(((e,t)=>{e.forEach((e=>{if(e.isIntersecting){const s=e.target;this.loadOptimizedImage(s,s.dataset.src),s.classList.remove("lazy"),s.classList.add("loaded"),t.unobserve(s)}}))}),{rootMargin:"50px 0px",threshold:.01});document.querySelectorAll("img.lazy").forEach((t=>{e.observe(t)}))}else this.loadLazyImagesFallback()}loadLazyImagesFallback(){const e=document.querySelectorAll("img.lazy"),t=e=>{e.dataset.src&&(this.loadOptimizedImage(e,e.dataset.src),e.classList.remove("lazy"))};e.forEach((e=>{this.isElementInViewport(e)&&t(e)}));const s=()=>{e.forEach((e=>{e.classList.contains("lazy")&&this.isElementInViewport(e)&&t(e)}))};window.addEventListener("scroll",s),window.addEventListener("resize",s)}isElementInViewport(e){const t=e.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&t.right<=(window.innerWidth||document.documentElement.clientWidth)}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}formatDate(e){if(!e)return"-";return new Date(e).toLocaleDateString()}loadOptimizedImage(e,t,s=null){if(this.isWebPSupported()&&t.includes("discogs.com")&&!t.includes("fm=webp")){const a=t.includes("?")?t+"&fm=webp":t+"?fm=webp";e.src=a,e.onerror=()=>{e.src=t,s&&(e.onerror=()=>{e.src=s})}}else e.src=t,s&&(e.onerror=()=>{e.src=s})}isWebPSupported(){const e=document.createElement("canvas");return e.width=1,e.height=1,0===e.toDataURL("image/webp").indexOf("data:image/webp")}generateStarRating(e){const t=Math.floor(e),s=e%1;let a="";s>=.875?a="filled":s>=.625?a="three-quarter":s>=.375?a="half":s>=.125&&(a="quarter");const o=5-(t+(a?1:0));let n='<span class="stars">';for(let e=0;e<t;e++)n+='<span class="star filled">★</span>';a&&"filled"!==a?n+=`<span class="star ${a}">★</span>`:"filled"===a&&(n+='<span class="star filled">★</span>');for(let e=0;e<o;e++)n+='<span class="star empty">☆</span>';return n+="</span>",n}adjustAutocompletePosition(e,t){const s=e.closest(".modal");if(!s)return;const a=s.querySelector(".modal-content"),o=e.getBoundingClientRect(),n=a.getBoundingClientRect();t.style.top="100%",t.style.bottom="auto",t.style.maxHeight="150px";const l=n.bottom-o.bottom-20,i=o.top-n.top-20,d=Math.min(t.scrollHeight,150);l<d&&i>d?(t.style.top="auto",t.style.bottom="100%",t.style.maxHeight=`${Math.min(i,150)}px`):t.style.maxHeight=l<d?`${Math.max(l,100)}px`:`${Math.min(l,150)}px`;const r=t.offsetWidth,c=e.offsetWidth;r>c&&(t.style.width=`${c}px`)}moveAutocompleteToBody(e,t){if(e.closest(".modal")&&t.parentNode!==document.body){document.body.appendChild(t);const s=e.getBoundingClientRect();t.style.position="fixed",t.style.top=s.bottom+window.scrollY+"px",t.style.left=s.left+"px",t.style.width=s.width+"px",t.style.zIndex="10000",t.style.backgroundColor="white",t.style.border="1px solid #ddd",t.style.borderRadius="4px",t.style.boxShadow="0 2px 8px rgba(0,0,0,0.1)",t.style.display="block",t.style.visibility="visible",t.style.opacity="1",t.dataset.originalContainer=e.id}}setupThemeCustomization(){this.loadThemeColors();const e=document.getElementById("gradientColor1"),t=document.getElementById("gradientColor2"),s=document.getElementById("gradientColor1Hex"),a=document.getElementById("gradientColor2Hex"),o=document.getElementById("resetThemeBtn"),n=document.getElementById("saveThemeBtn");e&&e.addEventListener("change",(e=>{s.value=e.target.value,this.previewTheme()})),t&&t.addEventListener("change",(e=>{a.value=e.target.value,this.previewTheme()})),s&&s.addEventListener("input",(t=>{const s=t.target.value;this.isValidHexColor(s)&&(e.value=s,this.previewTheme())})),a&&a.addEventListener("input",(e=>{const s=e.target.value;this.isValidHexColor(s)&&(t.value=s,this.previewTheme())})),o&&o.addEventListener("click",(()=>{this.resetTheme()})),n&&n.addEventListener("click",(()=>{this.saveThemeColors(),this.showThemeMessage("Theme colors saved successfully!","success")}))}async loadThemeColors(){try{const e=await fetch("api/theme_api.php"),t=await e.json();if(t.success){const e=t.data.gradient_color_1,s=t.data.gradient_color_2,a=localStorage.getItem("gradientColor1"),o=localStorage.getItem("gradientColor2");a&&o&&(a!==e||o!==s)&&(console.log("localStorage colors differ from server, updating localStorage"),localStorage.setItem("gradientColor1",e),localStorage.setItem("gradientColor2",s)),this.updateColorPickerInputs(e,s),this.applyThemeColors(e,s)}else console.warn("Server theme load failed:",t.message),this.fallbackToLocalStorage()}catch(e){console.warn("Server theme load error:",e),this.fallbackToLocalStorage()}}fallbackToLocalStorage(){const e=localStorage.getItem("gradientColor1")||"#667eea",t=localStorage.getItem("gradientColor2")||"#764ba2";console.log("Falling back to localStorage:",e,t),this.updateColorPickerInputs(e,t),this.applyThemeColors(e,t)}updateColorPickerInputs(e,t){const s=document.getElementById("gradientColor1"),a=document.getElementById("gradientColor1Hex"),o=document.getElementById("gradientColor2"),n=document.getElementById("gradientColor2Hex");s&&a&&o&&n&&(s.value=e,a.value=e,o.value=t,n.value=t)}async saveThemeColors(){const e=document.getElementById("gradientColor1").value,t=document.getElementById("gradientColor2").value;localStorage.setItem("gradientColor1",e),localStorage.setItem("gradientColor2",t),this.applyThemeColors(e,t);try{const s=await fetch("api/theme_api.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({gradient_color_1:e,gradient_color_2:t})}),a=await s.json();a.success||console.warn("Failed to save theme to server:",a.message)}catch(e){console.warn("Failed to save theme to server:",e)}}applyThemeColors(e,t){document.body.style.background=`linear-gradient(135deg, ${e} 0%, ${t} 100%)`}previewTheme(){const e=document.getElementById("gradientColor1").value,t=document.getElementById("gradientColor2").value;this.applyThemeColors(e,t)}resetTheme(){const e="#667eea",t="#764ba2",s=document.getElementById("gradientColor1"),a=document.getElementById("gradientColor1Hex"),o=document.getElementById("gradientColor2"),n=document.getElementById("gradientColor2Hex");s&&a&&o&&n&&(s.value=e,a.value=e,o.value=t,n.value=t,this.applyThemeColors(e,t),this.saveThemeColors())}isValidHexColor(e){return/^#[0-9A-Fa-f]{6}$/.test(e)}showSetupMessage(e,t){const s=document.getElementById("setupMessage");s&&(s.textContent=e,s.className=`modal-message ${t}`,s.style.display="block",setTimeout((()=>{s.style.display="none"}),3e3))}showThemeMessage(e,t){const s=document.getElementById("themeMessage");s&&(s.textContent=e,s.className=`modal-message ${t}`,s.style.display="block",setTimeout((()=>{s.style.display="none"}),3e3))}}document.addEventListener("DOMContentLoaded",(async()=>{window.app=new MusicCollectionApp,await window.app.init()}));