class MusicCollectionApp{constructor(){this.currentFilter="owned",this.currentSearch="",this.currentStyleFilter="",this.currentFormatFilter="",this.currentYearFilter="",this.editingAlbum=null,this.autocompleteTimeout=null,this.artistAutocompleteTimeout=null,this.albumAutocompleteTimeout=null,this.isAuthenticated=!1,this.currentSort={field:"artist",direction:"asc"}}async fetchWithCache(e,t={}){const s={cache:"default",headers:{"Content-Type":"application/json",...t.headers}};return fetch(e,{...s,...t})}async init(){this.checkAuthStatus(),this.loadStats(),this.loadAlbums(),this.bindEvents(),this.setupAutocomplete(),await this.loadThemeColors(),this.updateSortIndicators();const e=new URLSearchParams(window.location.search);if("true"===e.get("cache_cleared")){this.showMessage("All caches cleared successfully. Fresh data loaded.","success"),e.delete("cache_cleared"),e.delete("_cache_clear");const t=window.location.pathname+(e.toString()?"?"+e.toString():"");window.history.replaceState({},"",t)}}async checkAuthStatus(){try{const e=await fetch("api/music_api.php?action=auth_status",{cache:"no-cache",headers:{"Content-Type":"application/json"}}),t=await e.json();t.success&&(this.isAuthenticated=t.data.authenticated)}catch(e){this.isAuthenticated=!1}this.updateAuthUI()}updateAuthUI(){const e=document.getElementById("addAlbumBtn"),t=document.getElementById("loginBtn"),s=document.getElementById("logoutBtn");e&&(this.isAuthenticated?(e.textContent="+ Add Album",e.style.display="block",e.style.opacity="1",e.style.cursor="pointer"):e.style.display="none"),t&&(t.style.display=this.isAuthenticated?"none":"flex"),s&&(s.style.display=this.isAuthenticated?"flex":"none");const a=document.querySelectorAll(".btn-edit"),n=document.querySelectorAll(".btn-delete");a.forEach(e=>{e.style.display=this.isAuthenticated?"inline-block":"none"}),n.forEach(e=>{e.style.display=this.isAuthenticated?"inline-block":"none"});const o=document.querySelector("th:last-child"),l=document.querySelectorAll("td:last-child");o&&(o.style.display=this.isAuthenticated?"table-cell":"none"),l.forEach(e=>{e.style.display=this.isAuthenticated?"table-cell":"none"});const i=document.getElementById("clearCacheBtn");i&&(i.style.display=this.isAuthenticated?"flex":"none");const r=document.getElementById("setupBtn");r&&(r.style.display=this.isAuthenticated?"flex":"none");const d=document.getElementById("resetPasswordBtn");d&&(d.style.display=this.isAuthenticated?"flex":"none")}bindEvents(){const e=document.getElementById("searchInput"),t=document.getElementById("clearSearch");e.addEventListener("input",e=>{this.currentSearch=e.target.value,this.debounceSearch(),e.target.value.length>0?t.classList.add("visible"):t.classList.remove("visible"),this.handleStyleSearchSuggestions(e.target.value)}),t.addEventListener("click",()=>{e.value="",this.currentSearch="",this.currentStyleFilter="",this.currentFormatFilter="",this.currentYearFilter="",e.disabled=!1,this.debounceSearch(),t.classList.remove("visible"),e.focus();const s=document.getElementById("message");s&&s.classList.contains("info")&&(s.style.display="none"),this.loadStats()});const s=document.getElementById("togglePassword"),a=document.getElementById("password"),n=s.querySelector(".eye-icon"),o=s.querySelector(".eye-slash-icon");s.addEventListener("click",()=>{const e="password"===a.getAttribute("type")?"text":"password";a.setAttribute("type",e),"text"===e?(n.style.display="none",o.style.display="block"):(n.style.display="block",o.style.display="none")});[{inputId:"reset_current_password",buttonId:"toggleResetCurrentPassword"},{inputId:"reset_new_password",buttonId:"toggleResetNewPassword"},{inputId:"reset_confirm_password",buttonId:"toggleResetConfirmPassword"}].forEach(e=>{const t=document.getElementById(e.buttonId),s=document.getElementById(e.inputId),a=t.querySelector(".eye-icon"),n=t.querySelector(".eye-slash-icon");t.addEventListener("click",()=>{const e="password"===s.getAttribute("type")?"text":"password";s.setAttribute("type",e),"text"===e?(a.style.display="none",n.style.display="block"):(a.style.display="block",n.style.display="none")})}),document.querySelectorAll(".filter-btn").forEach(e=>{e.addEventListener("click",e=>{this.setFilter(e.target.dataset.filter)})}),document.getElementById("addAlbumBtn").addEventListener("click",()=>{this.showModal()});const l=document.getElementById("viewRecordBtn");l&&l.addEventListener("click",()=>{this.showViewRecordModal()});const i=document.querySelector("#viewRecordModal .close");i&&i.addEventListener("click",()=>{this.hideViewRecordModal()});const r=document.querySelector("#viewRecordModal .btn-cancel");r&&r.addEventListener("click",()=>{this.hideViewRecordModal()});const d=document.getElementById("viewRecordCloseBtn");d&&d.addEventListener("click",()=>{this.hideViewRecordModal()});const c=document.getElementById("editRecordBtn");c&&c.addEventListener("click",()=>{this.enableRecordEditing()});const u=document.getElementById("saveRecordBtn");u&&u.addEventListener("click",()=>{this.saveRecordChanges()});const m=document.getElementById("cancelEditBtn");m&&m.addEventListener("click",()=>{this.cancelRecordEditing()});const h=document.getElementById("clearCacheBtn");h&&h.addEventListener("click",()=>{this.clearAllCaches()}),document.getElementById("albumModal").addEventListener("click",e=>{"albumModal"===e.target.id&&this.hideModal()}),document.getElementById("coverModal").addEventListener("click",e=>{"coverModal"===e.target.id&&this.hideCoverModal()}),document.getElementById("tracklistModal").addEventListener("click",e=>{"tracklistModal"===e.target.id&&this.hideTracklistModal()}),document.getElementById("tracklistEditBtn").addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.handleTracklistEdit()}),document.querySelectorAll(".close").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation();const s=e.closest(".modal");s&&("albumModal"===s.id?this.hideModal():"coverModal"===s.id?this.hideCoverModal():"tracklistModal"===s.id?this.hideTracklistModal():"loginModal"===s.id?this.hideLoginModal():"statsModal"===s.id?this.hideStatsModal():"resetPasswordModal"===s.id?this.hideResetPasswordModal():"setupModal"===s.id?this.hideSetupModal():"viewRecordModal"===s.id&&this.hideViewRecordModal())}),e.addEventListener("touchend",t=>{t.preventDefault(),t.stopPropagation();const s=e.closest(".modal");s&&("albumModal"===s.id?this.hideModal():"coverModal"===s.id?this.hideCoverModal():"tracklistModal"===s.id?this.hideTracklistModal():"loginModal"===s.id?this.hideLoginModal():"statsModal"===s.id?this.hideStatsModal():"resetPasswordModal"===s.id?this.hideResetPasswordModal():"setupModal"===s.id?this.hideSetupModal():"viewRecordModal"===s.id&&this.hideViewRecordModal())})}),document.getElementById("loginModal").addEventListener("click",e=>{"loginModal"===e.target.id&&this.hideLoginModal()}),document.getElementById("loginForm").addEventListener("submit",e=>{e.preventDefault(),this.handleLogin(e)}),document.querySelector("#loginModal .btn-cancel").addEventListener("click",()=>{this.hideLoginModal()}),document.getElementById("statsModal").addEventListener("click",e=>{"statsModal"===e.target.id&&this.hideStatsModal()}),document.querySelector("#statsModal .btn-cancel").addEventListener("click",()=>{this.hideStatsModal()}),document.getElementById("resetPasswordModal").addEventListener("click",e=>{"resetPasswordModal"===e.target.id&&this.hideResetPasswordModal()}),document.getElementById("resetPasswordForm").addEventListener("submit",e=>{e.preventDefault(),this.handleResetPassword(e)}),document.querySelector("#resetPasswordModal .btn-cancel").addEventListener("click",()=>{this.hideResetPasswordModal()}),document.querySelector("#resetPasswordModal .close").addEventListener("click",()=>{this.hideResetPasswordModal()}),document.getElementById("setupModal").addEventListener("click",e=>{"setupModal"===e.target.id&&this.hideSetupModal()}),document.getElementById("setupForm").addEventListener("submit",e=>{e.preventDefault(),this.handleSetupConfig(e)}),document.querySelector("#setupModal .btn-cancel").addEventListener("click",()=>{this.hideSetupModal()}),document.querySelector("#setupModal .close").addEventListener("click",()=>{this.hideSetupModal()}),document.getElementById("setupPasswordBtn").addEventListener("click",()=>{this.hideSetupModal(),this.showResetPasswordModal()}),document.getElementById("albumsTable").addEventListener("click",e=>{if(e.target.classList.contains("album-cover")){const t=e.target.dataset.artist,s=e.target.dataset.album,a=e.target.dataset.year,n=e.target.dataset.cover,o=e.target.closest("tr").dataset.id;this.showCoverModal(t,s,a,n,o)}if(e.target.classList.contains("album-link")){e.preventDefault();const t=e.target.dataset.artist,s=e.target.dataset.album,a=e.target.dataset.year,n=e.target.closest("tr").dataset.id;this.showTracklist(t,s,a,n)}if(e.target.classList.contains("year-link")||e.target.closest(".year-link")){e.preventDefault();const t=(e.target.classList.contains("year-link")?e.target:e.target.closest(".year-link")).dataset.year;t&&this.filterByYear(t)}if(e.target.classList.contains("btn-edit")){const t=e.target.dataset.id;t&&this.editAlbum(parseInt(t))}if(e.target.classList.contains("btn-delete")){const t=e.target.dataset.id;t&&this.deleteAlbum(parseInt(t))}}),document.getElementById("albumForm").addEventListener("submit",e=>{e.preventDefault(),this.saveAlbum()});const y=document.getElementById("releaseYear"),p=document.getElementById("albumFormat");y&&(y.addEventListener("input",()=>{this.updateSaveButtonState()}),y.addEventListener("change",()=>{this.updateSaveButtonState()})),p&&(p.addEventListener("input",()=>{this.updateSaveButtonState()}),p.addEventListener("change",()=>{this.updateSaveButtonState()})),document.getElementById("cancelBtn").addEventListener("click",()=>{this.hideModal()}),document.querySelectorAll(".sortable-header").forEach(e=>{e.addEventListener("click",e=>{const t=e.currentTarget.dataset.sort;this.handleSort(t)})})}setupAutocomplete(){const e=document.getElementById("artistName"),t=document.getElementById("albumName");this.updateAlbumInputState(),e.addEventListener("input",e=>{this.debounceArtistAutocomplete(e.target.value),this.updateAlbumInputState()}),t.addEventListener("input",t=>{const s=e.value.trim();s&&s.length>0?this.debounceAlbumAutocomplete(s,t.target.value):this.hideAutocomplete("albumAutocomplete")}),e.addEventListener("input",e=>{e.target.value.trim()||(this.hideAutocomplete("albumAutocomplete"),t.value="",this.updateAlbumInputState())}),e.addEventListener("blur",e=>{setTimeout(()=>{this.hideAutocomplete("artistAutocomplete")},500)}),t.addEventListener("blur",e=>{setTimeout(()=>{this.hideAutocomplete("albumAutocomplete")},500)}),document.addEventListener("click",e=>{e.target.closest(".autocomplete-container")||(this.hideAutocomplete("artistAutocomplete"),this.hideAutocomplete("albumAutocomplete"))});const s=document.getElementById("formatFilter");s&&s.addEventListener("change",s=>{const a=e.value.trim(),n=t.value.trim();a&&n&&n.length>=2&&this.debounceAlbumAutocomplete(a,n)}),this.setupDropdown()}setupDropdown(){const e=document.querySelector(".dropdown"),t=document.querySelector(".dropdown-menu");e&&t&&(t.addEventListener("click",e=>{e.stopPropagation()}),document.addEventListener("click",t=>{e.contains(t.target)||e.classList.remove("active")}),e.addEventListener("keydown",t=>{"Escape"===t.key&&(e.classList.remove("active"),e.querySelector(".dropdown-toggle").blur())}))}updateAlbumInputState(){const e=document.getElementById("artistName"),t=document.getElementById("albumName");if(e&&t){const s=e.value.trim();s&&s.length>0?(t.disabled=!1,t.placeholder="Enter album name..."):(t.disabled=!0,t.placeholder="Select an artist first...")}this.updateSaveButtonState()}updateSaveButtonState(){const e=document.querySelector("#albumForm .btn-save"),t=document.getElementById("releaseYear"),s=document.getElementById("albumFormat");if(e&&t&&s){const a=""!==t.value.trim(),n=""!==s.value.trim();a&&n?(e.disabled=!1,e.style.opacity="1",e.style.cursor="pointer"):(e.disabled=!0,e.style.opacity="0.5",e.style.cursor="not-allowed")}}debounceArtistAutocomplete(e){clearTimeout(this.artistAutocompleteTimeout),this.artistAutocompleteTimeout=setTimeout(()=>{this.handleArtistAutocomplete(e)},300)}debounceAlbumAutocomplete(e,t){clearTimeout(this.albumAutocompleteTimeout),this.albumAutocompleteTimeout=setTimeout(()=>{this.handleAlbumAutocomplete(e,t)},300)}async handleArtistAutocomplete(e){if(e.length<2)this.hideAutocomplete("artistAutocomplete");else{this.showAutocompleteLoading("artistAutocomplete");try{const t=`api/music_api.php?action=artists&search=${encodeURIComponent(e)}`,s=await this.fetchWithCache(t),a=await s.json();a.success?this.showAutocomplete("artistAutocomplete",a.data,"artist_name"):this.hideAutocomplete("artistAutocomplete")}catch(e){this.hideAutocomplete("artistAutocomplete")}}}async handleAlbumAutocomplete(e,t){if(t.length<2)this.hideAutocomplete("albumAutocomplete");else{this.showAutocompleteLoading("albumAutocomplete");try{const s=document.getElementById("formatFilter")?.value||"";let a=`api/music_api.php?action=albums_by_artist&artist=${encodeURIComponent(e)}&search=${encodeURIComponent(t)}`;s&&(a+=`&format=${encodeURIComponent(s)}`);const n=await this.fetchWithCache(a),o=await n.json();o.success?this.showAutocomplete("albumAutocomplete",o.data,"album_name"):this.hideAutocomplete("albumAutocomplete")}catch(e){this.hideAutocomplete("albumAutocomplete")}}}showAutocomplete(e,t,s){const a=document.getElementById(e);let n=a.querySelector(".autocomplete-list");n||(n=document.querySelector(`[data-original-container="${e}"]`)),n&&(n.innerHTML="",t.forEach(t=>{if(t&&t[s]&&"undefined"!==t[s]){const a=document.createElement("div");a.className="autocomplete-item";const o=document.createElement("span");if("album_name"===s&&t.year?o.textContent=`${t[s]} (${t.year})`:o.textContent=t[s],"album_name"===s&&t.format&&(o.innerHTML=o.textContent+'<br><span class="format-text">'+t.format+"</span>"),a.appendChild(o),t.cover_url){const e=document.createElement("img");e.src=t.cover_url,e.className="autocomplete-cover",e.alt="Album cover",e.onerror=()=>{e.remove()},e.onload=()=>{},a.appendChild(e)}a.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation(),this.selectAutocompleteItem(e,t[s],t)}),n.appendChild(a)}}),n.children.length>0?(n.style.display="block",n.style.visibility="visible",n.style.opacity="1",n.style.zIndex="10000",n.style.position="absolute",n.style.backgroundColor="white",n.style.border="1px solid #ddd",n.style.borderRadius="4px",n.style.boxShadow="0 2px 8px rgba(0,0,0,0.1)",n.style.maxHeight="1200px",n.style.overflowY="auto",this.adjustAutocompletePosition(a,n),setTimeout(()=>{this.adjustAutocompletePosition(a,n)},10)):n.style.display="none")}showAutocompleteLoading(e){let t=document.getElementById(e).querySelector(".autocomplete-list");t||(t=document.querySelector(`[data-original-container="${e}"]`)),t&&(t.innerHTML='<div class="autocomplete-loading">Searching...</div>',t.style.display="block")}hideAutocomplete(e){let t=document.getElementById(e).querySelector(".autocomplete-list");if(t||(t=document.querySelector(`[data-original-container="${e}"]`)),t&&(t.style.display="none",t.style.visibility="hidden",t.style.opacity="0",t.parentNode===document.body&&t.dataset.originalContainer)){const e=document.getElementById(t.dataset.originalContainer);e&&(e.appendChild(t),t.style.position="",t.style.top="",t.style.left="",t.style.width="",t.style.zIndex="",delete t.dataset.originalContainer)}}selectAutocompleteItem(e,t,s=null){const a=document.getElementById(e).querySelector("input");if(a&&(a.value=t,s))if("artistAutocomplete"===e)this.selectedArtist=s;else if("albumAutocomplete"===e){this.selectedAlbum=s,this.selectedDiscogsReleaseId=s.id||null,this.selectedCoverUrl=s.cover_url||null;const e=document.getElementById("releaseYear");e&&(s.master_year?e.value=s.master_year:s.id?(e.value="",this.fetchMasterYearForSelection(s.id,e,s.year)):e.value=s.year||"");const t=document.getElementById("albumFormat");t&&s.format&&(t.value=s.format,t.readOnly=!1),this.updateSaveButtonState()}this.hideAutocomplete(e)}debounceSearch(){clearTimeout(this.autocompleteTimeout),this.autocompleteTimeout=setTimeout(()=>{this.loadAlbums()},300)}setFilter(e){this.currentFilter=e,document.querySelectorAll(".filter-btn").forEach(e=>{e.classList.remove("active")}),document.querySelector(`[data-filter="${e}"]`).classList.add("active"),this.loadAlbums()}filterByStyle(e){this.hideStatsModal(),this.currentStyleFilter=e;const t=this.currentFilter;this.currentFilter="all";const s=document.getElementById("searchInput"),a=document.getElementById("clearSearch");s&&(s.value=`Style: ${e}`,s.disabled=!0,a.classList.add("visible")),this.showMessage(`Filtering by style: ${e}`,"info"),this.loadAlbums(),this.currentFilter=t}filterByFormat(e){this.hideStatsModal(),this.currentFormatFilter=e;const t=this.currentFilter;this.currentFilter="all";const s=document.getElementById("searchInput"),a=document.getElementById("clearSearch");s&&(s.value=`Format: ${e}`,s.disabled=!0,a.classList.add("visible")),this.showMessage(`Filtering by format: ${e}`,"info"),this.loadAlbums(),this.currentFilter=t}clearStyleFilter(){this.currentStyleFilter="",this.currentFormatFilter="",this.currentYearFilter="";const e=document.getElementById("searchInput");e&&(e.value="",e.disabled=!1),this.loadAlbums()}clearFormatFilter(){this.currentFormatFilter="",this.currentStyleFilter="",this.currentYearFilter="";const e=document.getElementById("searchInput");e&&(e.value="",e.disabled=!1),this.loadAlbums()}filterByYear(e){this.hideStatsModal(),this.currentYearFilter=e;const t=this.currentFilter;this.currentFilter="all";const s=document.getElementById("searchInput"),a=document.getElementById("clearSearch");s&&(s.value=`Year: ${e}`,s.disabled=!0,a.classList.add("visible")),this.showMessage(`Filtering by year: ${e}`,"info"),this.loadAlbums(),this.currentFilter=t}clearYearFilter(){this.currentYearFilter="",this.currentStyleFilter="",this.currentFormatFilter="";const e=document.getElementById("searchInput");e&&(e.value="",e.disabled=!1),this.loadAlbums()}handleStyleSearchSuggestions(e){const t=e.toLowerCase();if(t.startsWith("style:")||t.startsWith("genre:")||t.startsWith("type:")){const t=e.replace(/^(style|genre|type):\s*/i,"").trim();if(""===t)this.showMessage('Type a style name after "style:" (e.g., style: rock, style: jazz)',"info");else if(t.length>0){const e=document.getElementById("message");e&&e.classList.contains("info")&&(e.style.display="none")}}}async loadStats(){try{const e=await fetch("api/music_api.php?action=stats"),t=await e.json();t.success&&this.updateStats(t.data)}catch(e){}}updateStats(e){const t=document.querySelector('[data-filter="owned"]'),s=document.querySelector('[data-filter="wanted"]'),a=document.querySelector('[data-filter="all"]');if(t){const s=e.owned_count||0;t.textContent=`${s} Owned`}if(s){const t=e.wanted_count||0;s.textContent=`${t} Want`}if(a){const t=e.total_albums||0;a.textContent=`${t} Total`}const n=document.getElementById("styleStatsList");if(n&&e.style_counts){const t=Object.entries(e.style_counts);if(t.length>0){const e=t;n.innerHTML=e.map(([e,t])=>`\n                  <div class="style-stat-item" data-style="${this.escapeHtml(e)}">\n                      <span class="style-name">${this.escapeHtml(e)}</span>\n                      <span class="style-count">${t}</span>\n                  </div>\n              `).join(""),n.querySelectorAll(".style-stat-item").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const s=e.dataset.style;this.filterByStyle(s)})})}else n.innerHTML='<p class="no-styles">No style information available</p>'}const o=document.getElementById("formatStatsList");if(o&&e.format_counts){const t=Object.entries(e.format_counts);if(t.length>0){const e=t;o.innerHTML=e.map(([e,t])=>`\n                  <div class="format-stat-item" data-format="${encodeURIComponent(e)}">\n                      <span class="format-name">${this.escapeHtml(e)}</span>\n                      <span class="format-count">${t}</span>\n                  </div>\n              `).join(""),o.querySelectorAll(".format-stat-item").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const s=decodeURIComponent(e.dataset.format);this.filterByFormat(s)})})}else o.innerHTML='<p class="no-formats">No format information available</p>'}const l=document.getElementById("yearStatsList");if(l&&e.year_counts){const t=Object.entries(e.year_counts);t.sort((e,t)=>{const s=t[1]-e[1];return 0!==s?s:t[0]-e[0]}),t.length>0?(l.innerHTML=t.map(([e,t])=>`\n                  <div class="year-stat-item" data-year="${e}">\n                      <span class="year-name">${this.escapeHtml(e)}</span>\n                      <span class="year-count">${t}</span>\n                  </div>\n              `).join(""),l.querySelectorAll(".year-stat-item").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const s=e.dataset.year;this.filterByYear(s)})})):l.innerHTML='<p class="no-years">No year information available</p>'}}updateFilterButtonsWithFilteredCount(e){if(!(this.currentSearch||this.currentStyleFilter||this.currentFormatFilter||this.currentYearFilter))return;const t=e.length,s=e.filter(e=>1==e.is_owned).length,a=e.filter(e=>1==e.want_to_own).length,n=document.querySelector('[data-filter="owned"]'),o=document.querySelector('[data-filter="wanted"]'),l=document.querySelector('[data-filter="all"]');n&&(n.textContent=`${s} Owned`),o&&(o.textContent=`${a} Want`),l&&(l.textContent=`${t} Total`)}async loadAlbums(){this.showLoading();const e=document.querySelector(".table-container");e&&e.classList.add("loading");try{const e=this.currentSearch.toLowerCase(),t=["style:","genre:","type:"].some(t=>e.startsWith(t))?"":this.currentSearch,s=this.currentSearch||this.currentStyleFilter||this.currentFormatFilter||this.currentYearFilter?"all":this.currentFilter,a=new URLSearchParams({action:"albums",filter:s,search:t}),n=await this.fetchWithCache(`api/music_api.php?${a}`),o=await n.json();if(o.success){let e=o.data;if(this.currentStyleFilter&&(e=e.filter(e=>{if(!e.style)return!1;return e.style.split(",").map(e=>e.trim()).includes(this.currentStyleFilter)})),this.currentFormatFilter&&(e=e.filter(e=>{if(!e.format)return!1;return e.format.split(",").map(e=>e.trim()).some(e=>e.replace(/\\"/g,'"')===this.currentFormatFilter)})),this.currentYearFilter&&(e=e.filter(e=>e.release_year==this.currentYearFilter)),this.currentSearch&&!this.currentStyleFilter){const t=this.currentSearch.toLowerCase();if(["style:","genre:","type:"].some(e=>t.startsWith(e))){const t=this.currentSearch.replace(/^(style|genre|type):\s*/i,"").trim();t&&(e=e.filter(e=>{if(!e.style)return!1;const s=e.style.toLowerCase(),a=t.toLowerCase();return s.split(",").map(e=>e.trim().toLowerCase()).some(e=>e.includes(a))}))}}this.updateFilterButtonsWithFilteredCount(e),"all"!==this.currentFilter&&(e=e.filter(e=>"owned"===this.currentFilter?1==e.is_owned:"wanted"!==this.currentFilter||1==e.want_to_own));try{const t=this.sortAlbums(e);this.renderAlbums(t)}catch(t){console.error("Sorting error:",t),this.renderAlbums(e)}}else this.showMessage("Error loading albums: "+o.message,"error")}catch(e){this.showMessage("Error loading albums","error")}finally{this.hideLoading(),e&&e.classList.remove("loading")}}renderAlbums(e){const t=document.querySelector("#albumsTable tbody");0!==e.length?(t.innerHTML=e.map(e=>`\n          <tr data-id="${e.id}" data-artist-type="${e.artist_type||""}">\n              <td class="cover-cell">\n                  ${e.cover_url?`<img data-src="${e.cover_url}" data-medium="${e.cover_url_medium||e.cover_url}" data-large="${e.cover_url_large||e.cover_url}" class="album-cover lazy" alt="Album cover" data-artist="${this.escapeHtml(e.artist_name)}" data-album="${this.escapeHtml(e.album_name)}" data-year="${e.release_year||""}" data-cover="${e.cover_url_large||e.cover_url}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" onload="this.classList.add('loaded')" width="60" height="60">\n                       <div class="no-cover" style="display: none;">No Cover</div>`:'<div class="no-cover">No Cover</div>'}\n                  <div class="mobile-status">\n                      ${e.is_owned?'<span class="status-owned">Own</span>':""}\n                      ${e.want_to_own?'<span class="status-wanted">Want</span>':""}\n                      ${e.is_owned||e.want_to_own?"":'<span class="status-none">-</span>'}\n                  </div>\n              </td>\n              <td>\n                  <div class="album-info">\n                      <div class="artist-name">${this.escapeHtml(e.artist_name)}</div>\n                      <div class="album-name">\n                          <a href="#" class="album-link" data-artist="${this.escapeHtml(e.artist_name)}" data-album="${this.escapeHtml(e.album_name)}" data-year="${e.release_year||""}">\n                              ${this.escapeHtml(e.album_name)}\n                          </a>\n                      </div>\n                      <div class="mobile-year">${e.release_year?`<button type="button" class="year-link" data-year="${e.release_year}"><span class="year-badge">${e.release_year}</span></button>`:'<span class="year-badge">-</span>'}</div>\n                      <div class="mobile-actions">\n                          <button class="btn-edit" data-id="${e.id}">\n                              <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="Edit" style="vertical-align: text-top;">\n                                <title>edit</title>\n                                <path d="M4 20h4l10.5-10.5a2 2 0 0 0 0-2.8l-1.2-1.2a2 2 0 0 0-2.8 0L4 16v4z" />\n                                <path d="M13.5 6.5l4 4" />\n                              </svg>\n                              Edit\n                          </button>\n                          <button class="btn-delete" data-id="${e.id}">\n                              &times; \n                              Delete\n                          </button>\n                      </div>\n                  </div>\n              </td>\n              <td>\n                  ${e.release_year?`<button type="button" class="year-link" data-year="${e.release_year}"><span class="year-badge">${e.release_year}</span></button>`:'<span class="year-badge">-</span>'}\n              </td>\n              <td>\n                  ${e.is_owned?'<span class="checkmark">✓</span>':'<span class="checkmark">&nbsp;</span>'}\n              </td>\n              <td>\n                  ${e.want_to_own?'<span class="checkmark">✓</span>':'<span class="checkmark">&nbsp;</span>'}\n              </td>\n              <td>\n                  <div class="action-buttons">\n                      <button class="btn-edit" data-id="${e.id}">\n                          <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="Edit" style="vertical-align: text-top;">\n                            <title>edit</title>\n                            <path d="M4 20h4l10.5-10.5a2 2 0 0 0 0-2.8l-1.2-1.2a2 2 0 0 0-2.8 0L4 16v4z" />\n                            <path d="M13.5 6.5l4 4" />\n                          </svg>\n                          Edit\n                      </button>\n                      <button class="btn-delete" data-id="${e.id}">\n                          &times; \n                          Delete\n                      </button>\n                  </div>\n              </td>\n          </tr>\n      `).join(""),this.initLazyLoading(),this.updateAuthUI()):t.innerHTML='\n              <tr>\n                  <td colspan="6" class="empty-state">\n                      <h3>No albums found</h3>\n                      <p>Try adjusting your search or filter criteria</p>\n                  </td>\n              </tr>\n          '}async fetchMasterYearForSelection(e,t,s=null){try{const a=await this.fetchWithCache(`api/music_api.php?action=master_year&release_id=${e}`),n=await a.json();n.success&&n.data&&n.data.master_year?t&&(t.value=n.data.master_year):s&&t&&(t.value=s)}catch(e){s&&t&&(t.value=s)}this.updateSaveButtonState()}async editAlbum(e){try{const t=await this.fetchWithCache(`api/music_api.php?action=album&id=${e}`),s=await t.json();s.success?(this.editingAlbum=s.data,this.showModal(s.data)):this.showMessage("Error loading album: "+s.message,"error")}catch(e){this.showMessage("Error loading album","error")}}async deleteAlbum(e){if(this.isAuthenticated){if(confirm("Are you sure you want to delete this album?"))try{const t=new AbortController,s=setTimeout(()=>t.abort(),1e4),a=await fetch("api/music_api.php?action=delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e}),signal:t.signal});clearTimeout(s);const n=await a.json();n.success?(this.showMessage("Album deleted successfully","success"),this.loadAlbums(),this.loadStats()):n.auth_required?this.showLoginModal():this.showMessage("Error deleting album: "+n.message,"error")}catch(e){"AbortError"===e.name?this.showMessage("Delete request timed out. Please try again.","error"):this.showMessage("Error deleting album","error")}}else this.showLoginModal()}showModal(e=null){const t=document.getElementById("albumModal"),s=document.getElementById("albumForm"),a=document.querySelector("#albumModal h2"),n=document.getElementById("viewRecordBtn");if(s.reset(),this.hideModalMessage(),e){a.textContent="Edit Album",document.getElementById("artistName").value=e.artist_name,document.getElementById("albumName").value=e.album_name,document.getElementById("releaseYear").value=e.release_year||"";const t=document.getElementById("albumFormat");t.value=e.format||"",t.readOnly=!1,this.selectedCoverUrl=e.cover_url||null,this.selectedDiscogsReleaseId=e.discogs_release_id||null,1==e.is_owned?document.getElementById("isOwned").checked=!0:1==e.want_to_own&&(document.getElementById("wantToOwn").checked=!0);const s=document.getElementById("albumName");s.disabled=!1,s.placeholder="Enter album name...",n.style.display="block",this.editingAlbum=e,this.updateSaveButtonState()}else{a.textContent="Add New Album",this.editingAlbum=null,n.style.display="none",this.selectedCoverUrl=null,this.selectedDiscogsReleaseId=null;const e=document.getElementById("albumFormat");e.value="",e.readOnly=!0,this.updateAlbumInputState()}t.style.display="block",this.updateSaveButtonState(),document.getElementById("artistName").focus()}hideModal(){document.getElementById("albumModal").style.display="none",this.editingAlbum=null,this.selectedCoverUrl=null,this.selectedDiscogsReleaseId=null,this.hideModalMessage()}async showViewRecordModal(){if(!this.editingAlbum)return;const e=document.getElementById("viewRecordModal"),t=document.getElementById("recordData");try{const e=await this.fetchWithCache(`api/music_api.php?action=album&id=${this.editingAlbum.id}`),s=await e.json();if(s.success&&s.data){this.originalAlbumData=s.data;const e=JSON.stringify(s.data,null,2);t.textContent=e}else t.textContent="Error loading album data: "+(s.message||"Unknown error")}catch(e){t.textContent="Error loading album data: "+e.message}e.style.display="block"}hideViewRecordModal(){document.getElementById("viewRecordModal").style.display="none",this.cancelRecordEditing(),this.hideModal()}enableRecordEditing(){const e=document.getElementById("recordData"),t=document.getElementById("editRecordBtn"),s=document.getElementById("saveRecordBtn"),a=document.getElementById("cancelEditBtn"),n=document.getElementById("editWarning"),o=document.getElementById("editError");this.originalRecordData=e.textContent,this.createProtectedJsonEditor(),t.style.display="none",s.style.display="block",a.style.display="block",n.style.display="block",o.style.display="none"}cancelRecordEditing(){const e=document.getElementById("recordData"),t=document.getElementById("editRecordBtn"),s=document.getElementById("saveRecordBtn"),a=document.getElementById("cancelEditBtn"),n=document.getElementById("editWarning"),o=document.getElementById("editError");this.originalRecordData&&(e.textContent=this.originalRecordData),e.contentEditable=!1,t.style.display="block",s.style.display="none",a.style.display="none",n.style.display="none",o.style.display="none",this.originalRecordData=null,this.originalAlbumData=null}createProtectedJsonEditor(){const e=document.getElementById("recordData"),t=this.originalAlbumData;if(!t)return;e.innerHTML="",e.contentEditable=!1;const s=document.createElement("div");s.className="protected-json-editor",s.style.fontFamily="monospace",s.style.whiteSpace="pre",s.style.lineHeight="1.4";Object.entries(t).forEach(([e,a],n)=>{"  ".repeat(1);const o=n===Object.keys(t).length-1,l=document.createElement("span");l.textContent=`"${e}":`,l.style.color="#0066cc",l.style.fontWeight="bold",l.contentEditable=!1;const i=document.createElement("span");i.textContent="string"==typeof a?`"${a}"`:a,"id"===e?(i.contentEditable=!1,i.style.color="#6c757d",i.style.fontStyle="italic",i.style.backgroundColor="#f8f9fa",i.style.padding="2px 4px",i.style.borderRadius="3px",i.style.border="1px solid #dee2e6"):(i.contentEditable=!0,i.style.outline="none",i.style.border="1px solid transparent",i.style.borderRadius="2px",i.style.padding="2px 4px",i.style.backgroundColor="#ffffff",i.style.color="#212529",i.style.fontWeight="500"),i.dataset.key=e,i.dataset.originalValue=a,"id"!==e&&(i.addEventListener("mouseenter",()=>{i.style.backgroundColor="#e3f2fd",i.style.borderColor="#007bff"}),i.addEventListener("mouseleave",()=>{i.style.backgroundColor="#ffffff",i.style.borderColor="transparent"}),i.addEventListener("focus",()=>{i.style.backgroundColor="#e3f2fd",i.style.borderColor="#007bff",i.style.boxShadow="0 0 0 2px rgba(0, 123, 255, 0.25)"}),i.addEventListener("blur",()=>{i.style.backgroundColor="#ffffff",i.style.borderColor="transparent",i.style.boxShadow="none"}));const r=document.createElement("div");if(r.style.marginLeft="20px",r.appendChild(l),r.appendChild(i),!o){const e=document.createElement("span");e.textContent=",",r.appendChild(e)}s.appendChild(r)}),e.appendChild(s);const a=e.querySelector('[contenteditable="true"]');a&&a.focus()}collectDataFromProtectedEditor(){const e=document.getElementById("recordData"),t={...this.originalAlbumData};return e.querySelectorAll('[contenteditable="true"]').forEach(e=>{const s=e.dataset.key,a=e.dataset.originalValue;let n=e.textContent.trim();"string"==typeof a?(n.startsWith('"')&&n.endsWith('"')&&(n=n.slice(1,-1)),t[s]=n):t[s]="number"==typeof a?parseFloat(n)||a:"boolean"==typeof a?"true"===n.toLowerCase():null===a&&"null"===n?null:n}),t}async saveRecordChanges(){const e=document.getElementById("recordData"),t=document.getElementById("editRecordBtn"),s=document.getElementById("saveRecordBtn"),a=document.getElementById("cancelEditBtn");try{const n=this.collectDataFromProtectedEditor();if(!n.artist_name||!n.album_name)throw new Error("Artist name and album name are required");if(n.id!==this.editingAlbum.id)throw new Error("Cannot change the album ID. This field is protected to prevent data conflicts.");const o=await fetch("api/music_api.php?action=update_raw",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),l=await o.json();if(!l.success)throw new Error(l.message||"Failed to update record");this.editingAlbum=n,e.textContent=JSON.stringify(n,null,2),e.contentEditable=!1,t.style.display="block",s.style.display="none",a.style.display="none";document.getElementById("editWarning").style.display="none",this.originalRecordData=null,this.showMessage("Record updated successfully","success"),this.loadAlbums(),this.hideViewRecordModal()}catch(t){const s=document.getElementById("editError");s.innerHTML=`<strong>❌ Error:</strong> ${t.message}`,s.style.display="block",this.originalRecordData&&(e.textContent=this.originalRecordData)}}hideModalMessage(){const e=document.getElementById("modalMessage");e.style.display="none",e.textContent="",e.className="modal-message"}async saveAlbum(){if(!this.isAuthenticated)return void this.showLoginModal();const e=document.getElementById("albumForm"),t=new FormData(e),s=t.get("albumStatus");if(!s)return void this.showModalMessage('Please select either "I own this album" or "I want to own this album"',"error");const a={artist_name:t.get("artistName"),album_name:t.get("albumName"),release_year:t.get("releaseYear"),format:t.get("albumFormat"),is_owned:"owned"===s,want_to_own:"wanted"===s,cover_url:this.selectedCoverUrl||null,discogs_release_id:this.selectedDiscogsReleaseId||null},n=this.editingAlbum?"update":"add";this.editingAlbum&&(a.id=this.editingAlbum.id);try{const e=await fetch(`api/music_api.php?action=${n}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);const t=await e.text();if(!t.trim())throw new Error("Empty response from server");let s;try{s=JSON.parse(t)}catch(e){throw new Error(`Invalid JSON response: ${e.message}`)}s.success?(this.hideModal(),this.showMessage(s.message,"success"),this.loadAlbums(),this.loadStats(),this.editingAlbum=null):s.auth_required?this.showLoginModal():this.showModalMessage(s.message||"Unknown error occurred","error")}catch(e){this.showModalMessage("Network error: "+e.message,"error")}}showLoading(){document.getElementById("loading").style.display="block"}hideLoading(){document.getElementById("loading").style.display="none"}showModalMessage(e,t){const s=document.getElementById("modalMessage");s.textContent=e,s.className=`modal-message ${t}`,s.style.display="block",setTimeout(()=>{s.style.display="none"},5e3)}showMessage(e,t){const s=document.getElementById("message");s.textContent=e,s.className=`message ${t}`,s.style.display="block",setTimeout(()=>{s.style.display="none"},5e3)}async showCoverModal(e,t,s,a,n=null){const o=document.getElementById("coverModal"),l=document.getElementById("coverModalImage"),i=document.getElementById("coverModalInfo");l.src=a,l.alt=`${t} by ${e}`,i.innerHTML=`\n          <div class="artist-name">${this.escapeHtml(e)}</div>\n          <div class="album-name"><a href="javascript:void(0)" class="album-link" data-artist="${this.escapeHtml(e)}" data-album="${this.escapeHtml(t)}" data-year="${s||""}" data-album-id="${n||""}">${this.escapeHtml(t)}</a></div>\n          ${s?`<div class="album-year">${s}</div>`:""}\n      `;const r=i.querySelector(".album-link");if(r&&r.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();const t=r.dataset.artist,s=r.dataset.album,a=r.dataset.year,n=r.dataset.albumId;this.showTracklist(t,s,a,n),this.hideCoverModal()}),o.style.display="block",n)try{const a=new URLSearchParams({artist:e,album:t});s&&a.append("year",s),a.append("album_id",n);const o=await this.fetchWithCache(`api/tracklist_api.php?${a}`),l=await o.json();if(l.success&&l.data&&l.data.master_year){const e=i.querySelector(".album-year");e&&(e.textContent=l.data.master_year)}}catch(e){}}hideCoverModal(){document.getElementById("coverModal").style.display="none"}async showTracklist(e,t,s,a=null){const n=document.getElementById("tracklistModal"),o=document.getElementById("tracklistModalTitle"),l=document.getElementById("tracklistModalInfo"),i=document.getElementById("tracklistModalTracks"),r=document.getElementById("tracklistModalDiscogsLink"),d=document.getElementById("tracklistModalCover"),c=document.getElementById("tracklistModalNoCover");o.textContent=`${t}`,l.innerHTML=`\n          <div><strong>Artist:</strong> ${e}</div>\n          ${s?`<div><strong>Year:</strong> ${s}</div>`:""}\n      `,d.style.display="none",c.style.display="none",c.textContent="";let u=null;if(a){const e=document.querySelector(`tr[data-id="${a}"]`);if(e){const t=e.querySelector(".album-cover");t&&t.src&&t.src!==window.location.href&&(u=t.src)}}u&&(d.src=u,d.style.display="block",c.style.display="none",d.classList.add("loaded")),i.innerHTML='<div class="tracklist-loading">Loading tracklist...</div>',n.style.display="block";const m=document.getElementById("tracklistEditBtn");m&&(this.isAuthenticated&&a?(m.style.display="flex",m.dataset.albumId=a,m.dataset.artistName=e,m.dataset.albumName=t,m.dataset.releaseYear=s||""):m.style.display="none");try{const n=new URLSearchParams({artist:e,album:t});s&&n.append("year",s),a&&n.append("album_id",a);const o=await fetch(`api/tracklist_api.php?${n}`,{cache:"no-cache",headers:{"Content-Type":"application/json"}}),m=await o.json();if(m.success&&m.data){const e=m.data;let t="";if(e.released)try{let s=e.released,a=!1;s.match(/^\d{4}-\d{2}-00$/)&&(a=!0,s=s.replace("-00","-01"));const n=s.split("-"),o=parseInt(n[0]),l=parseInt(n[1])-1,i=parseInt(n[2]),r=new Date(o,l,i);if(isNaN(r.getTime()))t=e.released;else{const e=r.getMonth(),s=r.getDate();t=a||11===e&&31===s?o.toString():r.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}}catch(s){t=e.released}let s="";if(e.rating_count){const t=1===e.rating_count?"review":"reviews";s=e.has_reviews_with_content?`<div class="rating-count">(based on <a href="${e.discogs_url}#release-reviews" target="_blank" rel="noopener noreferrer" style="padding-left: .25em;">${e.rating_count} ${t}</a>)</div>`:`<div class="rating-count">(based on ${e.rating_count} ${t})</div>`}const a=e=>e?e.replace(/\s*\(\d+\)\s*$/,""):e;if(l.innerHTML=`\n                  <div><strong>Artist:</strong> <span>${a(e.artist)}</span></div>\n                  ${t?`<div><strong>Year:</strong> <span>${t}</span></div>`:""}\n                  ${e.label?`<div><strong>Label:</strong> <span>${a(e.label)}</span></div>`:""}\n                  ${e.year?`<div><strong>Released:</strong> <span>${e.year}</span></div>`:""}\n                  ${e.format?`<div><strong>Format:</strong> <span>${e.format}</span></div>`:""}\n                  ${e.producer?`<div><strong>Producer:</strong> <span>${a(e.producer)}</span></div>`:""}\n                  ${e.rating?`<div><strong>Rating:</strong> <span class="rating-value">${e.rating}${this.generateStarRating(e.rating)}</span>${s}</div>`:""}\n              `,!u&&e.cover_url){const t=e.cover_url_medium||e.cover_url;t.includes("api/image_proxy.php")?(d.style.display="none",c.style.display="none",c.textContent=""):(c.textContent="Loading Cover...",c.style.display="flex",d.style.display="none"),d.src=t;const s=setTimeout(()=>{"none"===d.style.display&&(d.style.display="none",c.textContent="No Cover",c.style.display="flex")},1e4);d.onload=function(){clearTimeout(s),d.style.display="block",c.style.display="none",d.classList.add("loaded")},d.onerror=function(){clearTimeout(s),d.style.display="none",c.textContent="No Cover",c.style.display="flex"}}else u||e.cover_url||(d.style.display="none",c.textContent="No Cover",c.style.display="flex");if(r.href=e.discogs_url,e.matched_reason){const t=document.createElement("div");t.className="tracklist-match-info",t.innerHTML=`<small>Matched: ${e.matched_reason}</small>`,i.appendChild(t)}e.tracklist&&e.tracklist.length>0?i.innerHTML=`\n                      <div class="tracklist-modal-tracks">\n                          ${e.tracklist.map(e=>`\n                              <div class="track-item">\n                                  <span class="track-position">${e.position}</span>\n                                  <span class="track-title">${this.escapeHtml(e.title)}</span>\n                                  <span class="track-duration">${e.duration||""}</span>\n                              </div>\n                          `).join("")}\n                      </div>\n                  `:i.innerHTML='<div class="tracklist-error">No tracklist available for this album</div>'}else{let s="Could not load tracklist";m.message&&!m.message.includes("Discogs API request failed")&&(s=m.message),i.innerHTML=`<div class="tracklist-error">${s}</div>`,r.href=`https://www.discogs.com/search/?q=${encodeURIComponent(e+" "+t)}&type=release`}}catch(s){i.innerHTML='<div class="tracklist-error">Could not load tracklist. Please try again later.</div>',r.href=`https://www.discogs.com/search/?q=${encodeURIComponent(e+" "+t)}&type=release`}}hideTracklistModal(){document.getElementById("tracklistModal").style.display="none"}handleTracklistEdit(){const e=document.getElementById("tracklistEditBtn");if(!e||!e.dataset.albumId)return;const t=e.dataset.albumId;this.hideTracklistModal(),this.editAlbum(parseInt(t))}showLoginModal(){document.getElementById("loginModal").style.display="block",document.getElementById("password").focus(),document.getElementById("loginMessage").style.display="none"}showStatsModal(){document.getElementById("statsModal").style.display="block"}hideStatsModal(){document.getElementById("statsModal").style.display="none"}showResetPasswordModal(){this.isAuthenticated?(document.getElementById("resetPasswordMessage").style.display="none",document.getElementById("resetPasswordForm").reset(),document.getElementById("resetPasswordModal").style.display="block",document.getElementById("reset_current_password").focus()):this.showLoginModal()}hideResetPasswordModal(){document.getElementById("resetPasswordModal").style.display="none",document.getElementById("resetPasswordForm").reset(),document.getElementById("resetPasswordMessage").style.display="none"}async handleResetPassword(e){e.preventDefault();const t=document.getElementById("reset_current_password").value,s=document.getElementById("reset_new_password").value,a=document.getElementById("reset_confirm_password").value,n=document.getElementById("resetPasswordMessage");try{const e=await fetch("api/music_api.php?action=reset_password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({current_password:t,new_password:s,confirm_password:a})}),o=await e.json();o.success?(n.textContent=o.message,n.className="modal-message success",n.style.display="block",document.getElementById("resetPasswordForm").reset(),setTimeout(()=>{this.hideResetPasswordModal()},3e3)):(n.textContent=o.message,n.className="modal-message error",n.style.display="block")}catch(e){n.textContent="Network error. Please try again.",n.className="modal-message error",n.style.display="block"}}showSetupModal(){this.isAuthenticated?(this.loadSetupStatus(),document.getElementById("setupMessage").style.display="none",document.getElementById("setupForm").reset(),document.getElementById("setupModal").style.display="block",this.setupThemeCustomization(),document.getElementById("setup_discogs_api_key").focus()):this.showLoginModal()}hideSetupModal(){document.getElementById("setupModal").style.display="none",document.getElementById("setupForm").reset(),document.getElementById("setupMessage").style.display="none"}async loadSetupStatus(){try{const e=await fetch("api/music_api.php?action=get_setup_status"),t=await e.json();if(t.success){const e=t.data,s=document.getElementById("apiKeyStatus"),a=document.getElementById("currentApiKeyDisplay"),n=document.getElementById("currentApiKeyText");e.api_key_set?(s.textContent="✅ Set",s.className="status-value set",a.style.display="block",n.textContent=e.current_api_key):(s.textContent="❌ Not set",s.className="status-value not-set",a.style.display="none");document.getElementById("passwordActionText").textContent="Change Password";const o=document.getElementById("overallStatus");e.api_key_set?(o.textContent="✅ Complete",o.className="status-value set"):(o.textContent="⚠️ Incomplete",o.className="status-value not-set")}}catch(e){console.error("Error loading setup status:",e)}}async handleSetupConfig(e){e.preventDefault();const t=document.getElementById("setup_discogs_api_key").value,s=document.getElementById("setupMessage");try{const e=await fetch("api/music_api.php?action=setup_config",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({discogs_api_key:t})}),a=await e.json();a.success?(s.textContent=a.message,s.className="modal-message success",s.style.display="block",document.getElementById("setupForm").reset(),this.loadSetupStatus(),setTimeout(()=>{this.hideSetupModal()},3e3)):(s.textContent=a.message,s.className="modal-message error",s.style.display="block")}catch(e){s.textContent="Network error. Please try again.",s.className="modal-message error",s.style.display="block"}}hideLoginModal(){const e=document.getElementById("loginModal");e&&(e.style.display="none"),document.getElementById("password").value="";const t=document.getElementById("loginMessage");t&&(t.style.display="none")}async handleLogin(e){e.preventDefault();const t=document.getElementById("password").value,s=document.getElementById("loginMessage");if(!t)return s.textContent="Please enter a password.",s.className="modal-message error",void(s.style.display="block");try{const e=new AbortController,a=setTimeout(()=>e.abort(),1e4),n=await fetch("api/music_api.php?action=login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:t}),signal:e.signal});clearTimeout(a);const o=await n.json();o.success?(await this.checkAuthStatus(),this.hideLoginModal(),this.showMessage("Login successful","success")):(s.textContent=o.message,s.className="modal-message error",s.style.display="block")}catch(e){"AbortError"===e.name?s.textContent="Login request timed out. Please try again.":s.textContent="Login failed. Please try again.",s.className="modal-message error",s.style.display="block"}}async handleLogout(){try{const e=await fetch("api/music_api.php?action=logout",{method:"POST",headers:{"Content-Type":"application/json"}});(await e.json()).success&&(await this.checkAuthStatus(),this.showMessage("Logged out successfully","success"))}catch(e){}}initLazyLoading(){if("IntersectionObserver"in window){const e=new IntersectionObserver((e,t)=>{e.forEach(e=>{if(e.isIntersecting){const s=e.target;this.loadOptimizedImage(s,s.dataset.src),s.classList.remove("lazy"),s.classList.add("loaded"),t.unobserve(s)}})},{rootMargin:"50px 0px",threshold:.01});document.querySelectorAll("img.lazy").forEach(t=>{e.observe(t)})}else this.loadLazyImagesFallback()}loadLazyImagesFallback(){const e=document.querySelectorAll("img.lazy"),t=e=>{e.dataset.src&&(this.loadOptimizedImage(e,e.dataset.src),e.classList.remove("lazy"))};e.forEach(e=>{this.isElementInViewport(e)&&t(e)});const s=()=>{e.forEach(e=>{e.classList.contains("lazy")&&this.isElementInViewport(e)&&t(e)})};window.addEventListener("scroll",s),window.addEventListener("resize",s)}isElementInViewport(e){const t=e.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&t.right<=(window.innerWidth||document.documentElement.clientWidth)}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}decodeHtmlEntities(e){const t=document.createElement("div");return t.innerHTML=e,t.textContent}formatDate(e){if(!e)return"-";return new Date(e).toLocaleDateString()}loadOptimizedImage(e,t,s=null){if(this.isWebPSupported()&&t.includes("discogs.com")&&!t.includes("fm=webp")){const a=t.includes("?")?t+"&fm=webp":t+"?fm=webp";e.src=a,e.onerror=()=>{e.src=t,s&&(e.onerror=()=>{e.src=s})}}else e.src=t,s&&(e.onerror=()=>{e.src=s})}isWebPSupported(){const e=document.createElement("canvas");return e.width=1,e.height=1,0===e.toDataURL("image/webp").indexOf("data:image/webp")}generateStarRating(e){const t=Math.floor(e),s=e%1;let a="";s>=.875?a="filled":s>=.625?a="three-quarter":s>=.375?a="half":s>=.125&&(a="quarter");const n=5-(t+(a?1:0));let o='<span class="stars">';for(let e=0;e<t;e++)o+='<span class="star filled">★</span>';a&&"filled"!==a?o+=`<span class="star ${a}">★</span>`:"filled"===a&&(o+='<span class="star filled">★</span>');for(let e=0;e<n;e++)o+='<span class="star empty">☆</span>';return o+="</span>",o}adjustAutocompletePosition(e,t){const s=e.closest(".modal");if(!s)return;const a=s.querySelector(".modal-content"),n=e.getBoundingClientRect(),o=a.getBoundingClientRect();t.style.top="100%",t.style.bottom="auto",t.style.maxHeight="1200px";const l=o.bottom-n.bottom-20,i=n.top-o.top-20,r=Math.min(t.scrollHeight,1200);l<200&&i>l+100?(t.style.top="auto",t.style.bottom="100%",t.style.maxHeight=`${Math.min(i-20,1200)}px`,t.style.overflowY="auto",t.style.overflowX="hidden"):(t.style.top="100%",t.style.bottom="auto",t.style.maxHeight=l<r?`${Math.max(l-20,300)}px`:`${Math.min(l-20,1200)}px`,t.style.overflowY="auto",t.style.overflowX="hidden");const d=t.offsetWidth,c=e.offsetWidth;d>c&&(t.style.width=`${c}px`),t.style.zIndex="10000",t.style.visibility="visible",t.style.opacity="1"}moveAutocompleteToBody(e,t){if(e.closest(".modal")&&t.parentNode!==document.body){document.body.appendChild(t);const s=e.getBoundingClientRect();t.style.position="fixed",t.style.top=s.bottom+window.scrollY+"px",t.style.left=s.left+"px",t.style.width=s.width+"px",t.style.zIndex="10000",t.style.backgroundColor="white",t.style.border="1px solid #ddd",t.style.borderRadius="4px",t.style.boxShadow="0 2px 8px rgba(0,0,0,0.1)",t.style.display="block",t.style.visibility="visible",t.style.opacity="1",t.dataset.originalContainer=e.id}}setupThemeCustomization(){this.loadThemeColors();const e=document.getElementById("gradientColor1"),t=document.getElementById("gradientColor2"),s=document.getElementById("gradientColor1Hex"),a=document.getElementById("gradientColor2Hex"),n=document.getElementById("resetThemeBtn"),o=document.getElementById("saveThemeBtn");e&&e.addEventListener("change",e=>{s.value=e.target.value,this.previewTheme()}),t&&t.addEventListener("change",e=>{a.value=e.target.value,this.previewTheme()}),s&&s.addEventListener("input",t=>{const s=t.target.value;this.isValidHexColor(s)&&(e.value=s,this.previewTheme())}),a&&a.addEventListener("input",e=>{const s=e.target.value;this.isValidHexColor(s)&&(t.value=s,this.previewTheme())}),n&&n.addEventListener("click",()=>{this.resetTheme()}),o&&o.addEventListener("click",()=>{this.saveThemeColors(),this.showThemeMessage("Theme colors saved successfully!","success")})}async loadThemeColors(){try{const e=await fetch("api/theme_api.php"),t=await e.json();if(t.success){const e=t.data.gradient_color_1,s=t.data.gradient_color_2,a=localStorage.getItem("gradientColor1"),n=localStorage.getItem("gradientColor2");a&&n&&(a!==e||n!==s)&&(console.log("localStorage colors differ from server, updating localStorage"),localStorage.setItem("gradientColor1",e),localStorage.setItem("gradientColor2",s)),this.updateColorPickerInputs(e,s),this.applyThemeColors(e,s)}else console.warn("Server theme load failed:",t.message),this.fallbackToLocalStorage()}catch(e){console.warn("Server theme load error:",e),this.fallbackToLocalStorage()}}fallbackToLocalStorage(){const e=localStorage.getItem("gradientColor1")||"#667eea",t=localStorage.getItem("gradientColor2")||"#764ba2";console.log("Falling back to localStorage:",e,t),this.updateColorPickerInputs(e,t),this.applyThemeColors(e,t)}updateColorPickerInputs(e,t){const s=document.getElementById("gradientColor1"),a=document.getElementById("gradientColor1Hex"),n=document.getElementById("gradientColor2"),o=document.getElementById("gradientColor2Hex");s&&a&&n&&o&&(s.value=e,a.value=e,n.value=t,o.value=t)}async saveThemeColors(){const e=document.getElementById("gradientColor1").value,t=document.getElementById("gradientColor2").value;localStorage.setItem("gradientColor1",e),localStorage.setItem("gradientColor2",t),this.applyThemeColors(e,t);try{const s=await fetch("api/theme_api.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({gradient_color_1:e,gradient_color_2:t})}),a=await s.json();a.success||console.warn("Failed to save theme to server:",a.message)}catch(e){console.warn("Failed to save theme to server:",e)}}applyThemeColors(e,t){document.body.style.background=`linear-gradient(135deg, ${e} 0%, ${t} 100%)`}previewTheme(){const e=document.getElementById("gradientColor1").value,t=document.getElementById("gradientColor2").value;this.applyThemeColors(e,t)}resetTheme(){const e="#667eea",t="#764ba2",s=document.getElementById("gradientColor1"),a=document.getElementById("gradientColor1Hex"),n=document.getElementById("gradientColor2"),o=document.getElementById("gradientColor2Hex");s&&a&&n&&o&&(s.value=e,a.value=e,n.value=t,o.value=t,this.applyThemeColors(e,t),this.saveThemeColors())}isValidHexColor(e){return/^#[0-9A-Fa-f]{6}$/.test(e)}showSetupMessage(e,t){const s=document.getElementById("setupMessage");s&&(s.textContent=e,s.className=`modal-message ${t}`,s.style.display="block",setTimeout(()=>{s.style.display="none"},3e3))}showThemeMessage(e,t){const s=document.getElementById("themeMessage");s&&(s.textContent=e,s.className=`modal-message ${t}`,s.style.display="block",setTimeout(()=>{s.style.display="none"},3e3))}async clearAllCaches(){try{if("caches"in window){const e=await caches.keys();await Promise.all(e.map(e=>caches.delete(e)))}localStorage.clear(),sessionStorage.clear(),this.selectedArtist=null,this.selectedAlbum=null,this.selectedCoverUrl=null,this.selectedDiscogsReleaseId=null;const e=new URL(window.location.href);e.searchParams.set("_cache_clear",Date.now()),e.searchParams.set("cache_cleared","true"),window.location.href=e.toString()}catch(e){console.error("Error clearing caches:",e),this.showMessage("Error clearing caches. Please try again.","error")}}handleSort(e){this.currentSort.field===e?this.currentSort.direction="asc"===this.currentSort.direction?"desc":"asc":(this.currentSort.field=e,this.currentSort.direction="asc"),this.updateSortIndicators(),this.renderAlbumsWithSort()}updateSortIndicators(){document.querySelectorAll(".sortable-header").forEach(e=>{e.classList.remove("sort-asc","sort-desc")});const e=document.querySelector(`[data-sort="${this.currentSort.field}"]`);e&&e.classList.add(`sort-${this.currentSort.direction}`)}renderAlbumsWithSort(){const e=document.querySelector("#albumsTable tbody"),t=Array.from(e.querySelectorAll("tr")).map(e=>{if(e.classList.contains("empty-state"))return null;const t=e.querySelector(".artist-name")?.textContent||"",s=e.querySelector(".album-name a")?.textContent||"",a=e.querySelector(".year-link"),n=a?a.dataset.year:"",o="✓"===e.querySelector("td:nth-child(4) .checkmark")?.textContent,l="✓"===e.querySelector("td:nth-child(5) .checkmark")?.textContent;return{id:e.dataset.id,artist_name:t,album_name:s,release_year:n,is_owned:o?1:0,want_to_own:l?1:0,cover_url:e.querySelector(".album-cover")?.dataset.src||"",cover_url_medium:e.querySelector(".album-cover")?.dataset.medium||"",cover_url_large:e.querySelector(".album-cover")?.dataset.large||"",artist_type:e.dataset.artistType||null}}).filter(e=>null!==e),s=this.sortAlbums(t);this.renderAlbums(s)}sortAlbums(e){return e.sort((e,t)=>{const s=e.artist_type||null,a=t.artist_type||null;if("year"===this.currentSort.field){const n=parseInt(e.release_year)||0,o=parseInt(t.release_year)||0;return"desc"===this.currentSort.direction?n!==o?o-n:this.getSortableArtistName(e.artist_name,s).localeCompare(this.getSortableArtistName(t.artist_name,a)):n!==o?n-o:this.getSortableArtistName(e.artist_name,s).localeCompare(this.getSortableArtistName(t.artist_name,a))}if("album"===this.currentSort.field){const n=this.getSortableArtistName(e.artist_name,s).localeCompare(this.getSortableArtistName(t.artist_name,a));if("desc"===this.currentSort.direction){if(0!==n)return-n;const s=parseInt(e.release_year)||0,a=parseInt(t.release_year)||0;return s!==a?s-a:this.getSortableAlbumName(e.album_name).localeCompare(this.getSortableAlbumName(t.album_name))}{if(0!==n)return n;const s=parseInt(e.release_year)||0,a=parseInt(t.release_year)||0;return s!==a?s-a:this.getSortableAlbumName(e.album_name).localeCompare(this.getSortableAlbumName(t.album_name))}}return this.getSortableArtistName(e.artist_name,s).localeCompare(this.getSortableArtistName(t.artist_name,a))})}getSortableArtistName(e,t=null){if(!e)return"";const s=e.trim(),a=s.toLowerCase();if(a.includes("elvis costello")&&a.includes("attractions"))return"Costello, Elvis & The Attractions";const n=["the ","a ","an "];for(const e of n)if(a.startsWith(e))return s.substring(e.length).trim();if(t){if("group"===t.toLowerCase())return s;if("person"===t.toLowerCase()){const e=s.split(" ");if(2===e.length){const t=e[0],s=e[1];return["jr","sr","ii","iii","iv","v","vi","vii","viii","ix","x"].includes(s.toLowerCase())&&e.length>2?e[e.length-2]+", "+e.slice(0,-2).join(" ")+" "+e[e.length-1]:s+", "+t}return s}}const o=s.split(" "),l=["&","and","featuring","feat","ft","with","vs","versus"].some(e=>a.includes(e)),i=o[o.length-1],r=/^\d+$/.test(i);if(!(l||r||o.length>3)&&2===o.length){const e=o[0],t=o[1];return["jr","sr","ii","iii","iv","v","vi","vii","viii","ix","x"].includes(t.toLowerCase())&&o.length>2?o[o.length-2]+", "+o.slice(0,-2).join(" ")+" "+o[o.length-1]:t+", "+e}return s}getSortableAlbumName(e){if(!e)return"";const t=e.trim(),s=t.toLowerCase(),a=["the ","a ","an "];for(const e of a)if(s.startsWith(e))return t.substring(e.length).trim();return t}}document.addEventListener("DOMContentLoaded",async()=>{window.app=new MusicCollectionApp,await window.app.init()});