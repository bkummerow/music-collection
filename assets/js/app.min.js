class MusicCollectionApp{constructor(){this.currentFilter="owned",this.currentSearch="",this.currentStyleFilter="",this.currentFormatFilter="",this.currentYearFilter="",this.editingAlbum=null,this.autocompleteTimeout=null,this.artistAutocompleteTimeout=null,this.albumAutocompleteTimeout=null,this.isAuthenticated=!1,this.currentSort={field:"artist",direction:"asc"}}async fetchWithCache(e,t={}){const a={cache:"default",headers:{"Content-Type":"application/json",...t.headers}};return fetch(e,{...a,...t})}async init(){this.checkAuthStatus(),this.loadStats(),this.loadAlbums(),this.bindEvents(),this.setupAutocomplete(),await this.loadThemeColors(),this.initDarkMode(),this.updateSortIndicators();const e=new URLSearchParams(window.location.search);if("true"===e.get("cache_cleared")){this.showMessage("All caches cleared successfully. Fresh data loaded.","success"),e.delete("cache_cleared"),e.delete("_cache_clear");const t=window.location.pathname+(e.toString()?"?"+e.toString():"");window.history.replaceState({},"",t)}}async checkAuthStatus(){try{const e=await fetch("api/music_api.php?action=auth_status",{cache:"no-cache",headers:{"Content-Type":"application/json"}}),t=await e.json();t.success&&(this.isAuthenticated=t.data.authenticated)}catch(e){this.isAuthenticated=!1}this.updateAuthUI()}updateAuthUI(){const e=document.getElementById("addAlbumBtn"),t=document.getElementById("loginBtn"),a=document.getElementById("logoutBtn");e&&(this.isAuthenticated?(e.textContent="+ Add Album",e.style.display="block",e.style.opacity="1",e.style.cursor="pointer"):e.style.display="none"),t&&(t.style.display=this.isAuthenticated?"none":"flex"),a&&(a.style.display=this.isAuthenticated?"flex":"none");const s=document.querySelectorAll(".btn-edit"),n=document.querySelectorAll(".btn-delete");s.forEach(e=>{e.style.display=this.isAuthenticated?"inline-block":"none"}),n.forEach(e=>{e.style.display=this.isAuthenticated?"inline-block":"none"});const o=document.querySelector("th:last-child"),l=document.querySelectorAll("td:last-child");o&&(o.style.display=this.isAuthenticated?"table-cell":"none"),l.forEach(e=>{e.style.display=this.isAuthenticated?"table-cell":"none"});const i=document.getElementById("clearCacheBtn");i&&(i.style.display=this.isAuthenticated?"flex":"none");const r=document.getElementById("setupBtn");r&&(r.style.display=this.isAuthenticated?"flex":"none");const d=document.getElementById("resetPasswordBtn");d&&(d.style.display=this.isAuthenticated?"flex":"none")}bindEvents(){const e=document.getElementById("searchInput"),t=document.getElementById("clearSearch");e.addEventListener("input",e=>{this.currentSearch=e.target.value,this.debounceSearch(),e.target.value.length>0?t.classList.add("visible"):t.classList.remove("visible"),this.handleStyleSearchSuggestions(e.target.value)}),t.addEventListener("click",()=>{e.value="",this.currentSearch="",this.currentStyleFilter="",this.currentFormatFilter="",this.currentYearFilter="",this.currentArtistFilter="",e.disabled=!1,this.debounceSearch(),t.classList.remove("visible"),e.focus();const a=document.getElementById("message");a&&a.classList.contains("info")&&(a.style.display="none"),this.loadStats()});const a=document.getElementById("togglePassword"),s=document.getElementById("password"),n=a.querySelector(".eye-icon"),o=a.querySelector(".eye-slash-icon");a.addEventListener("click",()=>{const e="password"===s.getAttribute("type")?"text":"password";s.setAttribute("type",e),"text"===e?(n.style.display="none",o.style.display="block"):(n.style.display="block",o.style.display="none")});[{inputId:"reset_current_password",buttonId:"toggleResetCurrentPassword"},{inputId:"reset_new_password",buttonId:"toggleResetNewPassword"},{inputId:"reset_confirm_password",buttonId:"toggleResetConfirmPassword"}].forEach(e=>{const t=document.getElementById(e.buttonId),a=document.getElementById(e.inputId),s=t.querySelector(".eye-icon"),n=t.querySelector(".eye-slash-icon");t.addEventListener("click",()=>{const e="password"===a.getAttribute("type")?"text":"password";a.setAttribute("type",e),"text"===e?(s.style.display="none",n.style.display="block"):(s.style.display="block",n.style.display="none")})}),document.querySelectorAll(".filter-btn").forEach(e=>{e.addEventListener("click",e=>{this.setFilter(e.target.dataset.filter)})}),document.getElementById("addAlbumBtn").addEventListener("click",()=>{this.showModal()});const l=document.getElementById("viewRecordBtn");l&&l.addEventListener("click",()=>{this.showViewRecordModal()});const i=document.querySelector("#viewRecordModal .close");i&&i.addEventListener("click",()=>{this.hideViewRecordModal()});const r=document.querySelector("#viewRecordModal .btn-cancel");r&&r.addEventListener("click",()=>{this.hideViewRecordModal()});const d=document.getElementById("viewRecordCloseBtn");d&&d.addEventListener("click",()=>{this.hideViewRecordModal()});const c=document.getElementById("editRecordBtn");c&&c.addEventListener("click",()=>{this.enableRecordEditing()});const u=document.getElementById("saveRecordBtn");u&&u.addEventListener("click",()=>{this.saveRecordChanges()});const m=document.getElementById("cancelEditBtn");m&&m.addEventListener("click",()=>{this.cancelRecordEditing()});const h=document.getElementById("clearCacheBtn");h&&h.addEventListener("click",()=>{this.clearAllCaches()}),document.getElementById("albumModal").addEventListener("click",e=>{"albumModal"===e.target.id&&this.hideModal()}),document.getElementById("coverModal").addEventListener("click",e=>{"coverModal"===e.target.id&&this.hideCoverModal()}),document.getElementById("tracklistModal").addEventListener("click",e=>{"tracklistModal"===e.target.id&&this.hideTracklistModal()}),document.getElementById("tracklistModalCover").addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();const t=document.getElementById("tracklistModal"),a=document.getElementById("tracklistModalCover");if(t&&a&&a.src&&a.src!==window.location.href){const e=t.dataset.artistName||"",s=t.dataset.albumName||"",n=t.dataset.releaseYear||"",o=a.src,l=t.dataset.albumId||null;this.hideTracklistModal(),this.showCoverModal(e,s,n,o,l)}}),document.getElementById("tracklistEditBtn").addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.handleTracklistEdit()}),document.querySelectorAll(".close").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation();const a=e.closest(".modal");a&&("albumModal"===a.id?this.hideModal():"coverModal"===a.id?this.hideCoverModal():"tracklistModal"===a.id?this.hideTracklistModal():"loginModal"===a.id?this.hideLoginModal():"statsModal"===a.id?this.hideStatsModal():"resetPasswordModal"===a.id?this.hideResetPasswordModal():"setupModal"===a.id?this.hideSetupModal():"viewRecordModal"===a.id&&this.hideViewRecordModal())}),e.addEventListener("touchend",t=>{t.preventDefault(),t.stopPropagation();const a=e.closest(".modal");a&&("albumModal"===a.id?this.hideModal():"coverModal"===a.id?this.hideCoverModal():"tracklistModal"===a.id?this.hideTracklistModal():"loginModal"===a.id?this.hideLoginModal():"statsModal"===a.id?this.hideStatsModal():"resetPasswordModal"===a.id?this.hideResetPasswordModal():"setupModal"===a.id?this.hideSetupModal():"viewRecordModal"===a.id&&this.hideViewRecordModal())})}),document.getElementById("loginModal").addEventListener("click",e=>{"loginModal"===e.target.id&&this.hideLoginModal()}),document.getElementById("loginForm").addEventListener("submit",e=>{e.preventDefault(),this.handleLogin(e)}),document.querySelector("#loginModal .btn-cancel").addEventListener("click",()=>{this.hideLoginModal()}),document.getElementById("statsModal").addEventListener("click",e=>{"statsModal"===e.target.id&&this.hideStatsModal()}),document.querySelector("#statsModal .btn-cancel").addEventListener("click",()=>{this.hideStatsModal()}),document.getElementById("resetPasswordModal").addEventListener("click",e=>{"resetPasswordModal"===e.target.id&&this.hideResetPasswordModal()}),document.getElementById("resetPasswordForm").addEventListener("submit",e=>{e.preventDefault(),this.handleResetPassword(e)}),document.querySelector("#resetPasswordModal .btn-cancel").addEventListener("click",()=>{this.hideResetPasswordModal()}),document.querySelector("#resetPasswordModal .close").addEventListener("click",()=>{this.hideResetPasswordModal()}),document.getElementById("setupModal").addEventListener("click",e=>{"setupModal"===e.target.id&&this.hideSetupModal()}),document.getElementById("setupForm").addEventListener("submit",e=>{e.preventDefault(),this.handleSetupConfig(e)}),document.querySelector("#setupModal .btn-cancel").addEventListener("click",()=>{this.hideSetupModal()}),document.querySelector("#setupModal .close").addEventListener("click",()=>{this.hideSetupModal()}),document.getElementById("setupPasswordBtn").addEventListener("click",()=>{this.hideSetupModal(),this.showResetPasswordModal()}),document.getElementById("albumsTable").addEventListener("click",e=>{if(e.target.classList.contains("album-cover")){const t=e.target.dataset.artist,a=e.target.dataset.album,s=e.target.dataset.year,n=e.target.dataset.cover,o=e.target.closest("tr").dataset.id;this.showCoverModal(t,a,s,n,o)}if(e.target.classList.contains("album-link")){e.preventDefault();const t=e.target.dataset.artist,a=e.target.dataset.album,s=e.target.dataset.year,n=e.target.closest("tr").dataset.id;this.showTracklist(t,a,s,n)}if(e.target.classList.contains("artist-link")){e.preventDefault();const t=e.target.dataset.artist;t&&this.filterByArtist(t)}if(e.target.classList.contains("year-link")||e.target.closest(".year-link")){e.preventDefault();const t=(e.target.classList.contains("year-link")?e.target:e.target.closest(".year-link")).dataset.year;t&&this.filterByYear(t)}if(e.target.classList.contains("btn-edit")){const t=e.target.dataset.id;t&&this.editAlbum(parseInt(t))}if(e.target.classList.contains("btn-delete")){const t=e.target.dataset.id;t&&this.deleteAlbum(parseInt(t))}}),document.getElementById("albumForm").addEventListener("submit",e=>{e.preventDefault(),this.saveAlbum()});const y=document.getElementById("releaseYear"),p=document.getElementById("albumFormat");y&&(y.addEventListener("input",()=>{this.updateSaveButtonState()}),y.addEventListener("change",()=>{this.updateSaveButtonState()})),p&&(p.addEventListener("input",()=>{this.updateSaveButtonState()}),p.addEventListener("change",()=>{this.updateSaveButtonState()})),document.getElementById("cancelBtn").addEventListener("click",()=>{this.hideModal()}),document.querySelectorAll(".sortable-header").forEach(e=>{e.addEventListener("click",e=>{const t=e.currentTarget.dataset.sort;this.handleSort(t)})})}setupAutocomplete(){const e=document.getElementById("artistName"),t=document.getElementById("albumName");this.updateAlbumInputState(),e.addEventListener("input",e=>{this.debounceArtistAutocomplete(e.target.value),this.updateAlbumInputState()}),t.addEventListener("input",t=>{const a=e.value.trim();a&&a.length>0?this.debounceAlbumAutocomplete(a,t.target.value):this.hideAutocomplete("albumAutocomplete")}),e.addEventListener("input",e=>{e.target.value.trim()||(this.hideAutocomplete("albumAutocomplete"),t.value="",this.updateAlbumInputState())}),e.addEventListener("blur",e=>{setTimeout(()=>{this.hideAutocomplete("artistAutocomplete")},500)}),t.addEventListener("blur",e=>{setTimeout(()=>{this.hideAutocomplete("albumAutocomplete")},500)}),document.addEventListener("click",e=>{e.target.closest(".autocomplete-container")||(this.hideAutocomplete("artistAutocomplete"),this.hideAutocomplete("albumAutocomplete"))});const a=document.getElementById("formatFilter");a&&a.addEventListener("change",a=>{const s=e.value.trim(),n=t.value.trim();s&&n&&n.length>=2&&this.debounceAlbumAutocomplete(s,n)}),this.setupDropdown()}setupDropdown(){const e=document.querySelector(".dropdown"),t=document.querySelector(".dropdown-menu");e&&t&&(t.addEventListener("click",e=>{e.stopPropagation()}),document.addEventListener("click",t=>{e.contains(t.target)||e.classList.remove("active")}),e.addEventListener("keydown",t=>{"Escape"===t.key&&(e.classList.remove("active"),e.querySelector(".dropdown-toggle").blur())}))}updateAlbumInputState(){const e=document.getElementById("artistName"),t=document.getElementById("albumName");if(e&&t){const a=e.value.trim();a&&a.length>0?(t.disabled=!1,t.placeholder="Enter album name..."):(t.disabled=!0,t.placeholder="Select an artist first...")}this.updateSaveButtonState()}updateSaveButtonState(){const e=document.querySelector("#albumForm .btn-save"),t=document.getElementById("releaseYear"),a=document.getElementById("albumFormat");if(e&&t&&a){const s=""!==t.value.trim(),n=""!==a.value.trim();s&&n?(e.disabled=!1,e.style.opacity="1",e.style.cursor="pointer"):(e.disabled=!0,e.style.opacity="0.5",e.style.cursor="not-allowed")}}debounceArtistAutocomplete(e){clearTimeout(this.artistAutocompleteTimeout),this.artistAutocompleteTimeout=setTimeout(()=>{this.handleArtistAutocomplete(e)},300)}debounceAlbumAutocomplete(e,t){clearTimeout(this.albumAutocompleteTimeout),this.albumAutocompleteTimeout=setTimeout(()=>{this.handleAlbumAutocomplete(e,t)},300)}async handleArtistAutocomplete(e){if(e.length<2)this.hideAutocomplete("artistAutocomplete");else{this.showAutocompleteLoading("artistAutocomplete");try{const t=`api/music_api.php?action=artists&search=${encodeURIComponent(e)}`,a=await this.fetchWithCache(t),s=await a.json();s.success?this.showAutocomplete("artistAutocomplete",s.data,"artist_name"):this.hideAutocomplete("artistAutocomplete")}catch(e){this.hideAutocomplete("artistAutocomplete")}}}async handleAlbumAutocomplete(e,t){if(t.length<2)this.hideAutocomplete("albumAutocomplete");else{this.showAutocompleteLoading("albumAutocomplete");try{const a=document.getElementById("formatFilter")?.value||"";let s=`api/music_api.php?action=albums_by_artist&artist=${encodeURIComponent(e)}&search=${encodeURIComponent(t)}`;a&&(s+=`&format=${encodeURIComponent(a)}`);const n=await this.fetchWithCache(s),o=await n.json();o.success?this.showAutocomplete("albumAutocomplete",o.data,"album_name"):this.hideAutocomplete("albumAutocomplete")}catch(e){this.hideAutocomplete("albumAutocomplete")}}}showAutocomplete(e,t,a){const s=document.getElementById(e);let n=s.querySelector(".autocomplete-list");n||(n=document.querySelector(`[data-original-container="${e}"]`)),n&&(n.innerHTML="",t.forEach(t=>{if(t&&t[a]&&"undefined"!==t[a]){const s=document.createElement("div");s.className="autocomplete-item";const o=document.createElement("span");if("album_name"===a&&t.year?o.textContent=`${t[a]} (${t.year})`:o.textContent=t[a],"album_name"===a&&t.format&&(o.innerHTML=o.textContent+'<br><span class="format-text">'+t.format+"</span>"),s.appendChild(o),t.cover_url){const e=document.createElement("img");e.src=t.cover_url,e.className="autocomplete-cover",e.alt="Album cover",e.onerror=()=>{e.remove()},e.onload=()=>{},s.appendChild(e)}s.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),this.selectAutocompleteItem(e,t[a],t)}),n.appendChild(s)}}),n.children.length>0?(n.style.display="block",n.style.visibility="visible",n.style.opacity="1",n.style.zIndex="10000",n.style.position="absolute",n.style.border="1px solid #ddd",n.style.borderRadius="4px",n.style.boxShadow="0 2px 8px rgba(0,0,0,0.1)",n.style.maxHeight="1200px",n.style.overflowY="auto",this.adjustAutocompletePosition(s,n),setTimeout(()=>{this.adjustAutocompletePosition(s,n)},10)):n.style.display="none")}showAutocompleteLoading(e){let t=document.getElementById(e).querySelector(".autocomplete-list");t||(t=document.querySelector(`[data-original-container="${e}"]`)),t&&(t.innerHTML='<div class="autocomplete-loading">Searching...</div>',t.style.display="block")}hideAutocomplete(e){let t=document.getElementById(e).querySelector(".autocomplete-list");if(t||(t=document.querySelector(`[data-original-container="${e}"]`)),t&&(t.style.display="none",t.style.visibility="hidden",t.style.opacity="0",t.parentNode===document.body&&t.dataset.originalContainer)){const e=document.getElementById(t.dataset.originalContainer);e&&(e.appendChild(t),t.style.position="",t.style.top="",t.style.left="",t.style.width="",t.style.zIndex="",delete t.dataset.originalContainer)}}selectAutocompleteItem(e,t,a=null){const s=document.getElementById(e).querySelector("input");if(s&&(s.value=t,a))if("artistAutocomplete"===e)this.selectedArtist=a;else if("albumAutocomplete"===e){this.selectedAlbum=a,this.selectedDiscogsReleaseId=a.id||null,this.selectedCoverUrl=a.cover_url||null;const e=document.getElementById("releaseYear");e&&(a.master_year?e.value=a.master_year:a.id?(e.value="",this.fetchMasterYearForSelection(a.id,e,a.year)):e.value=a.year||"");const t=document.getElementById("albumFormat");t&&a.format&&(t.value=a.format,t.readOnly=!1),this.updateSaveButtonState()}this.hideAutocomplete(e)}debounceSearch(){clearTimeout(this.autocompleteTimeout),this.autocompleteTimeout=setTimeout(()=>{this.loadAlbums()},300)}setFilter(e){this.currentFilter=e,document.querySelectorAll(".filter-btn").forEach(e=>{e.classList.remove("active")}),document.querySelector(`[data-filter="${e}"]`).classList.add("active"),this.loadAlbums()}filterByStyle(e){this.hideStatsModal(),this.currentStyleFilter=e;const t=this.currentFilter;this.currentFilter="all";const a=document.getElementById("searchInput"),s=document.getElementById("clearSearch");a&&(a.value=this.buildFilterText(),a.disabled=!0,s.classList.add("visible")),this.showMessage(`Filtering by style: ${e}`,"info"),this.loadAlbums(),this.currentFilter=t}buildFilterText(){const e=[];return this.currentArtistFilter&&e.push(`Artist: ${this.currentArtistFilter}`),this.currentYearFilter&&e.push(`Year: ${this.currentYearFilter}`),this.currentStyleFilter&&e.push(`Style: ${this.currentStyleFilter}`),this.currentFormatFilter&&e.push(`Format: ${this.currentFormatFilter}`),e.join("; ")}filterByArtist(e){this.hideStatsModal(),this.currentArtistFilter=e;const t=this.currentFilter;this.currentFilter="all";const a=document.getElementById("searchInput"),s=document.getElementById("clearSearch");a&&(a.value=this.buildFilterText(),a.disabled=!0,s.classList.add("visible")),this.showMessage(`Filtering by artist: ${e}`,"info"),this.loadAlbums(),this.currentFilter=t}filterByFormat(e){this.hideStatsModal(),this.currentFormatFilter=e;const t=this.currentFilter;this.currentFilter="all";const a=document.getElementById("searchInput"),s=document.getElementById("clearSearch");a&&(a.value=this.buildFilterText(),a.disabled=!0,s.classList.add("visible")),this.showMessage(`Filtering by format: ${e}`,"info"),this.loadAlbums(),this.currentFilter=t}clearStyleFilter(){this.currentStyleFilter="",this.currentFormatFilter="",this.currentYearFilter="",this.currentArtistFilter="";const e=document.getElementById("searchInput");e&&(e.value="",e.disabled=!1),this.loadAlbums()}clearFormatFilter(){this.currentFormatFilter="",this.currentStyleFilter="",this.currentYearFilter="",this.currentArtistFilter="";const e=document.getElementById("searchInput");e&&(e.value="",e.disabled=!1),this.loadAlbums()}filterByYear(e){this.hideStatsModal(),this.currentYearFilter=e;const t=this.currentFilter;this.currentFilter="all";const a=document.getElementById("searchInput"),s=document.getElementById("clearSearch");a&&(a.value=this.buildFilterText(),a.disabled=!0,s.classList.add("visible")),this.showMessage(`Filtering by year: ${e}`,"info"),this.loadAlbums(),this.currentFilter=t}clearYearFilter(){this.currentYearFilter="",this.currentStyleFilter="",this.currentFormatFilter="";const e=document.getElementById("searchInput");e&&(e.value="",e.disabled=!1),this.loadAlbums()}handleStyleSearchSuggestions(e){const t=e.toLowerCase();if(t.startsWith("style:")||t.startsWith("genre:")||t.startsWith("type:")){const t=e.replace(/^(style|genre|type):\s*/i,"").trim();if(""===t)this.showMessage('Type a style name after "style:" (e.g., style: rock, style: jazz)',"info");else if(t.length>0){const e=document.getElementById("message");e&&e.classList.contains("info")&&(e.style.display="none")}}}async loadStats(){try{const e=await fetch("api/music_api.php?action=stats"),t=await e.json();t.success&&this.updateStats(t.data)}catch(e){}}updateStats(e){const t=document.querySelector('[data-filter="owned"]'),a=document.querySelector('[data-filter="wanted"]'),s=document.querySelector('[data-filter="all"]');if(t){const a=e.owned_count||0;t.textContent=`${a} Owned`}if(a){const t=e.wanted_count||0;a.textContent=`${t} Want`}if(s){const t=e.total_albums||0;s.textContent=`${t} Total`}this.updateFooterStats(e);const n=document.getElementById("styleStatsList");if(n&&e.style_counts){const t=Object.entries(e.style_counts);if(t.length>0){const e=t;n.innerHTML=e.map(([e,t])=>`\n                  <div class="style-stat-item" data-style="${this.escapeHtml(e)}">\n                      <span class="style-name">${this.escapeHtml(e)}</span>\n                      <span class="style-count">${t}</span>\n                  </div>\n              `).join(""),n.querySelectorAll(".style-stat-item").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const a=e.dataset.style;this.filterByStyle(a)})})}else n.innerHTML='<p class="no-styles">No style information available</p>'}const o=document.getElementById("formatStatsList");if(o&&e.format_counts){const t=Object.entries(e.format_counts);if(t.length>0){const e=t;o.innerHTML=e.map(([e,t])=>`\n                  <div class="format-stat-item" data-format="${encodeURIComponent(e)}">\n                      <span class="format-name">${this.escapeHtml(e)}</span>\n                      <span class="format-count">${t}</span>\n                  </div>\n              `).join(""),o.querySelectorAll(".format-stat-item").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const a=decodeURIComponent(e.dataset.format);this.filterByFormat(a)})})}else o.innerHTML='<p class="no-formats">No format information available</p>'}const l=document.getElementById("yearStatsList");if(l&&e.year_counts){const t=Object.entries(e.year_counts);t.sort((e,t)=>{const a=t[1]-e[1];return 0!==a?a:t[0]-e[0]}),t.length>0?(l.innerHTML=t.map(([e,t])=>`\n                  <div class="year-stat-item" data-year="${e}">\n                      <span class="year-name">${this.escapeHtml(e)}</span>\n                      <span class="year-count">${t}</span>\n                  </div>\n              `).join(""),l.querySelectorAll(".year-stat-item").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const a=e.dataset.year;this.filterByYear(a)})})):l.innerHTML='<p class="no-years">No year information available</p>'}}updateFooterStats(e){document.getElementById("footerStats")&&("undefined"!=typeof Chart?(this.createFooterYearChart(e.year_counts),this.createFooterStyleChart(e.style_counts,e.total_albums),this.createFooterFormatChart(e.format_counts,e.total_albums)):setTimeout(()=>this.updateFooterStats(e),100))}createFooterYearChart(e){const t=document.getElementById("footerYearChart");if(!t||!e)return;const a=Object.entries(e);a.sort((e,t)=>{const a=t[1]-e[1];return 0!==a?a:t[0]-e[0]});const s=a.slice(0,5);if(0===s.length)return void(t.innerHTML='<p class="no-data">No year data available</p>');t.innerHTML='<canvas id="yearBarChart" width="200" height="200"></canvas>';const n=document.getElementById("yearBarChart").getContext("2d"),o=Math.max(...s.map(([,e])=>e));new Chart(n,{type:"bar",data:{labels:s.map(([e])=>e),datasets:[{data:s.map(([,e])=>e),backgroundColor:"#38BA6A",borderWidth:0}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(e){return`${e.label}: ${e.parsed.x} albums`}}}},scales:{x:{beginAtZero:!0,max:o,ticks:{stepSize:1,color:"rgba(255, 255, 255, 0.8)"},grid:{color:"rgba(255, 255, 255, 0.1)"}},y:{ticks:{color:"rgba(255, 255, 255, 0.8)"},grid:{display:!1}}},onClick:(e,t)=>{if(t.length>0){const e=t[0].index,a=s[e][0];this.filterByYear(a)}},onHover:(e,t)=>{e.native.target.style.cursor=t.length>0?"pointer":"default"}}})}createFooterStyleChart(e,t){const a=document.getElementById("footerStyleChart");if(!a||!e)return;const s=Object.entries(e);s.sort((e,t)=>t[1]-e[1]);const n=s.slice(0,5),o=t||s.reduce((e,[,t])=>e+t,0);if(0===n.length)return void(a.innerHTML='<p class="no-data">No style data available</p>');a.innerHTML='<canvas id="stylePieChart" width="200" height="200"></canvas>';const l=document.getElementById("stylePieChart").getContext("2d");new Chart(l,{type:"pie",data:{labels:n.map(([e])=>e),datasets:[{data:n.map(([,e])=>e),backgroundColor:["#38BA6A","#E9C46A","#EB8244","#309BF1","#E83DB4"],borderWidth:0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{position:"average",intersect:!1,callbacks:{label:function(e){const t=(e.parsed/o*100).toFixed(1);return`${e.label}: ${e.parsed} (${t}%)`}}}},layout:{padding:{top:20,bottom:20,left:20,right:20}},onClick:(e,t)=>{if(t.length>0){const e=t[0].index,a=n[e][0];this.filterByStyle(a)}},onHover:(e,t)=>{e.native.target.style.cursor=t.length>0?"pointer":"default"}}})}createFooterFormatChart(e,t){const a=document.getElementById("footerFormatChart");if(!a||!e)return;const s=Object.entries(e);s.sort((e,t)=>t[1]-e[1]);const n=s.slice(0,5),o=t||s.reduce((e,[,t])=>e+t,0);if(0===n.length)return void(a.innerHTML='<p class="no-data">No format data available</p>');a.innerHTML='<canvas id="formatPieChart" width="200" height="200"></canvas>';const l=document.getElementById("formatPieChart").getContext("2d");new Chart(l,{type:"pie",data:{labels:n.map(([e])=>e),datasets:[{data:n.map(([,e])=>e),backgroundColor:["#38BA6A","#E9C46A","#EB8244","#309BF1","#E83DB4"],borderWidth:0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{position:"average",intersect:!1,callbacks:{label:function(e){const t=(e.parsed/o*100).toFixed(1);return`${e.label}: ${e.parsed} (${t}%)`}}}},layout:{padding:{top:20,bottom:20,left:20,right:20}},onClick:(e,t)=>{if(t.length>0){const e=t[0].index,a=n[e][0];this.filterByFormat(a)}},onHover:(e,t)=>{e.native.target.style.cursor=t.length>0?"pointer":"default"}}})}updateFilterButtonsWithFilteredCount(e){if(!(this.currentSearch||this.currentStyleFilter||this.currentFormatFilter||this.currentYearFilter||this.currentArtistFilter))return;const t=e.length,a=e.filter(e=>1==e.is_owned).length,s=e.filter(e=>1==e.want_to_own).length,n=document.querySelector('[data-filter="owned"]'),o=document.querySelector('[data-filter="wanted"]'),l=document.querySelector('[data-filter="all"]');n&&(n.textContent=`${a} Owned`),o&&(o.textContent=`${s} Want`),l&&(l.textContent=`${t} Total`)}async loadAlbums(){this.showLoading();const e=document.querySelector(".table-container");e&&e.classList.add("loading");try{const e=this.currentSearch.toLowerCase(),t=["style:","genre:","type:"].some(t=>e.startsWith(t))?"":this.currentSearch,a=this.currentSearch||this.currentStyleFilter||this.currentFormatFilter||this.currentYearFilter||this.currentArtistFilter?"all":this.currentFilter,s=new URLSearchParams({action:"albums",filter:a,search:t}),n=await this.fetchWithCache(`api/music_api.php?${s}`),o=await n.json();if(o.success){let e=o.data;if(this.currentStyleFilter&&(e=e.filter(e=>{if(!e.style)return!1;return e.style.split(",").map(e=>e.trim()).includes(this.currentStyleFilter)})),this.currentFormatFilter&&(e=e.filter(e=>{if(!e.format)return!1;return e.format.split(",").map(e=>e.trim()).some(e=>{const t=e.replace(/\\"/g,'"');return t.includes(this.currentFormatFilter)||this.currentFormatFilter.includes(t)})})),this.currentYearFilter&&(e=e.filter(e=>e.release_year==this.currentYearFilter)),this.currentArtistFilter&&(e=e.filter(e=>e.artist_name.toLowerCase()===this.currentArtistFilter.toLowerCase())),this.currentSearch&&!this.currentStyleFilter){const t=this.currentSearch.toLowerCase();if(["style:","genre:","type:"].some(e=>t.startsWith(e))){const t=this.currentSearch.replace(/^(style|genre|type):\s*/i,"").trim();t&&(e=e.filter(e=>{if(!e.style)return!1;const a=e.style.toLowerCase(),s=t.toLowerCase();return a.split(",").map(e=>e.trim().toLowerCase()).some(e=>e.includes(s))}))}}this.updateFilterButtonsWithFilteredCount(e),"all"!==this.currentFilter&&(e=e.filter(e=>"owned"===this.currentFilter?1==e.is_owned:"wanted"!==this.currentFilter||1==e.want_to_own));try{const t=this.sortAlbums(e);this.renderAlbums(t)}catch(t){console.error("Sorting error:",t),this.renderAlbums(e)}}else this.showMessage("Error loading albums: "+o.message,"error")}catch(e){this.showMessage("Error loading albums","error")}finally{this.hideLoading(),e&&e.classList.remove("loading")}}renderAlbums(e){const t=document.querySelector("#albumsTable tbody");0!==e.length?(t.innerHTML=e.map(e=>`\n          <tr data-id="${e.id}" data-artist-type="${e.artist_type||""}">\n              <td class="cover-cell">\n                  ${e.cover_url?`<img data-src="${e.cover_url}" data-medium="${e.cover_url_medium||e.cover_url}" data-large="${e.cover_url_large||e.cover_url}" class="album-cover lazy" alt="Album cover" data-artist="${this.escapeHtml(e.artist_name)}" data-album="${this.escapeHtml(e.album_name)}" data-year="${e.release_year||""}" data-cover="${e.cover_url_large||e.cover_url}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" onload="this.classList.add('loaded')" width="60" height="60">\n                       <div class="no-cover" style="display: none;">No Cover</div>`:'<div class="no-cover">No Cover</div>'}\n                  <div class="mobile-status">\n                      ${e.is_owned?'<span class="status-owned">Own</span>':""}\n                      ${e.want_to_own?'<span class="status-wanted">Want</span>':""}\n                      ${e.is_owned||e.want_to_own?"":'<span class="status-none">-</span>'}\n                  </div>\n              </td>\n              <td>\n                  <div class="album-info">\n                      <div class="artist-name">\n                          <a href="#" class="artist-link" data-artist="${this.escapeHtml(e.artist_name)}">\n                              ${this.escapeHtml(e.artist_name)}\n                          </a>\n                      </div>\n                      <div class="album-name">\n                          <a href="#" class="album-link" data-artist="${this.escapeHtml(e.artist_name)}" data-album="${this.escapeHtml(e.album_name)}" data-year="${e.release_year||""}">\n                              ${this.escapeHtml(e.album_name)}\n                          </a>\n                      </div>\n                      <div class="mobile-year">${e.release_year?`<button type="button" class="year-link" data-year="${e.release_year}"><span class="year-badge">${e.release_year}</span></button>`:'<span class="year-badge">-</span>'}</div>\n                      <div class="mobile-actions">\n                          <button class="btn-edit" data-id="${e.id}">\n                              <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="Edit" style="vertical-align: text-top;">\n                                <title>edit</title>\n                                <path d="M4 20h4l10.5-10.5a2 2 0 0 0 0-2.8l-1.2-1.2a2 2 0 0 0-2.8 0L4 16v4z" />\n                                <path d="M13.5 6.5l4 4" />\n                              </svg>\n                              Edit\n                          </button>\n                          <button class="btn-delete" data-id="${e.id}">\n                              &times; \n                              Delete\n                          </button>\n                      </div>\n                  </div>\n              </td>\n              <td>\n                  ${e.release_year?`<button type="button" class="year-link" data-year="${e.release_year}"><span class="year-badge">${e.release_year}</span></button>`:'<span class="year-badge">-</span>'}\n              </td>\n              <td>\n                  ${e.is_owned?'<span class="checkmark">✓</span>':'<span class="checkmark">&nbsp;</span>'}\n              </td>\n              <td>\n                  ${e.want_to_own?'<span class="checkmark">✓</span>':'<span class="checkmark">&nbsp;</span>'}\n              </td>\n              <td>\n                  <div class="action-buttons">\n                      <button class="btn-edit" data-id="${e.id}">\n                          <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="Edit" style="vertical-align: text-top;">\n                            <title>edit</title>\n                            <path d="M4 20h4l10.5-10.5a2 2 0 0 0 0-2.8l-1.2-1.2a2 2 0 0 0-2.8 0L4 16v4z" />\n                            <path d="M13.5 6.5l4 4" />\n                          </svg>\n                          Edit\n                      </button>\n                      <button class="btn-delete" data-id="${e.id}">\n                          &times; \n                          Delete\n                      </button>\n                  </div>\n              </td>\n          </tr>\n      `).join(""),this.initLazyLoading(),this.updateAuthUI()):t.innerHTML='\n              <tr>\n                  <td colspan="6" class="empty-state">\n                      <h3>No albums found</h3>\n                      <p>Try adjusting your search or filter criteria</p>\n                  </td>\n              </tr>\n          '}async fetchMasterYearForSelection(e,t,a=null){try{const s=await this.fetchWithCache(`api/music_api.php?action=master_year&release_id=${e}`),n=await s.json();n.success&&n.data&&n.data.master_year?t&&(t.value=n.data.master_year):a&&t&&(t.value=a)}catch(e){a&&t&&(t.value=a)}this.updateSaveButtonState()}async editAlbum(e){try{const t=await this.fetchWithCache(`api/music_api.php?action=album&id=${e}`),a=await t.json();a.success?(this.editingAlbum=a.data,this.showModal(a.data)):this.showMessage("Error loading album: "+a.message,"error")}catch(e){this.showMessage("Error loading album","error")}}async deleteAlbum(e){if(this.isAuthenticated){if(confirm("Are you sure you want to delete this album?"))try{const t=new AbortController,a=setTimeout(()=>t.abort(),1e4),s=await fetch("api/music_api.php?action=delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e}),signal:t.signal});clearTimeout(a);const n=await s.json();n.success?(this.showMessage("Album deleted successfully","success"),this.loadAlbums(),this.loadStats()):n.auth_required?this.showLoginModal():this.showMessage("Error deleting album: "+n.message,"error")}catch(e){"AbortError"===e.name?this.showMessage("Delete request timed out. Please try again.","error"):this.showMessage("Error deleting album","error")}}else this.showLoginModal()}showModal(e=null){const t=document.getElementById("albumModal"),a=document.getElementById("albumForm"),s=document.querySelector("#albumModal h2"),n=document.getElementById("viewRecordBtn");if(a.reset(),this.hideModalMessage(),t.classList.remove("add-album","edit-album"),e?t.classList.add("edit-album"):t.classList.add("add-album"),e){s.textContent="Edit Album",document.getElementById("artistName").value=e.artist_name,document.getElementById("albumName").value=e.album_name,document.getElementById("releaseYear").value=e.release_year||"";const t=document.getElementById("albumFormat");t.value=e.format||"",t.readOnly=!1,this.selectedCoverUrl=e.cover_url||null,this.selectedDiscogsReleaseId=e.discogs_release_id||null,1==e.is_owned?document.getElementById("isOwned").checked=!0:1==e.want_to_own&&(document.getElementById("wantToOwn").checked=!0);const a=document.getElementById("albumName");a.disabled=!1,a.placeholder="Enter album name...",n.style.display="block",this.editingAlbum=e,this.updateSaveButtonState()}else{s.textContent="Add New Album",this.editingAlbum=null,n.style.display="none",this.selectedCoverUrl=null,this.selectedDiscogsReleaseId=null;const e=document.getElementById("albumFormat");e.value="",e.readOnly=!0,this.updateAlbumInputState()}t.style.display="block",this.updateSaveButtonState(),document.getElementById("artistName").focus()}hideModal(){const e=document.getElementById("albumModal");e.style.display="none",e.classList.remove("add-album","edit-album"),this.editingAlbum=null,this.selectedCoverUrl=null,this.selectedDiscogsReleaseId=null,this.hideModalMessage()}async showViewRecordModal(){if(!this.editingAlbum)return;const e=document.getElementById("viewRecordModal"),t=document.getElementById("recordData");try{const e=await this.fetchWithCache(`api/music_api.php?action=album&id=${this.editingAlbum.id}`),a=await e.json();if(a.success&&a.data){this.originalAlbumData=a.data;const e=JSON.stringify(a.data,null,2);t.textContent=e}else t.textContent="Error loading album data: "+(a.message||"Unknown error")}catch(e){t.textContent="Error loading album data: "+e.message}e.style.display="block"}hideViewRecordModal(){document.getElementById("viewRecordModal").style.display="none",this.cancelRecordEditing(),this.hideModal()}enableRecordEditing(){const e=document.getElementById("recordData"),t=document.getElementById("editRecordBtn"),a=document.getElementById("saveRecordBtn"),s=document.getElementById("cancelEditBtn"),n=document.getElementById("editWarning"),o=document.getElementById("editError");this.originalRecordData=e.textContent,this.createProtectedJsonEditor(),t.style.display="none",a.style.display="block",s.style.display="block",n.style.display="block",o.style.display="none"}cancelRecordEditing(){const e=document.getElementById("recordData"),t=document.getElementById("editRecordBtn"),a=document.getElementById("saveRecordBtn"),s=document.getElementById("cancelEditBtn"),n=document.getElementById("editWarning"),o=document.getElementById("editError");this.originalRecordData&&(e.textContent=this.originalRecordData),e.contentEditable=!1,t.style.display="block",a.style.display="none",s.style.display="none",n.style.display="none",o.style.display="none",this.originalRecordData=null,this.originalAlbumData=null}createProtectedJsonEditor(){const e=document.getElementById("recordData"),t=this.originalAlbumData;if(!t)return;e.innerHTML="",e.contentEditable=!1;const a=document.createElement("div");a.className="protected-json-editor",a.style.whiteSpace="pre",a.style.lineHeight="1.4";Object.entries(t).forEach(([e,s],n)=>{"  ".repeat(1);const o=n===Object.keys(t).length-1,l=document.createElement("span");l.textContent=`"${e}":`,l.style.color="#0066cc",l.style.fontWeight="bold",l.contentEditable=!1;const i=document.createElement("span");i.textContent="string"==typeof s?`"${s}"`:s,"id"===e?(i.contentEditable=!1,i.style.color="#6c757d",i.style.fontStyle="italic",i.style.backgroundColor="#f8f9fa",i.style.padding="2px 4px",i.style.borderRadius="3px",i.style.border="1px solid #dee2e6"):(i.contentEditable=!0,i.style.outline="none",i.style.border="1px solid transparent",i.style.borderRadius="2px",i.style.padding="2px 4px",i.style.backgroundColor="#ffffff",i.style.color="#212529",i.style.fontWeight="500"),i.dataset.key=e,i.dataset.originalValue=s,"id"!==e&&(i.addEventListener("mouseenter",()=>{i.style.backgroundColor="#e3f2fd",i.style.borderColor="#007bff"}),i.addEventListener("mouseleave",()=>{i.style.backgroundColor="#ffffff",i.style.borderColor="transparent"}),i.addEventListener("focus",()=>{i.style.backgroundColor="#e3f2fd",i.style.borderColor="#007bff",i.style.boxShadow="0 0 0 2px rgba(0, 123, 255, 0.25)"}),i.addEventListener("blur",()=>{i.style.backgroundColor="#ffffff",i.style.borderColor="transparent",i.style.boxShadow="none"}));const r=document.createElement("div");if(r.style.marginLeft="20px",r.appendChild(l),r.appendChild(i),!o){const e=document.createElement("span");e.textContent=",",r.appendChild(e)}a.appendChild(r)}),e.appendChild(a);const s=e.querySelector('[contenteditable="true"]');s&&s.focus()}collectDataFromProtectedEditor(){const e=document.getElementById("recordData"),t={...this.originalAlbumData};return e.querySelectorAll('[contenteditable="true"]').forEach(e=>{const a=e.dataset.key,s=e.dataset.originalValue;let n=e.textContent.trim();"string"==typeof s?(n.startsWith('"')&&n.endsWith('"')&&(n=n.slice(1,-1)),t[a]=n):t[a]="number"==typeof s?parseFloat(n)||s:"boolean"==typeof s?"true"===n.toLowerCase():null===s&&"null"===n?null:n}),t}async saveRecordChanges(){const e=document.getElementById("recordData"),t=document.getElementById("editRecordBtn"),a=document.getElementById("saveRecordBtn"),s=document.getElementById("cancelEditBtn");try{const n=this.collectDataFromProtectedEditor();if(!n.artist_name||!n.album_name)throw new Error("Artist name and album name are required");if(n.id!==this.editingAlbum.id)throw new Error("Cannot change the album ID. This field is protected to prevent data conflicts.");const o=await fetch("api/music_api.php?action=update_raw",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),l=await o.json();if(!l.success)throw new Error(l.message||"Failed to update record");this.editingAlbum=n,e.textContent=JSON.stringify(n,null,2),e.contentEditable=!1,t.style.display="block",a.style.display="none",s.style.display="none";document.getElementById("editWarning").style.display="none",this.originalRecordData=null,this.showMessage("Record updated successfully","success"),this.loadAlbums(),this.hideViewRecordModal()}catch(t){const a=document.getElementById("editError");a.innerHTML=`<strong>❌ Error:</strong> ${t.message}`,a.style.display="block",this.originalRecordData&&(e.textContent=this.originalRecordData)}}hideModalMessage(){const e=document.getElementById("modalMessage");e.style.display="none",e.textContent="",e.className="modal-message"}async saveAlbum(){if(!this.isAuthenticated)return void this.showLoginModal();const e=document.getElementById("albumForm"),t=new FormData(e),a=t.get("albumStatus");if(!a)return void this.showModalMessage('Please select either "I own this album" or "I want to own this album"',"error");const s={artist_name:t.get("artistName"),album_name:t.get("albumName"),release_year:t.get("releaseYear"),format:t.get("albumFormat"),is_owned:"owned"===a,want_to_own:"wanted"===a,cover_url:this.selectedCoverUrl||null,discogs_release_id:this.selectedDiscogsReleaseId||null},n=this.editingAlbum?"update":"add";this.editingAlbum&&(s.id=this.editingAlbum.id);try{const e=await fetch(`api/music_api.php?action=${n}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);const t=await e.text();if(!t.trim())throw new Error("Empty response from server");let a;try{a=JSON.parse(t)}catch(e){throw new Error(`Invalid JSON response: ${e.message}`)}a.success?(this.hideModal(),this.showMessage(a.message,"success"),this.loadAlbums(),this.loadStats(),this.editingAlbum=null):a.auth_required?this.showLoginModal():this.showModalMessage(a.message||"Unknown error occurred","error")}catch(e){this.showModalMessage("Network error: "+e.message,"error")}}showLoading(){document.getElementById("loading").style.display="block"}hideLoading(){document.getElementById("loading").style.display="none"}showModalMessage(e,t){const a=document.getElementById("modalMessage");a.textContent=e,a.className=`modal-message ${t}`,a.style.display="block",setTimeout(()=>{a.style.display="none"},5e3)}showMessage(e,t){const a=document.getElementById("message");a.textContent=e,a.className=`message ${t}`,a.style.display="block",setTimeout(()=>{a.style.display="none"},5e3)}async showCoverModal(e,t,a,s,n=null){const o=document.getElementById("coverModal"),l=document.getElementById("coverModalImage"),i=document.getElementById("coverModalInfo");l.src=s,l.alt=`${t} by ${e}`,i.innerHTML=`\n          <div class="artist-name">${this.escapeHtml(e)}</div>\n          <div class="album-name"><a href="javascript:void(0)" class="album-link" data-artist="${this.escapeHtml(e)}" data-album="${this.escapeHtml(t)}" data-year="${a||""}" data-album-id="${n||""}">${this.escapeHtml(t)}</a></div>\n          ${a?`<div class="album-year">${a}</div>`:""}\n      `;const r=i.querySelector(".album-link");if(r&&r.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();const t=r.dataset.artist,a=r.dataset.album,s=r.dataset.year,n=r.dataset.albumId;this.showTracklist(t,a,s,n),this.hideCoverModal()}),o.style.display="block",n)try{const s=new URLSearchParams({artist:e,album:t});a&&s.append("year",a),s.append("album_id",n);const o=await this.fetchWithCache(`api/tracklist_api.php?${s}`),l=await o.json();if(l.success&&l.data&&l.data.master_year){const e=i.querySelector(".album-year");e&&(e.textContent=l.data.master_year)}}catch(e){}}hideCoverModal(){document.getElementById("coverModal").style.display="none"}async showTracklist(e,t,a,s=null){const n=document.getElementById("tracklistModal"),o=document.getElementById("tracklistModalTitle"),l=document.getElementById("tracklistModalInfo"),i=document.getElementById("tracklistModalTracks"),r=document.getElementById("tracklistModalDiscogsLink"),d=document.getElementById("tracklistModalCover"),c=document.getElementById("tracklistModalNoCover");o.textContent=`${t}`,l.innerHTML=`\n          <div><strong>Artist:</strong> ${e}</div>\n          ${a?`<div><strong>Year:</strong> ${a}</div>`:""}\n      `,d.style.display="none",c.style.display="none",c.textContent="";let u=null;if(s){const e=document.querySelector(`tr[data-id="${s}"]`);if(e){const t=e.querySelector(".album-cover");t&&t.src&&t.src!==window.location.href&&(u=t.src)}}u&&(d.src=u,d.style.display="block",c.style.display="none",d.classList.add("loaded")),i.innerHTML='<div class="tracklist-loading">Loading tracklist...</div>',n.style.display="block",n.dataset.artistName=e,n.dataset.albumName=t,n.dataset.releaseYear=a||"",n.dataset.albumId=s||"";const m=document.getElementById("tracklistEditBtn");m&&(this.isAuthenticated&&s?(m.style.display="flex",m.dataset.albumId=s,m.dataset.artistName=e,m.dataset.albumName=t,m.dataset.releaseYear=a||""):m.style.display="none");try{const n=new URLSearchParams({artist:e,album:t});a&&n.append("year",a),s&&n.append("album_id",s);const o=await fetch(`api/tracklist_api.php?${n}`,{cache:"no-cache",headers:{"Content-Type":"application/json"}}),m=await o.json();if(m.success&&m.data){const e=m.data;let t="";if(e.released)try{let a=e.released,s=!1;a.match(/^\d{4}-\d{2}-00$/)&&(s=!0,a=a.replace("-00","-01"));const n=a.split("-"),o=parseInt(n[0]),l=parseInt(n[1])-1,i=parseInt(n[2]),r=new Date(o,l,i);if(isNaN(r.getTime()))t=e.released;else{const e=r.getMonth(),a=r.getDate();t=s||11===e&&31===a?o.toString():r.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}}catch(a){t=e.released}let a="";if(e.rating_count){const t=1===e.rating_count?"review":"reviews";a=e.has_reviews_with_content?`<div class="rating-count">(based on <a href="${e.discogs_url}#release-reviews" target="_blank" rel="noopener noreferrer" style="padding-left: .25em;">${e.rating_count} ${t}</a>)</div>`:`<div class="rating-count">(based on ${e.rating_count} ${t})</div>`}const s=e=>e?e.replace(/\s*\(\d+\)\s*$/,""):e;if(l.innerHTML=`\n                  <div><strong>Artist:</strong> <span>${s(e.artist)}</span></div>\n                  ${t?`<div><strong>Year:</strong> <span>${t}</span></div>`:""}\n                  ${e.label?`<div><strong>Label:</strong> <span>${s(e.label)}</span></div>`:""}\n                  ${e.year?`<div><strong>Released:</strong> <span>${e.year}</span></div>`:""}\n                  ${e.format?`<div><strong>Format:</strong> <span>${e.format}</span></div>`:""}\n                  ${e.producer?`<div><strong>Producer:</strong> <span>${s(e.producer)}</span></div>`:""}\n                  ${e.rating?`<div><strong>Rating:</strong> <span class="rating-value">${e.rating}${this.generateStarRating(e.rating)}</span>${a}</div>`:""}\n              `,!u&&e.cover_url){const t=e.cover_url_medium||e.cover_url;t.includes("api/image_proxy.php")?(d.style.display="none",c.style.display="none",c.textContent=""):(c.textContent="Loading Cover...",c.style.display="flex",d.style.display="none"),d.src=t;const a=setTimeout(()=>{"none"===d.style.display&&(d.style.display="none",c.textContent="No Cover",c.style.display="flex")},1e4);d.onload=function(){clearTimeout(a),d.style.display="block",c.style.display="none",d.classList.add("loaded")},d.onerror=function(){clearTimeout(a),d.style.display="none",c.textContent="No Cover",c.style.display="flex"}}else u||e.cover_url||(d.style.display="none",c.textContent="No Cover",c.style.display="flex");if(r.href=e.discogs_url,e.matched_reason){const t=document.createElement("div");t.className="tracklist-match-info",t.innerHTML=`<small>Matched: ${e.matched_reason}</small>`,i.appendChild(t)}e.tracklist&&e.tracklist.length>0?i.innerHTML=`\n                      <div class="tracklist-modal-tracks">\n                          ${e.tracklist.map(e=>`\n                              <div class="track-item">\n                                  <span class="track-position">${e.position}</span>\n                                  <span class="track-title">${this.escapeHtml(e.title)}</span>\n                                  <span class="track-duration">${e.duration||""}</span>\n                              </div>\n                          `).join("")}\n                      </div>\n                  `:i.innerHTML='<div class="tracklist-error">No tracklist available for this album</div>'}else{let a="Could not load tracklist";m.message&&!m.message.includes("Discogs API request failed")&&(a=m.message),i.innerHTML=`<div class="tracklist-error">${a}</div>`,r.href=`https://www.discogs.com/search/?q=${encodeURIComponent(e+" "+t)}&type=release`}}catch(a){i.innerHTML='<div class="tracklist-error">Could not load tracklist. Please try again later.</div>',r.href=`https://www.discogs.com/search/?q=${encodeURIComponent(e+" "+t)}&type=release`}}hideTracklistModal(){document.getElementById("tracklistModal").style.display="none"}handleTracklistEdit(){const e=document.getElementById("tracklistEditBtn");if(!e||!e.dataset.albumId)return;const t=e.dataset.albumId;this.hideTracklistModal(),this.editAlbum(parseInt(t))}showLoginModal(){document.getElementById("loginModal").style.display="block",document.getElementById("password").focus(),document.getElementById("loginMessage").style.display="none"}showStatsModal(){document.getElementById("statsModal").style.display="block"}hideStatsModal(){document.getElementById("statsModal").style.display="none"}showResetPasswordModal(){this.isAuthenticated?(document.getElementById("resetPasswordMessage").style.display="none",document.getElementById("resetPasswordForm").reset(),document.getElementById("resetPasswordModal").style.display="block",document.getElementById("reset_current_password").focus()):this.showLoginModal()}hideResetPasswordModal(){document.getElementById("resetPasswordModal").style.display="none",document.getElementById("resetPasswordForm").reset(),document.getElementById("resetPasswordMessage").style.display="none"}async handleResetPassword(e){e.preventDefault();const t=document.getElementById("reset_current_password").value,a=document.getElementById("reset_new_password").value,s=document.getElementById("reset_confirm_password").value,n=document.getElementById("resetPasswordMessage");try{const e=await fetch("api/music_api.php?action=reset_password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({current_password:t,new_password:a,confirm_password:s})}),o=await e.json();o.success?(n.textContent=o.message,n.className="modal-message success",n.style.display="block",document.getElementById("resetPasswordForm").reset(),setTimeout(()=>{this.hideResetPasswordModal()},3e3)):(n.textContent=o.message,n.className="modal-message error",n.style.display="block")}catch(e){n.textContent="Network error. Please try again.",n.className="modal-message error",n.style.display="block"}}showSetupModal(){this.isAuthenticated?(this.loadSetupStatus(),document.getElementById("setupMessage").style.display="none",document.getElementById("setupForm").reset(),document.getElementById("setupModal").style.display="block",this.setupThemeCustomization(),document.getElementById("setup_discogs_api_key").focus()):this.showLoginModal()}hideSetupModal(){document.getElementById("setupModal").style.display="none",document.getElementById("setupForm").reset(),document.getElementById("setupMessage").style.display="none"}async loadSetupStatus(){try{const e=await fetch("api/music_api.php?action=get_setup_status"),t=await e.json();if(t.success){const e=t.data,a=document.getElementById("apiKeyStatus"),s=document.getElementById("currentApiKeyDisplay"),n=document.getElementById("currentApiKeyText");e.api_key_set?(a.textContent="✅ Set",a.className="status-value set",s.style.display="block",n.textContent=e.current_api_key):(a.textContent="❌ Not set",a.className="status-value not-set",s.style.display="none");document.getElementById("passwordActionText").textContent="Change Password";const o=document.getElementById("overallStatus");e.api_key_set?(o.textContent="✅ Complete",o.className="status-value set"):(o.textContent="⚠️ Incomplete",o.className="status-value not-set")}}catch(e){console.error("Error loading setup status:",e)}}async handleSetupConfig(e){e.preventDefault();const t=document.getElementById("setup_discogs_api_key").value,a=document.getElementById("setupMessage");try{const e=await fetch("api/music_api.php?action=setup_config",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({discogs_api_key:t})}),s=await e.json();s.success?(a.textContent=s.message,a.className="modal-message success",a.style.display="block",document.getElementById("setupForm").reset(),this.loadSetupStatus(),setTimeout(()=>{this.hideSetupModal()},3e3)):(a.textContent=s.message,a.className="modal-message error",a.style.display="block")}catch(e){a.textContent="Network error. Please try again.",a.className="modal-message error",a.style.display="block"}}hideLoginModal(){const e=document.getElementById("loginModal");e&&(e.style.display="none"),document.getElementById("password").value="";const t=document.getElementById("loginMessage");t&&(t.style.display="none")}async handleLogin(e){e.preventDefault();const t=document.getElementById("password").value,a=document.getElementById("loginMessage");if(!t)return a.textContent="Please enter a password.",a.className="modal-message error",void(a.style.display="block");try{const e=new AbortController,s=setTimeout(()=>e.abort(),1e4),n=await fetch("api/music_api.php?action=login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:t}),signal:e.signal});clearTimeout(s);const o=await n.json();o.success?(await this.checkAuthStatus(),this.hideLoginModal(),this.showMessage("Login successful","success")):(a.textContent=o.message,a.className="modal-message error",a.style.display="block")}catch(e){"AbortError"===e.name?a.textContent="Login request timed out. Please try again.":a.textContent="Login failed. Please try again.",a.className="modal-message error",a.style.display="block"}}async handleLogout(){try{const e=await fetch("api/music_api.php?action=logout",{method:"POST",headers:{"Content-Type":"application/json"}});(await e.json()).success&&(await this.checkAuthStatus(),this.showMessage("Logged out successfully","success"))}catch(e){}}initLazyLoading(){if("IntersectionObserver"in window){const e=new IntersectionObserver((e,t)=>{e.forEach(e=>{if(e.isIntersecting){const a=e.target;this.loadOptimizedImage(a,a.dataset.src),a.classList.remove("lazy"),a.classList.add("loaded"),t.unobserve(a)}})},{rootMargin:"50px 0px",threshold:.01});document.querySelectorAll("img.lazy").forEach(t=>{e.observe(t)})}else this.loadLazyImagesFallback()}loadLazyImagesFallback(){const e=document.querySelectorAll("img.lazy"),t=e=>{e.dataset.src&&(this.loadOptimizedImage(e,e.dataset.src),e.classList.remove("lazy"))};e.forEach(e=>{this.isElementInViewport(e)&&t(e)});const a=()=>{e.forEach(e=>{e.classList.contains("lazy")&&this.isElementInViewport(e)&&t(e)})};window.addEventListener("scroll",a),window.addEventListener("resize",a)}isElementInViewport(e){const t=e.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&t.right<=(window.innerWidth||document.documentElement.clientWidth)}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}decodeHtmlEntities(e){const t=document.createElement("div");return t.innerHTML=e,t.textContent}formatDate(e){if(!e)return"-";return new Date(e).toLocaleDateString()}loadOptimizedImage(e,t,a=null){if(this.isWebPSupported()&&t.includes("discogs.com")&&!t.includes("fm=webp")){const s=t.includes("?")?t+"&fm=webp":t+"?fm=webp";e.src=s,e.onerror=()=>{e.src=t,a&&(e.onerror=()=>{e.src=a})}}else e.src=t,a&&(e.onerror=()=>{e.src=a})}isWebPSupported(){const e=document.createElement("canvas");return e.width=1,e.height=1,0===e.toDataURL("image/webp").indexOf("data:image/webp")}generateStarRating(e){const t=Math.floor(e),a=e%1;let s="";a>=.875?s="filled":a>=.625?s="three-quarter":a>=.375?s="half":a>=.125&&(s="quarter");const n=5-(t+(s?1:0));let o='<span class="stars">';for(let e=0;e<t;e++)o+='<span class="star filled">★</span>';s&&"filled"!==s?o+=`<span class="star ${s}">★</span>`:"filled"===s&&(o+='<span class="star filled">★</span>');for(let e=0;e<n;e++)o+='<span class="star empty">☆</span>';return o+="</span>",o}adjustAutocompletePosition(e,t){const a=e.closest(".modal");if(!a)return;const s=a.querySelector(".modal-content"),n=e.getBoundingClientRect(),o=s.getBoundingClientRect();t.style.top="100%",t.style.bottom="auto",t.style.maxHeight="1200px";const l=o.bottom-n.bottom-20,i=n.top-o.top-20,r=Math.min(t.scrollHeight,1200);l<200&&i>l+100?(t.style.top="auto",t.style.bottom="100%",t.style.maxHeight=`${Math.min(i-20,1200)}px`,t.style.overflowY="auto",t.style.overflowX="hidden"):(t.style.top="100%",t.style.bottom="auto",t.style.maxHeight=l<r?`${Math.max(l-20,300)}px`:`${Math.min(l-20,1200)}px`,t.style.overflowY="auto",t.style.overflowX="hidden");const d=t.offsetWidth,c=e.offsetWidth;d>c&&(t.style.width=`${c}px`),t.style.zIndex="10000",t.style.visibility="visible",t.style.opacity="1"}moveAutocompleteToBody(e,t){if(e.closest(".modal")&&t.parentNode!==document.body){document.body.appendChild(t);const a=e.getBoundingClientRect();t.style.position="fixed",t.style.top=a.bottom+window.scrollY+"px",t.style.left=a.left+"px",t.style.width=a.width+"px",t.style.zIndex="10000",t.style.backgroundColor="white",t.style.border="1px solid #ddd",t.style.borderRadius="4px",t.style.boxShadow="0 2px 8px rgba(0,0,0,0.1)",t.style.display="block",t.style.visibility="visible",t.style.opacity="1",t.dataset.originalContainer=e.id}}setupThemeCustomization(){this.loadThemeColors();const e=document.getElementById("gradientColor1"),t=document.getElementById("gradientColor2"),a=document.getElementById("gradientColor1Hex"),s=document.getElementById("gradientColor2Hex"),n=document.getElementById("resetThemeBtn"),o=document.getElementById("saveThemeBtn");e&&e.addEventListener("change",e=>{a.value=e.target.value,this.previewTheme()}),t&&t.addEventListener("change",e=>{s.value=e.target.value,this.previewTheme()}),a&&a.addEventListener("input",t=>{const a=t.target.value;this.isValidHexColor(a)&&(e.value=a,this.previewTheme())}),s&&s.addEventListener("input",e=>{const a=e.target.value;this.isValidHexColor(a)&&(t.value=a,this.previewTheme())}),n&&n.addEventListener("click",()=>{this.resetTheme()}),o&&o.addEventListener("click",()=>{this.saveThemeColors(),this.showThemeMessage("Theme colors saved successfully!","success")})}async loadThemeColors(){try{const e=await fetch("api/theme_api.php"),t=await e.json();if(t.success){const e=t.data.gradient_color_1,a=t.data.gradient_color_2,s=localStorage.getItem("gradientColor1"),n=localStorage.getItem("gradientColor2");s&&n&&(s!==e||n!==a)&&(console.log("localStorage colors differ from server, updating localStorage"),localStorage.setItem("gradientColor1",e),localStorage.setItem("gradientColor2",a)),this.updateColorPickerInputs(e,a),this.applyThemeColors(e,a)}else console.warn("Server theme load failed:",t.message),this.fallbackToLocalStorage()}catch(e){console.warn("Server theme load error:",e),this.fallbackToLocalStorage()}}fallbackToLocalStorage(){const e=localStorage.getItem("gradientColor1")||"#667eea",t=localStorage.getItem("gradientColor2")||"#764ba2";console.log("Falling back to localStorage:",e,t),this.updateColorPickerInputs(e,t),this.applyThemeColors(e,t)}updateColorPickerInputs(e,t){const a=document.getElementById("gradientColor1"),s=document.getElementById("gradientColor1Hex"),n=document.getElementById("gradientColor2"),o=document.getElementById("gradientColor2Hex");a&&s&&n&&o&&(a.value=e,s.value=e,n.value=t,o.value=t)}async saveThemeColors(){const e=document.getElementById("gradientColor1").value,t=document.getElementById("gradientColor2").value;localStorage.setItem("gradientColor1",e),localStorage.setItem("gradientColor2",t),this.applyThemeColors(e,t);try{const a=await fetch("api/theme_api.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({gradient_color_1:e,gradient_color_2:t})}),s=await a.json();s.success||console.warn("Failed to save theme to server:",s.message)}catch(e){console.warn("Failed to save theme to server:",e)}}applyThemeColors(e,t){document.body.style.background=`linear-gradient(135deg, ${e} 0%, ${t} 100%)`}previewTheme(){const e=document.getElementById("gradientColor1").value,t=document.getElementById("gradientColor2").value;this.applyThemeColors(e,t)}resetTheme(){const e="#667eea",t="#764ba2",a=document.getElementById("gradientColor1"),s=document.getElementById("gradientColor1Hex"),n=document.getElementById("gradientColor2"),o=document.getElementById("gradientColor2Hex");a&&s&&n&&o&&(a.value=e,s.value=e,n.value=t,o.value=t,this.applyThemeColors(e,t),this.saveThemeColors())}isValidHexColor(e){return/^#[0-9A-Fa-f]{6}$/.test(e)}showSetupMessage(e,t){const a=document.getElementById("setupMessage");a&&(a.textContent=e,a.className=`modal-message ${t}`,a.style.display="block",setTimeout(()=>{a.style.display="none"},3e3))}showThemeMessage(e,t){const a=document.getElementById("themeMessage");a&&(a.textContent=e,a.className=`modal-message ${t}`,a.style.display="block",setTimeout(()=>{a.style.display="none"},3e3))}async clearAllCaches(){try{if("caches"in window){const e=await caches.keys();await Promise.all(e.map(e=>caches.delete(e)))}localStorage.clear(),sessionStorage.clear(),this.selectedArtist=null,this.selectedAlbum=null,this.selectedCoverUrl=null,this.selectedDiscogsReleaseId=null;const e=new URL(window.location.href);e.searchParams.set("_cache_clear",Date.now()),e.searchParams.set("cache_cleared","true"),window.location.href=e.toString()}catch(e){console.error("Error clearing caches:",e),this.showMessage("Error clearing caches. Please try again.","error")}}handleSort(e){this.currentSort.field===e?this.currentSort.direction="asc"===this.currentSort.direction?"desc":"asc":(this.currentSort.field=e,this.currentSort.direction="asc"),this.updateSortIndicators(),this.renderAlbumsWithSort()}updateSortIndicators(){document.querySelectorAll(".sortable-header").forEach(e=>{e.classList.remove("sort-asc","sort-desc")});const e=document.querySelector(`[data-sort="${this.currentSort.field}"]`);e&&e.classList.add(`sort-${this.currentSort.direction}`)}renderAlbumsWithSort(){const e=document.querySelector("#albumsTable tbody"),t=Array.from(e.querySelectorAll("tr")).map(e=>{if(e.classList.contains("empty-state"))return null;const t=e.querySelector(".artist-name")?.textContent||"",a=e.querySelector(".album-name a")?.textContent||"",s=e.querySelector(".year-link"),n=s?s.dataset.year:"",o="✓"===e.querySelector("td:nth-child(4) .checkmark")?.textContent,l="✓"===e.querySelector("td:nth-child(5) .checkmark")?.textContent;return{id:e.dataset.id,artist_name:t,album_name:a,release_year:n,is_owned:o?1:0,want_to_own:l?1:0,cover_url:e.querySelector(".album-cover")?.dataset.src||"",cover_url_medium:e.querySelector(".album-cover")?.dataset.medium||"",cover_url_large:e.querySelector(".album-cover")?.dataset.large||"",artist_type:e.dataset.artistType||null}}).filter(e=>null!==e),a=this.sortAlbums(t);this.renderAlbums(a)}sortAlbums(e){return e.sort((e,t)=>{const a=e.artist_type||null,s=t.artist_type||null;if("year"===this.currentSort.field){const n=parseInt(e.release_year)||0,o=parseInt(t.release_year)||0;return"desc"===this.currentSort.direction?n!==o?o-n:this.getSortableArtistName(e.artist_name,a).localeCompare(this.getSortableArtistName(t.artist_name,s)):n!==o?n-o:this.getSortableArtistName(e.artist_name,a).localeCompare(this.getSortableArtistName(t.artist_name,s))}if("album"===this.currentSort.field){const n=this.getSortableArtistName(e.artist_name,a).localeCompare(this.getSortableArtistName(t.artist_name,s));if("desc"===this.currentSort.direction){if(0!==n)return-n;const a=parseInt(e.release_year)||0,s=parseInt(t.release_year)||0;return a!==s?a-s:this.getSortableAlbumName(e.album_name).localeCompare(this.getSortableAlbumName(t.album_name))}{if(0!==n)return n;const a=parseInt(e.release_year)||0,s=parseInt(t.release_year)||0;return a!==s?a-s:this.getSortableAlbumName(e.album_name).localeCompare(this.getSortableAlbumName(t.album_name))}}return this.getSortableArtistName(e.artist_name,a).localeCompare(this.getSortableArtistName(t.artist_name,s))})}getSortableArtistName(e,t=null){if(!e)return"";const a=e.trim(),s=a.toLowerCase();if(s.includes("elvis costello")&&s.includes("attractions"))return"Costello, Elvis & The Attractions";const n=["the ","a ","an "];for(const e of n)if(s.startsWith(e))return a.substring(e.length).trim();if(t){if("group"===t.toLowerCase())return a;if("person"===t.toLowerCase()){const e=a.split(" ");if(2===e.length){const t=e[0],a=e[1];return["jr","sr","ii","iii","iv","v","vi","vii","viii","ix","x"].includes(a.toLowerCase())&&e.length>2?e[e.length-2]+", "+e.slice(0,-2).join(" ")+" "+e[e.length-1]:a+", "+t}return a}}const o=a.split(" "),l=["&","and","featuring","feat","ft","with","vs","versus"].some(e=>s.includes(e)),i=o[o.length-1],r=/^\d+$/.test(i);if(!(l||r||o.length>3)&&2===o.length){const e=o[0],t=o[1];return["jr","sr","ii","iii","iv","v","vi","vii","viii","ix","x"].includes(t.toLowerCase())&&o.length>2?o[o.length-2]+", "+o.slice(0,-2).join(" ")+" "+o[o.length-1]:t+", "+e}return a}getSortableAlbumName(e){if(!e)return"";const t=e.trim(),a=t.toLowerCase(),s=["the ","a ","an "];for(const e of s)if(a.startsWith(e))return t.substring(e.length).trim();return t}initDarkMode(){const e=localStorage.getItem("theme")||"light";this.setTheme(e)}toggleDarkMode(){const e="dark"===document.documentElement.getAttribute("data-theme")?"light":"dark";this.setTheme(e)}setTheme(e){document.documentElement.setAttribute("data-theme",e),localStorage.setItem("theme",e),this.updateDarkModeButton(e),this.updateChartColorsForTheme(e)}updateDarkModeButton(e){const t=document.getElementById("darkModeBtn"),a=document.getElementById("darkModeText"),s=document.getElementById("darkModeIcon");t&&a&&s&&("dark"===e?(a.textContent="Light Mode",s.innerHTML='<path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>'):(a.textContent="Dark Mode",s.innerHTML='<path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>'))}updateChartColorsForTheme(e){}}document.addEventListener("DOMContentLoaded",async()=>{window.app=new MusicCollectionApp,await window.app.init()});