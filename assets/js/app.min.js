class MusicCollectionApp{constructor(){this.currentFilter="owned",this.currentSearch="",this.currentStyleFilter="",this.currentFormatFilter="",this.currentYearFilter="",this.currentArtistFilter="",this.currentLabelFilter="",this.currentProducerFilter="",this.consolidatedFormatTypes=null,this.editingAlbum=null,this.autocompleteTimeout=null,this.artistAutocompleteTimeout=null,this.albumAutocompleteTimeout=null,this.isAuthenticated=!1,this.currentSort={field:"artist",direction:"asc"}}async fetchWithCache(e,t={}){const s={cache:"default",headers:{"Content-Type":"application/json",...t.headers}};return fetch(e,{...s,...t})}async init(){this.checkAuthStatus(),this.loadStats(),this.loadAlbums(),this.bindEvents(),this.setupAutocomplete(),await this.loadThemeColors(),setTimeout(async()=>{await this.loadDisplayMode(),await this.loadStatsSettings(),await this.loadSettings()},100),this.startNotificationPolling(),this.initDemoManager(),this.updateSortIndicators(),this.initBackToTop();const e=new URLSearchParams(window.location.search);if("true"===e.get("cache_cleared")){this.showMessage("All caches cleared successfully. Fresh data loaded.","success"),e.delete("cache_cleared"),e.delete("_cache_clear");const t=window.location.pathname+(e.toString()?"?"+e.toString():"");window.history.replaceState({},"",t)}if("required"===e.get("login")){this.showMessage("Please log in to access this feature.","info"),setTimeout(()=>{this.showLoginModal()},1e3),e.delete("login");const t=window.location.pathname+(e.toString()?"?"+e.toString():"");window.history.replaceState({},"",t)}}async checkAuthStatus(){try{const e=await fetch("api/music_api.php?action=auth_status",{cache:"no-cache",headers:{"Content-Type":"application/json"}}),t=await e.json();t.success&&(this.isAuthenticated=t.data.authenticated)}catch(e){this.isAuthenticated=!1}this.updateAuthUI()}updateAuthUI(){const e=document.getElementById("addAlbumBtn"),t=document.getElementById("loginBtn"),s=document.getElementById("logoutBtn"),a=document.getElementById("setupConfigBtn");e&&(this.isAuthenticated?(e.textContent="+ Add Album",e.style.display="block",e.style.opacity="1",e.style.cursor="pointer"):e.style.display="none"),t&&(t.style.display=this.isAuthenticated?"none":"flex"),s&&(s.style.display=this.isAuthenticated?"flex":"none"),a&&(a.style.display=this.isAuthenticated?"flex":"none");const o=document.querySelectorAll(".btn-edit"),n=document.querySelectorAll(".btn-delete");o.forEach(e=>{e.style.display=this.isAuthenticated?"inline-block":"none"}),n.forEach(e=>{e.style.display=this.isAuthenticated?"inline-block":"none"});const i=document.querySelector("th:last-child"),l=document.querySelectorAll("td:last-child");i&&(i.style.display=this.isAuthenticated?"table-cell":"none"),l.forEach(e=>{e.style.display=this.isAuthenticated?"table-cell":"none"});const r=document.getElementById("clearCacheBtn");r&&(r.style.display=this.isAuthenticated?"flex":"none");const d=document.getElementById("setupBtn");d&&(d.style.display=this.isAuthenticated?"flex":"none");const c=document.getElementById("resetPasswordBtn");c&&(c.style.display=this.isAuthenticated?"flex":"none")}bindEvents(){const e=document.getElementById("searchInput"),t=document.getElementById("clearSearch"),s=document.getElementById("searchSubmit");e&&e.addEventListener("input",e=>{this.currentSearch=e.target.value,this.debounceSearch(),t&&(e.target.value.length>0?t.classList.add("visible"):t.classList.remove("visible")),this.handleStyleSearchSuggestions(e.target.value)}),s&&s.addEventListener("click",()=>{this.currentSearch=e.value,this.debounceSearch()}),t&&t.addEventListener("click",()=>{e.value="",this.currentSearch="",this.currentStyleFilter="",this.currentFormatFilter="",this.consolidatedFormatTypes=null,this.currentYearFilter="",this.currentArtistFilter="",this.currentLabelFilter="",this.currentProducerFilter="",e.disabled=!1,this.debounceSearch(),t.classList.remove("visible"),e.focus();const s=document.getElementById("message");s&&s.classList.contains("info")&&s.classList.remove("show"),this.loadStats()});const a=document.getElementById("togglePassword"),o=document.getElementById("password");if(a&&o){const e=a.querySelector(".eye-icon"),t=a.querySelector(".eye-slash-icon");a.addEventListener("click",()=>{const s="password"===o.getAttribute("type")?"text":"password";o.setAttribute("type",s),"text"===s?(e.style.display="none",t.style.display="block"):(e.style.display="block",t.style.display="none")})}[{inputId:"reset_current_password",buttonId:"toggleResetCurrentPassword"},{inputId:"reset_new_password",buttonId:"toggleResetNewPassword"},{inputId:"reset_confirm_password",buttonId:"toggleResetConfirmPassword"}].forEach(e=>{const t=document.getElementById(e.buttonId),s=document.getElementById(e.inputId);if(t&&s){const e=t.querySelector(".eye-icon"),a=t.querySelector(".eye-slash-icon");t.addEventListener("click",()=>{const t="password"===s.getAttribute("type")?"text":"password";s.setAttribute("type",t),"text"===t?(e.style.display="none",a.style.display="block"):(e.style.display="block",a.style.display="none")})}}),document.querySelectorAll(".filter-btn").forEach(e=>{e.addEventListener("click",e=>{this.setFilter(e.target.dataset.filter)})});const n=document.getElementById("addAlbumBtn");n&&n.addEventListener("click",()=>{this.showModal()});const i=document.getElementById("viewRecordBtn");i&&i.addEventListener("click",()=>{this.showViewRecordModal()});const l=document.querySelector("#viewRecordModal .close");l&&l.addEventListener("click",()=>{this.hideViewRecordModal()});const r=document.querySelector("#viewRecordModal .btn-cancel");r&&r.addEventListener("click",()=>{this.hideViewRecordModal()});const d=document.getElementById("viewRecordCloseBtn");d&&d.addEventListener("click",()=>{this.hideViewRecordModal()});const c=document.getElementById("editRecordBtn");c&&c.addEventListener("click",()=>{this.enableRecordEditing()});const u=document.getElementById("saveRecordBtn");u&&u.addEventListener("click",()=>{this.saveRecordChanges()});const h=document.getElementById("cancelEditBtn");h&&h.addEventListener("click",()=>{this.cancelRecordEditing()});const m=document.getElementById("clearCacheBtn");m&&m.addEventListener("click",()=>{this.clearAllCaches()});const p=document.getElementById("albumModal");p&&p.addEventListener("click",e=>{"albumModal"===e.target.id&&this.hideModal()});const y=document.getElementById("coverModal");y&&y.addEventListener("click",e=>{"coverModal"===e.target.id&&this.hideCoverModal()});const g=document.getElementById("tracklistModal");g&&g.addEventListener("click",e=>{"tracklistModal"===e.target.id&&this.hideTracklistModal()});const b=document.getElementById("tracklistModalCover");b&&b.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();const t=document.getElementById("tracklistModal"),s=document.getElementById("tracklistModalCover");if(t&&s&&s.src&&s.src!==window.location.href){const e=t.dataset.artistName||"",a=t.dataset.albumName||"",o=t.dataset.releaseYear||"",n=s.src,i=t.dataset.albumId||null;this.hideTracklistModal(),this.showCoverModal(e,a,o,n,i)}});const w=document.getElementById("tracklistEditBtn");w&&w.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.handleTracklistEdit()}),document.querySelectorAll(".close").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation();const s=e.closest(".modal");s&&("albumModal"===s.id?this.hideModal():"coverModal"===s.id?this.hideCoverModal():"tracklistModal"===s.id?this.hideTracklistModal():"loginModal"===s.id?this.hideLoginModal():"statsModal"===s.id?this.hideStatsModal():"resetPasswordModal"===s.id?this.hideResetPasswordModal():"setupModal"===s.id?this.hideSetupModal():"viewRecordModal"===s.id&&this.hideViewRecordModal())}),e.addEventListener("touchend",t=>{t.preventDefault(),t.stopPropagation();const s=e.closest(".modal");s&&("albumModal"===s.id?this.hideModal():"coverModal"===s.id?this.hideCoverModal():"tracklistModal"===s.id?this.hideTracklistModal():"loginModal"===s.id?this.hideLoginModal():"statsModal"===s.id?this.hideStatsModal():"resetPasswordModal"===s.id?this.hideResetPasswordModal():"setupModal"===s.id?this.hideSetupModal():"viewRecordModal"===s.id&&this.hideViewRecordModal())})});const v=document.getElementById("loginModal");v&&v.addEventListener("click",e=>{"loginModal"===e.target.id&&this.hideLoginModal()});const f=document.getElementById("loginForm");f&&f.addEventListener("submit",e=>{e.preventDefault(),this.handleLogin(e)});const E=document.querySelector("#loginModal .btn-cancel");E&&E.addEventListener("click",()=>{this.hideLoginModal()});const S=document.getElementById("statsModal");S&&S.addEventListener("click",e=>{"statsModal"===e.target.id&&this.hideStatsModal()});const _=document.querySelector("#statsModal .btn-cancel");_&&_.addEventListener("click",()=>{this.hideStatsModal()});const B=document.getElementById("resetPasswordModal");B&&B.addEventListener("click",e=>{"resetPasswordModal"===e.target.id&&this.hideResetPasswordModal()});const I=document.getElementById("resetPasswordForm");I&&I.addEventListener("submit",e=>{e.preventDefault(),this.handleResetPassword(e)});const k=document.querySelector("#resetPasswordModal .btn-cancel");k&&k.addEventListener("click",()=>{this.hideResetPasswordModal()});const C=document.querySelector("#resetPasswordModal .close");C&&C.addEventListener("click",()=>{this.hideResetPasswordModal()});const L=document.getElementById("setupModal");L&&L.addEventListener("click",e=>{"setupModal"===e.target.id&&this.hideSetupModal()});const M=document.getElementById("setupForm");M&&M.addEventListener("submit",e=>{e.preventDefault(),this.handleSetupConfig(e)});const A=document.querySelector("#setupModal .btn-cancel");A&&A.addEventListener("click",()=>{this.hideSetupModal()});const F=document.querySelector("#setupModal .close");F&&F.addEventListener("click",()=>{this.hideSetupModal()});const T=document.getElementById("setupPasswordBtn");T&&T.addEventListener("click",()=>{this.hideSetupModal(),this.showResetPasswordModal()});const x=document.getElementById("albumsTable");x&&x.addEventListener("click",e=>{if(e.target.classList.contains("album-cover")){const t=e.target.dataset.artist,s=e.target.dataset.album,a=e.target.dataset.year,o=e.target.dataset.cover,n=e.target.closest("tr").dataset.id;this.showCoverModal(t,s,a,o,n)}if(e.target.classList.contains("album-link")){e.preventDefault();const t=e.target.dataset.artist,s=e.target.dataset.album,a=e.target.dataset.year,o=e.target.closest("tr").dataset.id;this.showTracklist(t,s,a,o)}if(e.target.classList.contains("artist-link")){e.preventDefault();const t=e.target.dataset.artist;t&&this.filterByArtist(t)}if(e.target.classList.contains("year-link")||e.target.closest(".year-link")){e.preventDefault();const t=(e.target.classList.contains("year-link")?e.target:e.target.closest(".year-link")).dataset.year;t&&this.filterByYear(t)}if(e.target.classList.contains("btn-edit")){const t=e.target.dataset.id;t&&this.editAlbum(parseInt(t))}if(e.target.classList.contains("btn-delete")){const t=e.target.dataset.id;t&&this.deleteAlbum(parseInt(t))}});const $=document.getElementById("albumForm");$&&$.addEventListener("submit",e=>{e.preventDefault(),this.saveAlbum()});const D=document.getElementById("releaseYear"),P=document.getElementById("albumFormat");D&&(D.addEventListener("input",()=>{this.updateSaveButtonState()}),D.addEventListener("change",()=>{this.updateSaveButtonState()})),P&&(P.addEventListener("input",()=>{this.updateSaveButtonState()}),P.addEventListener("change",()=>{this.updateSaveButtonState()})),document.getElementById("cancelBtn").addEventListener("click",()=>{this.hideModal()}),document.querySelectorAll(".sortable-header").forEach(e=>{e.addEventListener("click",e=>{const t=e.currentTarget.dataset.sort;this.handleSort(t)})})}setupAutocomplete(){const e=document.getElementById("artistName"),t=document.getElementById("albumName");this.updateAlbumInputState(),e.addEventListener("input",e=>{this.debounceArtistAutocomplete(e.target.value),this.updateAlbumInputState()}),t.addEventListener("input",t=>{const s=e.value.trim();s&&s.length>0?this.debounceAlbumAutocomplete(s,t.target.value):this.hideAutocomplete("albumAutocomplete")}),e.addEventListener("input",e=>{e.target.value.trim()||(this.hideAutocomplete("albumAutocomplete"),t.value="",this.updateAlbumInputState())}),e.addEventListener("blur",e=>{setTimeout(()=>{this.hideAutocomplete("artistAutocomplete")},500)}),t.addEventListener("blur",e=>{setTimeout(()=>{this.hideAutocomplete("albumAutocomplete")},500)}),document.addEventListener("click",e=>{e.target.closest(".autocomplete-container")||(this.hideAutocomplete("artistAutocomplete"),this.hideAutocomplete("albumAutocomplete"))});const s=document.getElementById("formatFilter");s&&s.addEventListener("change",s=>{const a=e.value.trim(),o=t.value.trim();a&&o&&o.length>=2&&this.debounceAlbumAutocomplete(a,o)}),this.setupDropdown()}setupDropdown(){const e=document.querySelector(".dropdown"),t=document.querySelector(".dropdown-menu"),s=document.querySelector(".dropdown-toggle");e&&t&&s&&(s.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),e.classList.toggle("active")}),t.addEventListener("click",e=>{e.stopPropagation()}),document.addEventListener("click",t=>{e.contains(t.target)||e.classList.remove("active")}),e.addEventListener("keydown",t=>{"Escape"===t.key&&(e.classList.remove("active"),e.querySelector(".dropdown-toggle").blur())}))}updateAlbumInputState(){const e=document.getElementById("artistName"),t=document.getElementById("albumName");if(e&&t){const s=e.value.trim();s&&s.length>0?(t.disabled=!1,t.placeholder="Enter album name..."):(t.disabled=!0,t.placeholder="Select an artist first...")}this.updateSaveButtonState()}updateSaveButtonState(){const e=document.querySelector("#albumForm .btn-save"),t=document.getElementById("releaseYear"),s=document.getElementById("albumFormat");if(e&&t&&s){const a=""!==t.value.trim(),o=""!==s.value.trim();a&&o?(e.disabled=!1,e.style.opacity="1",e.style.cursor="pointer"):(e.disabled=!0,e.style.opacity="0.5",e.style.cursor="not-allowed")}}debounceArtistAutocomplete(e){clearTimeout(this.artistAutocompleteTimeout),this.artistAutocompleteTimeout=setTimeout(()=>{this.handleArtistAutocomplete(e)},300)}debounceAlbumAutocomplete(e,t){clearTimeout(this.albumAutocompleteTimeout),this.albumAutocompleteTimeout=setTimeout(()=>{this.handleAlbumAutocomplete(e,t)},300)}async handleArtistAutocomplete(e){if(e.length<2)this.hideAutocomplete("artistAutocomplete");else{this.showAutocompleteLoading("artistAutocomplete");try{const t=`api/music_api.php?action=artists&search=${encodeURIComponent(e)}`,s=await this.fetchWithCache(t),a=await s.json();a.success?this.showAutocomplete("artistAutocomplete",a.data,"artist_name"):this.hideAutocomplete("artistAutocomplete")}catch(e){this.hideAutocomplete("artistAutocomplete")}}}async handleAlbumAutocomplete(e,t){if(t.length<2)this.hideAutocomplete("albumAutocomplete");else{this.showAutocompleteLoading("albumAutocomplete");try{const s=document.getElementById("formatFilter")?.value||"";let a=`api/music_api.php?action=albums_by_artist&artist=${encodeURIComponent(e)}&search=${encodeURIComponent(t)}`;s&&(a+=`&format=${encodeURIComponent(s)}`);const o=await this.fetchWithCache(a),n=await o.json();n.success?this.showAutocomplete("albumAutocomplete",n.data,"album_name"):this.hideAutocomplete("albumAutocomplete")}catch(e){this.hideAutocomplete("albumAutocomplete")}}}showAutocomplete(e,t,s){const a=document.getElementById(e);let o=a.querySelector(".autocomplete-list");o||(o=document.querySelector(`[data-original-container="${e}"]`)),o&&(o.innerHTML="",t.forEach(t=>{if(t&&t[s]&&"undefined"!==t[s]){const a=document.createElement("div");a.className="autocomplete-item";const n=document.createElement("span");if("album_name"===s&&t.year?n.textContent=`${t[s]} (${t.year})`:n.textContent=t[s],"album_name"===s&&t.format&&(n.innerHTML=n.textContent+'<br><span class="format-text">'+t.format+"</span>"),a.appendChild(n),t.cover_url){const e=document.createElement("img");e.src=t.cover_url,e.className="autocomplete-cover",e.alt="Album cover",e.onerror=()=>{e.remove()},e.onload=()=>{},a.appendChild(e)}a.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation(),this.selectAutocompleteItem(e,t[s],t)}),o.appendChild(a)}}),o.children.length>0?(o.style.display="block",o.style.visibility="visible",o.style.opacity="1",o.style.zIndex="10000",o.style.position="absolute",o.style.border="1px solid #ddd",o.style.borderRadius="4px",o.style.boxShadow="0 2px 8px rgba(0,0,0,0.1)",o.style.maxHeight="1200px",o.style.overflowY="auto",this.adjustAutocompletePosition(a,o),setTimeout(()=>{this.adjustAutocompletePosition(a,o)},10)):o.style.display="none")}showAutocompleteLoading(e){let t=document.getElementById(e).querySelector(".autocomplete-list");t||(t=document.querySelector(`[data-original-container="${e}"]`)),t&&(t.innerHTML='<div class="autocomplete-loading">Searching...</div>',t.style.display="block")}hideAutocomplete(e){let t=document.getElementById(e).querySelector(".autocomplete-list");if(t||(t=document.querySelector(`[data-original-container="${e}"]`)),t&&(t.style.display="none",t.style.visibility="hidden",t.style.opacity="0",t.parentNode===document.body&&t.dataset.originalContainer)){const e=document.getElementById(t.dataset.originalContainer);e&&(e.appendChild(t),t.style.position="",t.style.top="",t.style.left="",t.style.width="",t.style.zIndex="",delete t.dataset.originalContainer)}}selectAutocompleteItem(e,t,s=null){const a=document.getElementById(e).querySelector("input");if(a&&(a.value=t,s))if("artistAutocomplete"===e)this.selectedArtist=s;else if("albumAutocomplete"===e){this.selectedAlbum=s,this.selectedDiscogsReleaseId=s.id||null,this.selectedCoverUrl=s.cover_url||null;const e=document.getElementById("releaseYear");e&&(s.master_year?e.value=s.master_year:s.id?(e.value="",this.fetchMasterYearForSelection(s.id,e,s.year)):e.value=s.year||"");const t=document.getElementById("albumFormat");t&&s.format&&(t.value=s.format,t.readOnly=!1),this.updateSaveButtonState()}this.hideAutocomplete(e)}debounceSearch(){clearTimeout(this.autocompleteTimeout),this.autocompleteTimeout=setTimeout(()=>{this.loadAlbums()},300)}setFilter(e){this.currentFilter=e,document.querySelectorAll(".filter-btn").forEach(e=>{e.classList.remove("active")}),document.querySelector(`[data-filter="${e}"]`).classList.add("active"),this.loadAlbums()}initBackToTop(){const e=document.getElementById("backToTopBtn");if(!e)return;const t=()=>{window.pageYOffset>300?e.classList.add("visible"):e.classList.remove("visible")};window.addEventListener("scroll",t),e.addEventListener("click",()=>{if("ontouchstart"in window||navigator.maxTouchPoints>0)try{window.scrollTo(0,0),document.body&&document.body.scrollTop>0&&(document.body.scrollTop=0),document.documentElement&&document.documentElement.scrollTop>0&&(document.documentElement.scrollTop=0);const e=document.querySelector(".content-with-sidebar");e&&e.scrollTop>0&&(e.scrollTop=0);let t=document.activeElement;for(;t&&t!==document.body;)t.scrollTop>0&&(t.scrollTop=0),t=t.parentElement}catch(e){window.scrollTo(0,0)}else window.scrollTo({top:0,behavior:"smooth"})}),t()}filterByStyle(e){this.hideStatsModal(),this.currentArtistFilter="",this.currentYearFilter="",this.currentFormatFilter="",this.consolidatedFormatTypes=null,this.currentLabelFilter="",this.currentProducerFilter="",this.currentSearch="",this.currentStyleFilter=e;const t=this.currentFilter;this.currentFilter="all";const s=document.getElementById("searchInput"),a=document.getElementById("clearSearch");s&&(s.value=this.buildFilterText(),s.disabled=!0,a.classList.add("visible")),this.showMessage(`Filtering by style: ${e}`,"info"),this.loadAlbums(),this.currentFilter=t}buildFilterText(){const e=[];return this.currentArtistFilter&&e.push(`Artist: ${this.currentArtistFilter}`),this.currentYearFilter&&e.push(`Year: ${this.currentYearFilter}`),this.currentStyleFilter&&e.push(`Style: ${this.currentStyleFilter}`),this.currentFormatFilter&&e.push(`Format: ${this.currentFormatFilter}`),this.currentLabelFilter&&e.push(`Label: ${this.currentLabelFilter}`),this.currentProducerFilter&&e.push(`Producer: ${this.currentProducerFilter}`),e.join("; ")}filterByArtist(e){this.hideStatsModal(),this.currentYearFilter="",this.currentStyleFilter="",this.currentFormatFilter="",this.consolidatedFormatTypes=null,this.currentLabelFilter="",this.currentProducerFilter="",this.currentSearch="",this.currentArtistFilter=e;const t=this.currentFilter;this.currentFilter="all";const s=document.getElementById("searchInput"),a=document.getElementById("clearSearch");s&&(s.value=this.buildFilterText(),s.disabled=!0,a.classList.add("visible")),this.showMessage(`Filtering by artist: ${e}`,"info"),this.loadAlbums(),this.currentFilter=t}filterByFormat(e){this.hideStatsModal(),this.currentArtistFilter="",this.currentYearFilter="",this.currentStyleFilter="",this.consolidatedFormatTypes=null,this.currentLabelFilter="",this.currentProducerFilter="",this.currentSearch="",this.currentFormatFilter=e;const t=this.currentFilter;this.currentFilter="all";const s=document.getElementById("searchInput"),a=document.getElementById("clearSearch");s&&(s.value=this.buildFilterText(),s.disabled=!0,a.classList.add("visible")),this.showMessage(`Filtering by format: ${e}`,"info"),this.loadAlbums(),this.currentFilter=t}filterByLabel(e){this.hideStatsModal(),this.currentArtistFilter="",this.currentYearFilter="",this.currentStyleFilter="",this.currentFormatFilter="",this.consolidatedFormatTypes=null,this.currentProducerFilter="",this.currentSearch="",this.currentLabelFilter=e;const t=this.currentFilter;this.currentFilter="all";const s=document.getElementById("searchInput"),a=document.getElementById("clearSearch");s&&(s.value=this.buildFilterText(),s.disabled=!0,a.classList.add("visible")),this.showMessage(`Filtering by label: ${e}`,"info"),this.loadAlbums(),this.currentFilter=t}filterByProducer(e){this.hideStatsModal(),this.currentArtistFilter="",this.currentYearFilter="",this.currentStyleFilter="",this.currentFormatFilter="",this.consolidatedFormatTypes=null,this.currentLabelFilter="",this.currentSearch="",this.currentProducerFilter=e;const t=this.currentFilter;this.currentFilter="all";const s=document.getElementById("searchInput"),a=document.getElementById("clearSearch");s&&(s.value=this.buildFilterText(),s.disabled=!0,a.classList.add("visible")),this.showMessage(`Filtering by producer: ${e}`,"info"),this.loadAlbums(),this.currentFilter=t}filterByConsolidatedFormat(e,t){this.hideStatsModal(),this.currentArtistFilter="",this.currentYearFilter="",this.currentStyleFilter="",this.currentLabelFilter="",this.currentProducerFilter="",this.currentSearch="",this.currentFormatFilter=t,this.consolidatedFormatTypes=e;const s=this.currentFilter;this.currentFilter="all";const a=document.getElementById("searchInput"),o=document.getElementById("clearSearch");a&&(a.value=this.buildFilterText(),a.disabled=!0,o.classList.add("visible")),this.showMessage(`Filtering by format: ${t}`,"info"),this.loadAlbums(),this.currentFilter=s}clearStyleFilter(){this.currentStyleFilter="",this.currentFormatFilter="",this.consolidatedFormatTypes=null,this.currentYearFilter="",this.currentArtistFilter="",this.currentLabelFilter="",this.currentProducerFilter="";const e=document.getElementById("searchInput");e&&(e.value="",e.disabled=!1),this.loadAlbums()}clearFormatFilter(){this.currentFormatFilter="",this.consolidatedFormatTypes=null,this.currentStyleFilter="",this.currentYearFilter="",this.currentArtistFilter="",this.currentLabelFilter="",this.currentProducerFilter="";const e=document.getElementById("searchInput");e&&(e.value="",e.disabled=!1),this.loadAlbums()}filterByYear(e){this.hideStatsModal(),this.currentArtistFilter="",this.currentStyleFilter="",this.currentFormatFilter="",this.consolidatedFormatTypes=null,this.currentLabelFilter="",this.currentProducerFilter="",this.currentSearch="",this.currentYearFilter=e;const t=this.currentFilter;this.currentFilter="all";const s=document.getElementById("searchInput"),a=document.getElementById("clearSearch");s&&(s.value=this.buildFilterText(),s.disabled=!0,a.classList.add("visible")),this.showMessage(`Filtering by year: ${e}`,"info"),this.loadAlbums(),this.currentFilter=t}clearYearFilter(){this.currentYearFilter="",this.currentStyleFilter="",this.currentFormatFilter="",this.consolidatedFormatTypes=null,this.currentArtistFilter="",this.currentLabelFilter="",this.currentProducerFilter="";const e=document.getElementById("searchInput");e&&(e.value="",e.disabled=!1),this.loadAlbums()}handleStyleSearchSuggestions(e){const t=e.toLowerCase();if(t.startsWith("style:")||t.startsWith("genre:")||t.startsWith("type:")){const t=e.replace(/^(style|genre|type):\s*/i,"").trim();if(""===t)this.showMessage('Type a style name after "style:" (e.g., style: rock, style: jazz)',"info");else if(t.length>0){const e=document.getElementById("message");e&&e.classList.contains("info")&&e.classList.remove("show")}}}async loadStats(){try{const e=await fetch("api/music_api.php?action=stats"),t=await e.json();t.success&&this.updateStats(t.data)}catch(e){}}updateStats(e){const t=document.querySelector('[data-filter="owned"]'),s=document.querySelector('[data-filter="wanted"]'),a=document.querySelector('[data-filter="all"]'),o=this.getStatsSettings();if(t){const s=e.owned_count||0;o.show_owned_albums?t.textContent=`${s} Owned`:t.textContent="Owned"}if(s){const t=e.wanted_count||0;o.show_wanted_albums?s.textContent=`${t} Want`:s.textContent="Want"}if(a){const t=e.total_albums||0;o.show_total_albums?a.textContent=`${t} Total`:a.textContent="Total"}this.updateFooterStats(e);const n=document.getElementById("styleStatsList");if(n&&e.style_counts){const t=Object.entries(e.style_counts);if(t.length>0){const e=t;n.innerHTML=e.map(([e,t])=>`\n                  <div class="style-stat-item" data-style="${this.escapeHtml(e)}">\n                      <span class="style-name">${this.escapeHtml(e)}</span>\n                      <span class="style-count">${t}</span>\n                  </div>\n              `).join(""),n.querySelectorAll(".style-stat-item").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const s=e.dataset.style;this.filterByStyle(s)})})}else n.innerHTML='<p class="no-styles">No style information available</p>'}const i=document.getElementById("formatStatsList");if(i&&e.format_counts){const t=Object.entries(e.format_counts);if(t.length>0){const e=t;i.innerHTML=e.map(([e,t])=>`\n                  <div class="format-stat-item" data-format="${encodeURIComponent(e)}">\n                      <span class="format-name">${this.escapeHtml(e)}</span>\n                      <span class="format-count">${t}</span>\n                  </div>\n              `).join(""),i.querySelectorAll(".format-stat-item").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const s=decodeURIComponent(e.dataset.format);this.filterByFormat(s)})})}else i.innerHTML='<p class="no-formats">No format information available</p>'}const l=document.getElementById("labelStatsList");if(l&&e.label_counts){const t=Object.entries(e.label_counts);if(t.length>0){t.sort((e,t)=>{const s=t[1]-e[1];return 0!==s?s:e[0].localeCompare(t[0])});const e=t.slice(0,10);l.innerHTML=e.map(([e,t])=>{const s=this.cleanDiscogsNumbering(e);return`\n                      <div class="label-stat-item" data-label="${encodeURIComponent(e)}">\n                          <span class="label-name">${this.escapeHtml(s)}</span>\n                          <span class="label-count">${t}</span>\n                      </div>\n                  `}).join(""),l.querySelectorAll(".label-stat-item").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const s=decodeURIComponent(e.dataset.label);this.filterByLabel(s)})})}else l.innerHTML='<p class="no-labels">No label information available</p>'}const r=document.getElementById("yearStatsList");if(r&&e.year_counts){const t=Object.entries(e.year_counts);t.sort((e,t)=>{const s=t[1]-e[1];return 0!==s?s:t[0]-e[0]}),t.length>0?(r.innerHTML=t.map(([e,t])=>`\n                  <div class="year-stat-item" data-year="${e}">\n                      <span class="year-name">${this.escapeHtml(e)}</span>\n                      <span class="year-count">${t}</span>\n                  </div>\n              `).join(""),r.querySelectorAll(".year-stat-item").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const s=e.dataset.year;this.filterByYear(s)})})):r.innerHTML='<p class="no-years">No year information available</p>'}this.updateChartDisplay(),this.updateModalDisplay()}updateFooterStats(e){if("undefined"==typeof Chart)return void setTimeout(()=>this.updateFooterStats(e),100);document.getElementById("footerStats")&&(this.createFooterYearChart(e.year_counts,e.total_albums),this.createFooterStyleChart(e.style_counts,e.total_albums),this.createFooterFormatChart(e.format_counts,e.total_albums),this.createFooterLabelChart(e.label_counts,e.total_albums));document.getElementById("sidebarStats")&&(this.createSidebarYearChart(e.year_counts,e.total_albums),this.createSidebarStyleChart(e.style_counts,e.total_albums),this.createSidebarFormatChart(e.format_counts,e.total_albums),this.createSidebarLabelChart(e.label_counts,e.total_albums))}createFooterYearChart(e,t){const s=document.getElementById("footerYearChart");if(!s||!e)return;const a=Object.entries(e);a.sort((e,t)=>{const s=t[1]-e[1];return 0!==s?s:t[0]-e[0]});const o=a.slice(0,10),n=t||a.reduce((e,[,t])=>e+t,0);if(0===o.length)return void(s.innerHTML='<p class="no-data">No year data available</p>');s.innerHTML='<canvas id="yearBarChart" width="200" height="500"></canvas>';const i=document.getElementById("yearBarChart").getContext("2d"),l=Math.max(...o.map(([,e])=>e));new Chart(i,{type:"bar",data:{labels:o.map(([e])=>String(e)),datasets:[{data:o.map(([,e])=>e),backgroundColor:"#38BA6A",borderWidth:0,borderRadius:4}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:10,bottom:10}},plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(e){const t=(e.parsed.x/n*100).toFixed(1);return`${e.label}: ${e.parsed.x} (${t}%)`}}}},scales:{x:{beginAtZero:!0,max:l,ticks:{stepSize:1,color:"rgba(255, 255, 255, 0.8)"},grid:{color:"rgba(255, 255, 255, 0.1)"}},y:{ticks:{color:"rgba(255, 255, 255, 0.8)",maxTicksLimit:10},grid:{display:!1},categoryPercentage:.6,barPercentage:.8}},onClick:(e,t)=>{if(t.length>0){const e=t[0].index,s=o[e][0];this.filterByYear(s)}},onHover:(e,t)=>{e.native.target.style.cursor=t.length>0?"pointer":"default"}}})}createFooterStyleChart(e,t){const s=document.getElementById("footerStyleChart");if(!s||!e)return;const a=Object.entries(e);a.sort((e,t)=>t[1]-e[1]);const o=a.slice(0,10),n=t||a.reduce((e,[,t])=>e+t,0);if(0===o.length)return void(s.innerHTML='<p class="no-data">No style data available</p>');s.innerHTML='<canvas id="stylePieChart" width="300" height="300"></canvas>';const i=document.getElementById("stylePieChart").getContext("2d");new Chart(i,{type:"pie",data:{labels:o.map(([e])=>e),datasets:[{data:o.map(([,e])=>e),backgroundColor:["#38BA6A","#E9C46A","#EB8244","#309BF1","#E83DB4","#2BBBAD","#F94144","#90BE6D","#F896D8","#577590"],borderWidth:0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{position:"average",intersect:!1,callbacks:{label:function(e){const t=(e.parsed/n*100).toFixed(1);return`${e.label}: ${e.parsed} (${t}%)`}}}},layout:{padding:{top:20,bottom:20,left:20,right:20}},onClick:(e,t)=>{if(t.length>0){const e=t[0].index,s=o[e][0];this.filterByStyle(s)}},onHover:(e,t)=>{e.native.target.style.cursor=t.length>0?"pointer":"default"}}})}createFooterFormatChart(e,t){const s=document.getElementById("footerFormatChart");if(!s||!e)return;const a={};Object.entries(e).forEach(([e,t])=>{["stereo","vinyl"].includes(e.toLowerCase())||(["lp","album","reissue","remastered","repress"].includes(e.toLowerCase())?a.LP?a.LP+=t:a.LP=t:["single","maxi-single"].includes(e.toLowerCase())?a.Single?a.Single+=t:a.Single=t:a[e]=t)});const o=Object.entries(a);o.sort((e,t)=>t[1]-e[1]);const n=o.slice(0,10);t||o.reduce((e,[,t])=>e+t,0);if(0===n.length)return void(s.innerHTML='<p class="no-data">No format data available</p>');s.innerHTML='<canvas id="formatPieChart" width="300" height="300"></canvas>';const i=document.getElementById("formatPieChart").getContext("2d");new Chart(i,{type:"pie",data:{labels:n.map(([e])=>e),datasets:[{data:n.map(([,e])=>e),backgroundColor:["#38BA6A","#38BA6A","#E9C46A","#EB8244","#309BF1","#E83DB4","#2BBBAD","#F94144","#90BE6D","#F896D8","#577590"],borderWidth:0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{position:"average",intersect:!1,callbacks:{label:function(e){const t=n.reduce((e,[,t])=>e+t,0),s=(e.parsed/t*100).toFixed(1);return`${e.label}: ${s}%`}}}},layout:{padding:{top:20,bottom:20,left:20,right:20}},onClick:(e,t)=>{if(t.length>0){const e=t[0].index,s=n[e][0];"LP"===s?this.filterByConsolidatedFormat(["LP","Album","Reissue","Remastered","Repress"],"LP"):"Single"===s?this.filterByConsolidatedFormat(["Single","Maxi-Single"],"Single"):this.filterByFormat(s)}},onHover:(e,t)=>{e.native.target.style.cursor=t.length>0?"pointer":"default"}}})}createSidebarYearChart(e,t){const s=document.getElementById("sidebarYearChart");if(!s||!e)return;const a=Object.entries(e);a.sort((e,t)=>{const s=t[1]-e[1];return 0!==s?s:t[0]-e[0]});const o=a.slice(0,10),n=t||a.reduce((e,[,t])=>e+t,0);if(0===o.length)return void(s.innerHTML='<p class="no-data">No year data available</p>');s.innerHTML='<canvas id="sidebarYearBarChart" width="200" height="500"></canvas>';const i=document.getElementById("sidebarYearBarChart").getContext("2d"),l=Math.max(...o.map(([,e])=>e));new Chart(i,{type:"bar",data:{labels:o.map(([e])=>String(e)),datasets:[{data:o.map(([,e])=>e),backgroundColor:"#38BA6A",borderWidth:0,borderRadius:4}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:10,bottom:10}},scales:{x:{beginAtZero:!0,max:l,ticks:{stepSize:1,color:"rgba(255, 255, 255, 0.8)"},grid:{color:"rgba(255, 255, 255, 0.1)"}},y:{ticks:{color:"rgba(255, 255, 255, 0.8)",maxTicksLimit:10},grid:{display:!1}}},plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(e){const t=(e.parsed.x/n*100).toFixed(1);return`${e.label}: ${e.parsed.x} (${t}%)`}}}},scales:{x:{beginAtZero:!0,max:l,ticks:{stepSize:1,color:"rgba(255, 255, 255, 0.8)"},grid:{color:"rgba(255, 255, 255, 0.1)"}},y:{ticks:{color:"rgba(255, 255, 255, 0.8)",maxTicksLimit:10},grid:{display:!1},categoryPercentage:.6,barPercentage:.8}},onClick:(e,t)=>{if(t.length>0){const e=t[0].index,s=o[e][0];this.filterByYear(s)}},onHover:(e,t)=>{e.native.target.style.cursor=t.length>0?"pointer":"default"}}})}createSidebarStyleChart(e,t){const s=document.getElementById("sidebarStyleChart");if(!s||!e)return;const a=Object.entries(e);a.sort((e,t)=>t[1]-e[1]);const o=a.slice(0,10),n=t||a.reduce((e,[,t])=>e+t,0);if(0===o.length)return void(s.innerHTML='<p class="no-data">No style data available</p>');s.innerHTML='<canvas id="sidebarStylePieChart" width="300" height="300"></canvas>';const i=document.getElementById("sidebarStylePieChart").getContext("2d");new Chart(i,{type:"pie",data:{labels:o.map(([e])=>e),datasets:[{data:o.map(([,e])=>e),backgroundColor:["#38BA6A","#E9C46A","#EB8244","#309BF1","#E83DB4","#2BBBAD","#F94144","#90BE6D","#F896D8","#577590"],borderWidth:0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{position:"average",intersect:!1,callbacks:{label:function(e){const t=(e.parsed/n*100).toFixed(1);return`${e.label}: ${e.parsed} (${t}%)`}}}},layout:{padding:{top:20,bottom:20,left:20,right:20}},onClick:(e,t)=>{if(t.length>0){const e=t[0].index,s=o[e][0];this.filterByStyle(s)}},onHover:(e,t)=>{e.native.target.style.cursor=t.length>0?"pointer":"default"}}})}createSidebarFormatChart(e,t){const s=document.getElementById("sidebarFormatChart");if(!s||!e)return;const a={};Object.entries(e).forEach(([e,t])=>{["stereo","vinyl"].includes(e.toLowerCase())||(["lp","album","reissue","remastered","repress"].includes(e.toLowerCase())?a.LP?a.LP+=t:a.LP=t:["single","maxi-single"].includes(e.toLowerCase())?a.Single?a.Single+=t:a.Single=t:a[e]=t)});const o=Object.entries(a);o.sort((e,t)=>t[1]-e[1]);const n=o.slice(0,10);t||o.reduce((e,[,t])=>e+t,0);if(0===n.length)return void(s.innerHTML='<p class="no-data">No format data available</p>');s.innerHTML='<canvas id="sidebarFormatPieChart" width="300" height="300"></canvas>';const i=document.getElementById("sidebarFormatPieChart").getContext("2d");new Chart(i,{type:"pie",data:{labels:n.map(([e])=>e),datasets:[{data:n.map(([,e])=>e),backgroundColor:["#38BA6A","#E9C46A","#EB8244","#309BF1","#E83DB4","#2BBBAD","#F94144","#90BE6D","#F896D8","#577590"],borderWidth:0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{position:"average",intersect:!1,callbacks:{label:function(e){const t=n.reduce((e,[,t])=>e+t,0),s=(e.parsed/t*100).toFixed(1);return`${e.label}: ${s}%`}}}},layout:{padding:{top:20,bottom:20,left:20,right:20}},onClick:(e,t)=>{if(t.length>0){const e=t[0].index,s=n[e][0];"LP"===s?this.filterByConsolidatedFormat(["LP","Album","Reissue","Remastered","Repress"],"LP"):"Single"===s?this.filterByConsolidatedFormat(["Single","Maxi-Single"],"Single"):this.filterByFormat(s)}},onHover:(e,t)=>{e.native.target.style.cursor=t.length>0?"pointer":"default"}}})}createFooterLabelChart(e,t){const s=document.getElementById("footerLabelChart");if(!s||!e)return;const a=Object.entries(e);a.sort((e,t)=>t[1]-e[1]);const o=a.slice(0,10),n=t||a.reduce((e,[,t])=>e+t,0);if(0===o.length)return void(s.innerHTML='<p class="no-data">No label data available</p>');s.innerHTML='<canvas id="labelPieChart" width="300" height="300"></canvas>';const i=document.getElementById("labelPieChart").getContext("2d");new Chart(i,{type:"pie",data:{labels:o.map(([e])=>this.cleanDiscogsNumbering(e)),datasets:[{data:o.map(([,e])=>e),backgroundColor:["#38BA6A","#E9C46A","#EB8244","#309BF1","#E83DB4","#2BBBAD","#F94144","#90BE6D","#F896D8","#577590"],borderWidth:0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{position:"average",intersect:!1,callbacks:{label:function(e){const t=(e.parsed/n*100).toFixed(1);return`${e.label}: ${e.parsed} (${t}%)`}}}},layout:{padding:{top:20,bottom:20,left:20,right:20}},onClick:(e,t)=>{if(t.length>0){const e=t[0].index,s=o[e][0];this.filterByLabel(s)}},onHover:(e,t)=>{e.native.target.style.cursor=t.length>0?"pointer":"default"}}})}createSidebarLabelChart(e,t){const s=document.getElementById("sidebarLabelChart");if(!s||!e)return;const a=Object.entries(e);a.sort((e,t)=>t[1]-e[1]);const o=a.slice(0,10),n=t||a.reduce((e,[,t])=>e+t,0);if(0===o.length)return void(s.innerHTML='<p class="no-data">No label data available</p>');s.innerHTML='<canvas id="sidebarLabelPieChart" width="300" height="300"></canvas>';const i=document.getElementById("sidebarLabelPieChart").getContext("2d");new Chart(i,{type:"pie",data:{labels:o.map(([e])=>this.cleanDiscogsNumbering(e)),datasets:[{data:o.map(([,e])=>e),backgroundColor:["#38BA6A","#E9C46A","#EB8244","#309BF1","#E83DB4","#2BBBAD","#F94144","#90BE6D","#F896D8","#577590"],borderWidth:0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{position:"average",intersect:!1,callbacks:{label:function(e){const t=(e.parsed/n*100).toFixed(1);return`${e.label}: ${e.parsed} (${t}%)`}}}},layout:{padding:{top:20,bottom:20,left:20,right:20}},onClick:(e,t)=>{if(t.length>0){const e=t[0].index,s=o[e][0];this.filterByLabel(s)}},onHover:(e,t)=>{e.native.target.style.cursor=t.length>0?"pointer":"default"}}})}updateFilterButtonsWithFilteredCount(e){if(!(this.currentSearch||this.currentStyleFilter||this.currentFormatFilter||this.currentYearFilter||this.currentArtistFilter||this.currentLabelFilter||this.currentProducerFilter))return;const t=e.length,s=e.filter(e=>1==e.is_owned).length,a=e.filter(e=>1==e.want_to_own).length,o=this.getStatsSettings(),n=document.querySelector('[data-filter="owned"]'),i=document.querySelector('[data-filter="wanted"]'),l=document.querySelector('[data-filter="all"]');n&&(o.show_owned_albums?n.textContent=`${s} Owned`:n.textContent="Owned"),i&&(o.show_wanted_albums?i.textContent=`${a} Want`:i.textContent="Want"),l&&(o.show_total_albums?l.textContent=`${t} Total`:l.textContent="Total")}async loadAlbums(){this.showLoading();const e=document.querySelector(".table-container");e&&e.classList.add("loading");try{const e=this.currentSearch.toLowerCase(),t=["style:","genre:","type:"].some(t=>e.startsWith(t))?"":this.currentSearch,s=this.currentSearch||this.currentStyleFilter||this.currentFormatFilter||this.currentYearFilter||this.currentArtistFilter||this.currentLabelFilter||this.currentProducerFilter?"all":this.currentFilter,a=new URLSearchParams({action:"albums",filter:s,search:t}),o=await this.fetchWithCache(`api/music_api.php?${a}`),n=await o.json();if(n.success){let e=n.data;if(this.currentStyleFilter&&(e=e.filter(e=>{if(!e.style)return!1;return e.style.split(",").map(e=>e.trim()).includes(this.currentStyleFilter)})),this.currentFormatFilter&&(e=e.filter(e=>{if(!e.format)return!1;const t=e.format.split(",").map(e=>e.trim());return this.consolidatedFormatTypes?t.some(e=>{const t=e.replace(/\\"/g,'"').toLowerCase().trim();return this.consolidatedFormatTypes.some(e=>e.toLowerCase()===t)}):t.some(e=>e.replace(/\\"/g,'"').toLowerCase()===this.currentFormatFilter.toLowerCase())})),this.currentYearFilter&&(e=e.filter(e=>e.release_year==this.currentYearFilter)),this.currentArtistFilter&&(e=e.filter(e=>e.artist_name.toLowerCase()===this.currentArtistFilter.toLowerCase())),this.currentLabelFilter&&(e=e.filter(e=>!!e.label&&e.label.toLowerCase()===this.currentLabelFilter.toLowerCase())),this.currentProducerFilter&&(e=e.filter(e=>!!e.producer&&e.producer.toLowerCase().includes(this.currentProducerFilter.toLowerCase()))),this.currentSearch&&!this.currentStyleFilter){const t=this.currentSearch.toLowerCase();if(["style:","genre:","type:"].some(e=>t.startsWith(e))){const t=this.currentSearch.replace(/^(style|genre|type):\s*/i,"").trim();t&&(e=e.filter(e=>{if(!e.style)return!1;const s=e.style.toLowerCase(),a=t.toLowerCase();return s.split(",").map(e=>e.trim().toLowerCase()).some(e=>e.includes(a))}))}}this.updateFilterButtonsWithFilteredCount(e),"all"!==this.currentFilter&&(e=e.filter(e=>"owned"===this.currentFilter?1==e.is_owned:"wanted"!==this.currentFilter||1==e.want_to_own));try{const t=this.sortAlbums(e);this.renderAlbums(t)}catch(t){console.error("Sorting error:",t),this.renderAlbums(e)}}else this.showMessage("Error loading albums: "+n.message,"error")}catch(e){this.showMessage("Error loading albums","error")}finally{this.hideLoading(),e&&e.classList.remove("loading")}}renderAlbums(e){const t=document.querySelector("#albumsTable tbody");0!==e.length?(t.innerHTML=e.map(e=>`\n          <tr data-id="${e.id}" data-artist-type="${e.artist_type||""}" data-label="${this.escapeHtml(e.label||"")}" data-format="${encodeURIComponent(e.format||"")}" data-producer="${this.escapeHtml(e.producer||"")}" data-year="${e.year||""}">\n              <td class="cover-cell">\n                  ${e.cover_url?`<img data-src="${e.cover_url}" data-medium="${e.cover_url_medium||e.cover_url}" data-large="${e.cover_url_large||e.cover_url}" class="album-cover lazy" alt="Album cover" data-artist="${this.escapeHtml(e.artist_name)}" data-album="${this.escapeHtml(e.album_name)}" data-year="${e.release_year||""}" data-cover="${e.cover_url_large||e.cover_url}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" onload="this.classList.add('loaded')" width="60" height="60">\n                       <div class="no-cover" style="display: none;">No Cover</div>`:'<div class="no-cover">No Cover</div>'}\n                  <div class="mobile-status">\n                      ${e.is_owned?'<span class="status-owned">Own</span>':""}\n                      ${e.want_to_own?'<span class="status-wanted">Want</span>':""}\n                      ${e.is_owned||e.want_to_own?"":'<span class="status-none">-</span>'}\n                  </div>\n              </td>\n              <td>\n                  <div class="album-info">\n                      <div class="artist-name">\n                          <a href="#" class="artist-link" data-artist="${this.escapeHtml(e.artist_name)}">\n                              ${this.escapeHtml(e.artist_name)}\n                          </a>\n                      </div>\n                      <div class="album-name">\n                          <a href="#" class="album-link" data-artist="${this.escapeHtml(e.artist_name)}" data-album="${this.escapeHtml(e.album_name)}" data-year="${e.release_year||""}">\n                              ${this.escapeHtml(e.album_name)}\n                          </a>\n                      </div>\n                      <div class="mobile-year">${e.release_year?`<button type="button" class="year-link" data-year="${e.release_year}"><span class="year-badge">${e.release_year}</span></button>`:'<span class="year-badge">-</span>'}</div>\n                      <div class="mobile-actions">\n                          <button class="btn-edit" data-id="${e.id}">\n                              <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="Edit" style="vertical-align: text-top;">\n                                <title>edit</title>\n                                <path d="M4 20h4l10.5-10.5a2 2 0 0 0 0-2.8l-1.2-1.2a2 2 0 0 0-2.8 0L4 16v4z" />\n                                <path d="M13.5 6.5l4 4" />\n                              </svg>\n                              Edit\n                          </button>\n                          <button class="btn-delete" data-id="${e.id}">\n                              &times; \n                              Delete\n                          </button>\n                      </div>\n                  </div>\n              </td>\n              <td>\n                  ${e.release_year?`<button type="button" class="year-link" data-year="${e.release_year}"><span class="year-badge">${e.release_year}</span></button>`:'<span class="year-badge">-</span>'}\n              </td>\n              <td>\n                  ${e.is_owned?'<span class="checkmark">✓</span>':'<span class="checkmark">&nbsp;</span>'}\n              </td>\n              <td>\n                  ${e.want_to_own?'<span class="checkmark">✓</span>':'<span class="checkmark">&nbsp;</span>'}\n              </td>\n              <td>\n                  <div class="action-buttons">\n                      <button class="btn-edit" data-id="${e.id}">\n                          <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="Edit" style="vertical-align: text-top;">\n                            <title>edit</title>\n                            <path d="M4 20h4l10.5-10.5a2 2 0 0 0 0-2.8l-1.2-1.2a2 2 0 0 0-2.8 0L4 16v4z" />\n                            <path d="M13.5 6.5l4 4" />\n                          </svg>\n                          Edit\n                      </button>\n                      <button class="btn-delete" data-id="${e.id}">\n                          &times; \n                          Delete\n                      </button>\n                  </div>\n              </td>\n          </tr>\n      `).join(""),this.initLazyLoading(),this.updateAuthUI()):t.innerHTML='\n              <tr>\n                  <td colspan="6" class="empty-state">\n                      <h3>No albums found</h3>\n                      <p>Try adjusting your search or filter criteria</p>\n                  </td>\n              </tr>\n          '}async fetchMasterYearForSelection(e,t,s=null){try{const a=await this.fetchWithCache(`api/music_api.php?action=master_year&release_id=${e}`),o=await a.json();o.success&&o.data&&o.data.master_year?t&&(t.value=o.data.master_year):s&&t&&(t.value=s)}catch(e){s&&t&&(t.value=s)}this.updateSaveButtonState()}async editAlbum(e){try{const t=await this.fetchWithCache(`api/music_api.php?action=album&id=${e}`),s=await t.json();s.success?(this.editingAlbum=s.data,this.showModal(s.data)):this.showMessage("Error loading album: "+s.message,"error")}catch(e){this.showMessage("Error loading album","error")}}async deleteAlbum(e){if(!this.isAuthenticated)return void this.showLoginModal();const t=document.querySelector(`tr[data-id="${e}"]`);if(!t)return void this.showMessage("Album not found","error");const s=t.querySelector(".artist-name"),a=t.querySelector(".album-name"),o=t.querySelector(".year-badge"),n={id:parseInt(e),artist_name:s?s.textContent.trim():"",album_name:a?a.textContent.trim():"",release_year:t.dataset.year||(o?o.textContent.trim():""),artist_type:t.dataset.artistType||"",label:t.dataset.label||"",format:t.dataset.format||"",producer:t.dataset.producer||""};this.showDeleteConfirmationModal(n)}showDeleteConfirmationModal(e){let t=document.getElementById("deleteConfirmationModal");t||(t=document.createElement("div"),t.id="deleteConfirmationModal",t.className="modal",t.innerHTML=`\n              <div class="modal-content">\n                  <div class="modal-header">\n                      <h2>Delete Album</h2>\n                      <span class="close" id="deleteModalClose">&times;</span>\n                  </div>\n                  <div class="modal-body">\n                      <p>Are you sure you want to delete this album?</p>\n                      <div class="album-info">\n                          <div class="album-details">\n                              <div class="artist-name">${this.escapeHtml(e.artist_name)}</div>\n                              <div class="album-name">${this.escapeHtml(e.album_name)}</div>\n                          </div>\n                          ${e.release_year?`<br><span class="year">${e.release_year}</span>`:""}\n                      </div>\n                      <p class="warning">This action cannot be undone.</p>\n                  </div>\n                  <div class="modal-footer">\n                      <button type="button" class="btn btn-secondary" id="deleteCancelBtn">Cancel</button>\n                      <button type="button" class="btn btn-danger" id="deleteConfirmBtn">Delete</button>\n                  </div>\n              </div>\n          `,document.body.appendChild(t),document.getElementById("deleteModalClose").addEventListener("click",()=>{t.style.display="none"}),document.getElementById("deleteCancelBtn").addEventListener("click",()=>{t.style.display="none"}),document.getElementById("deleteConfirmBtn").addEventListener("click",()=>{this.confirmDeleteAlbum(e.id),t.style.display="none"}),t.addEventListener("click",e=>{e.target===t&&(t.style.display="none")}));t.querySelector(".album-info").innerHTML=`\n          <div class="album-details">\n              <div class="artist-name">${this.escapeHtml(e.artist_name)}</div>\n              <div class="album-name">${this.escapeHtml(e.album_name)}</div>\n          </div>\n          ${e.release_year?`<span class="year">${e.release_year}</span>`:""}\n      `,t.style.display="block"}async confirmDeleteAlbum(e){try{const t=new AbortController,s=setTimeout(()=>t.abort(),1e4),a=await fetch("api/music_api.php?action=delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e}),signal:t.signal});clearTimeout(s);const o=await a.json();o.success?(this.showMessage("Album deleted successfully","success"),this.loadAlbums(),this.loadStats()):o.auth_required?this.showLoginModal():this.showMessage("Error deleting album: "+o.message,"error")}catch(e){"AbortError"===e.name?this.showMessage("Delete request timed out. Please try again.","error"):this.showMessage("Error deleting album","error")}}showModal(e=null){const t=document.getElementById("albumModal"),s=document.getElementById("albumForm"),a=document.querySelector("#albumModal h2"),o=document.getElementById("viewRecordBtn");if(s.reset(),this.hideModalMessage(),t.classList.remove("add-album","edit-album"),e?t.classList.add("edit-album"):t.classList.add("add-album"),e){a.textContent="Edit Album",document.getElementById("artistName").value=e.artist_name,document.getElementById("albumName").value=e.album_name,document.getElementById("releaseYear").value=e.release_year||"",document.getElementById("label").value=e.label||"",document.getElementById("producer").value=e.producer||"";const t=document.getElementById("albumFormat");t.value=e.format||"",t.readOnly=!1,this.selectedCoverUrl=e.cover_url||null,this.selectedDiscogsReleaseId=e.discogs_release_id||null,1==e.is_owned?document.getElementById("isOwned").checked=!0:1==e.want_to_own&&(document.getElementById("wantToOwn").checked=!0);const s=document.getElementById("albumName");s.disabled=!1,s.placeholder="Enter album name...",o.style.display="block",this.editingAlbum=e,this.updateSaveButtonState()}else{a.textContent="Add New Album",this.editingAlbum=null,o.style.display="none",this.selectedCoverUrl=null,this.selectedDiscogsReleaseId=null;const e=document.getElementById("albumFormat");e.value="",e.readOnly=!0,this.updateAlbumInputState()}t.style.display="block",this.updateSaveButtonState(),document.getElementById("artistName").focus()}hideModal(){const e=document.getElementById("albumModal");e.style.display="none",e.classList.remove("add-album","edit-album"),this.editingAlbum=null,this.selectedCoverUrl=null,this.selectedDiscogsReleaseId=null,this.hideModalMessage()}async showViewRecordModal(){if(!this.editingAlbum)return;const e=document.getElementById("viewRecordModal"),t=document.getElementById("recordData");try{const e=await this.fetchWithCache(`api/music_api.php?action=album&id=${this.editingAlbum.id}`),s=await e.json();if(s.success&&s.data){this.originalAlbumData=s.data;const e=JSON.stringify(s.data,null,2);t.textContent=e}else t.textContent="Error loading album data: "+(s.message||"Unknown error")}catch(e){t.textContent="Error loading album data: "+e.message}e.style.display="block"}hideViewRecordModal(){document.getElementById("viewRecordModal").style.display="none",this.cancelRecordEditing(),this.hideModal()}enableRecordEditing(){const e=document.getElementById("recordData"),t=document.getElementById("editRecordBtn"),s=document.getElementById("saveRecordBtn"),a=document.getElementById("cancelEditBtn"),o=document.getElementById("editWarning"),n=document.getElementById("editError");this.originalRecordData=e.textContent,this.createProtectedJsonEditor(),t.style.display="none",s.style.display="block",a.style.display="block",o.style.display="block",n.style.display="none"}cancelRecordEditing(){const e=document.getElementById("recordData"),t=document.getElementById("editRecordBtn"),s=document.getElementById("saveRecordBtn"),a=document.getElementById("cancelEditBtn"),o=document.getElementById("editWarning"),n=document.getElementById("editError");this.originalRecordData&&(e.textContent=this.originalRecordData),e.contentEditable=!1,t.style.display="block",s.style.display="none",a.style.display="none",o.style.display="none",n.style.display="none",this.originalRecordData=null,this.originalAlbumData=null}createProtectedJsonEditor(){const e=document.getElementById("recordData"),t=this.originalAlbumData;if(!t)return;e.innerHTML="",e.contentEditable=!1;const s=document.createElement("div");s.className="protected-json-editor",s.style.whiteSpace="pre",s.style.lineHeight="1.4";Object.entries(t).forEach(([e,a],o)=>{"  ".repeat(1);const n=o===Object.keys(t).length-1,i=document.createElement("span");i.textContent=`"${e}":`,i.style.color="#0066cc",i.style.fontWeight="bold",i.contentEditable=!1;const l=document.createElement("span");l.textContent="string"==typeof a?`"${a}"`:a,"id"===e?(l.contentEditable=!1,l.style.color="#6c757d",l.style.fontStyle="italic",l.style.backgroundColor="#f8f9fa",l.style.padding="2px 4px",l.style.borderRadius="3px",l.style.border="1px solid #dee2e6"):(l.contentEditable=!0,l.style.outline="none",l.style.border="1px solid transparent",l.style.borderRadius="2px",l.style.padding="2px 4px",l.style.backgroundColor="#ffffff",l.style.color="#212529",l.style.fontWeight="500"),l.dataset.key=e,l.dataset.originalValue=a,"id"!==e&&(l.addEventListener("mouseenter",()=>{l.style.backgroundColor="#e3f2fd",l.style.borderColor="#007bff"}),l.addEventListener("mouseleave",()=>{l.style.backgroundColor="#ffffff",l.style.borderColor="transparent"}),l.addEventListener("focus",()=>{l.style.backgroundColor="#e3f2fd",l.style.borderColor="#007bff",l.style.boxShadow="0 0 0 2px rgba(0, 123, 255, 0.25)"}),l.addEventListener("blur",()=>{l.style.backgroundColor="#ffffff",l.style.borderColor="transparent",l.style.boxShadow="none"}));const r=document.createElement("div");if(r.style.marginLeft="20px",r.appendChild(i),r.appendChild(l),!n){const e=document.createElement("span");e.textContent=",",r.appendChild(e)}s.appendChild(r)}),e.appendChild(s);const a=e.querySelector('[contenteditable="true"]');a&&a.focus()}collectDataFromProtectedEditor(){const e=document.getElementById("recordData"),t={...this.originalAlbumData};return e.querySelectorAll('[contenteditable="true"]').forEach(e=>{const s=e.dataset.key,a=e.dataset.originalValue;let o=e.textContent.trim();"string"==typeof a?(o.startsWith('"')&&o.endsWith('"')&&(o=o.slice(1,-1)),t[s]=o):t[s]="number"==typeof a?parseFloat(o)||a:"boolean"==typeof a?"true"===o.toLowerCase():null===a&&"null"===o?null:o}),t}async saveRecordChanges(){const e=document.getElementById("recordData"),t=document.getElementById("editRecordBtn"),s=document.getElementById("saveRecordBtn"),a=document.getElementById("cancelEditBtn");try{const o=this.collectDataFromProtectedEditor();if(!o.artist_name||!o.album_name)throw new Error("Artist name and album name are required");if(o.id!==this.editingAlbum.id)throw new Error("Cannot change the album ID. This field is protected to prevent data conflicts.");const n=await fetch("api/music_api.php?action=update_raw",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),i=await n.json();if(!i.success)throw new Error(i.message||"Failed to update record");this.editingAlbum=o,e.textContent=JSON.stringify(o,null,2),e.contentEditable=!1,t.style.display="block",s.style.display="none",a.style.display="none";document.getElementById("editWarning").style.display="none",this.originalRecordData=null,this.showMessage("Record updated successfully","success"),this.loadAlbums(),this.hideViewRecordModal()}catch(t){const s=document.getElementById("editError");s.innerHTML=`<strong>❌ Error:</strong> ${t.message}`,s.style.display="block",this.originalRecordData&&(e.textContent=this.originalRecordData)}}hideModalMessage(){const e=document.getElementById("modalMessage");e.style.display="none",e.textContent="",e.className="modal-message"}async saveAlbum(){if(!this.isAuthenticated)return void this.showLoginModal();const e=document.getElementById("albumForm"),t=new FormData(e),s=t.get("albumStatus");if(!s)return void this.showModalMessage('Please select either "I own this album" or "I want to own this album"',"error");const a={artist_name:t.get("artistName"),album_name:t.get("albumName"),release_year:t.get("releaseYear"),format:t.get("albumFormat"),label:t.get("label"),producer:t.get("producer"),is_owned:"owned"===s,want_to_own:"wanted"===s,cover_url:this.selectedCoverUrl||null,discogs_release_id:this.selectedDiscogsReleaseId||null},o=this.editingAlbum?"update":"add";this.editingAlbum&&(a.id=this.editingAlbum.id);try{const e=await fetch(`api/music_api.php?action=${o}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);const t=await e.text();if(!t.trim())throw new Error("Empty response from server");let s;try{s=JSON.parse(t)}catch(e){throw new Error(`Invalid JSON response: ${e.message}`)}s.success?(this.hideModal(),this.showMessage(s.message,"success"),this.loadAlbums(),this.loadStats(),this.editingAlbum=null):s.auth_required?this.showLoginModal():this.showModalMessage(s.message||"Unknown error occurred","error")}catch(e){this.showModalMessage("Network error: "+e.message,"error")}}showLoading(){document.getElementById("loading").style.display="block"}hideLoading(){document.getElementById("loading").style.display="none"}showModalMessage(e,t){const s=document.getElementById("modalMessage");s.textContent=e,s.className=`modal-message ${t}`,s.style.display="block",setTimeout(()=>{s.style.display="none"},5e3)}showMessage(e,t){const s=document.getElementById("message");s.textContent=e,s.className=`message ${t}`,s.classList.add("show"),setTimeout(()=>{s.classList.remove("show")},5e3)}async showCoverModal(e,t,s,a,o=null){const n=document.getElementById("coverModal"),i=document.getElementById("coverModalImage"),l=document.getElementById("coverModalInfo");i.src=a,i.alt=`${t} by ${e}`,l.innerHTML=`\n          <div class="artist-name"><a href="javascript:void(0)" class="artist-link" data-artist="${this.escapeHtml(e)}">${this.escapeHtml(e)}</a></div>\n          <div class="album-name"><a href="javascript:void(0)" class="album-link" data-artist="${this.escapeHtml(e)}" data-album="${this.escapeHtml(t)}" data-year="${s||""}" data-album-id="${o||""}">${this.escapeHtml(t)}</a></div>\n          ${s?`<div class="album-year"><a href="javascript:void(0)" class="year-link" data-year="${s}">${s}</a></div>`:""}\n      `;const r=l.querySelector(".album-link");r&&r.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();const t=r.dataset.artist,s=r.dataset.album,a=r.dataset.year,o=r.dataset.albumId;this.showTracklist(t,s,a,o),this.hideCoverModal()});const d=l.querySelector(".artist-link");d&&d.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();const t=d.dataset.artist;this.filterByArtist(t),this.hideCoverModal()});const c=l.querySelector(".year-link");if(c&&c.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();const t=c.dataset.year;this.filterByYear(t),this.hideCoverModal()}),n.style.display="block",o)try{const a=new URLSearchParams({artist:e,album:t});s&&a.append("year",s),a.append("album_id",o);const n=await this.fetchWithCache(`api/tracklist_api.php?${a}`),i=await n.json();if(i.success&&i.data&&i.data.master_year){const e=l.querySelector(".year-link");e&&(e.textContent=i.data.master_year,e.dataset.year=i.data.master_year)}}catch(e){}}hideCoverModal(){document.getElementById("coverModal").style.display="none"}async showTracklist(e,t,s,a=null){const o=document.getElementById("tracklistModal"),n=document.getElementById("tracklistModalTitle"),i=document.getElementById("tracklistModalInfo"),l=document.getElementById("tracklistModalTracks"),r=document.getElementById("tracklistModalDiscogsLink"),d=document.getElementById("tracklistModalCover"),c=document.getElementById("tracklistModalNoCover");n.textContent=`${t}`;let u="",h="",m="",p="";if(a){const e=document.querySelector(`tr[data-id="${a}"]`);if(e){const t=e.dataset.label,s=decodeURIComponent(e.dataset.format),a=e.dataset.producer,o=e.dataset.year,n=e=>{if(!e)return e;return e.replace(/\\u([0-9a-fA-F]{4})/g,(e,t)=>String.fromCharCode(parseInt(t,16))).split(",").map(e=>e.trim()).join(", ")};u=t?`<span><a href="javascript:void(0)" class="tracklist-label-link" data-label="${this.escapeHtml(t)}">${this.cleanDiscogsNumbering(t)}</a></span>`:'<span class="loading-placeholder">Loading...</span>',h=s?`<a href="javascript:void(0)" class="tracklist-format-link" data-format-encoded="${btoa(encodeURIComponent(s))}">${n(s)}</a>`:'<span class="loading-placeholder">Loading...</span>',m=a?`<a href="javascript:void(0)" class="tracklist-producer-link" data-producer-encoded="${btoa(encodeURIComponent(a))}">${n(this.cleanDiscogsNumbering(a))}</a>`:null,p=o?`<span>${o}</span>`:'<span class="loading-placeholder">Loading...</span>'}}else u='<span class="loading-placeholder">Loading...</span>',h='<span class="loading-placeholder">Loading...</span>',m=null,p='<span class="loading-placeholder">Loading...</span>';let y=`\n          <div><strong>Artist:</strong> <span><a href="javascript:void(0)" class="tracklist-artist-link" data-artist="${this.escapeHtml(e)}">${this.escapeHtml(e)}</a></span></div>\n          ${s?`<div><strong>Year:</strong> <span><a href="javascript:void(0)" class="tracklist-year-link" data-year="${s}">${s}</a></span></div>`:""}\n      `;this.shouldShowLabel()&&(y+=`<div><strong>Label:</strong> ${u}</div>`),this.shouldShowFormat()&&(y+=`<div><strong>Format:</strong> ${h}</div>`),this.shouldShowProducer()&&m&&(y+=`<div><strong>Producer:</strong> ${m}</div>`),this.shouldShowReleased()&&(y+=`<div><strong>Released:</strong> ${p}</div>`),this.shouldShowRating()&&(y+='<div><strong>Rating:</strong> <span class="loading-placeholder">Loading...</span></div>'),i.innerHTML=y,this.addTracklistFilterEventListeners(i),d.style.display="none",c.style.display="none",c.textContent="";let g=null;if(a){const e=document.querySelector(`tr[data-id="${a}"]`);if(e){const t=e.querySelector(".album-cover");t&&t.src&&t.src!==window.location.href&&(g=t.src)}}g&&(d.src=g,d.style.display="block",c.style.display="none",d.classList.add("loaded")),l.innerHTML='<div class="tracklist-loading">Loading tracklist...</div>',o.style.display="block",o.dataset.artistName=e,o.dataset.albumName=t,o.dataset.releaseYear=s||"",o.dataset.albumId=a||"";const b=document.getElementById("tracklistEditBtn");b&&(this.isAuthenticated&&a?(b.style.display="flex",b.dataset.albumId=a,b.dataset.artistName=e,b.dataset.albumName=t,b.dataset.releaseYear=s||""):b.style.display="none");try{const o=new URLSearchParams({artist:e,album:t});s&&o.append("year",s),a&&o.append("album_id",a);const n=await fetch(`api/tracklist_api.php?${o}`,{cache:"no-cache",headers:{"Content-Type":"application/json"}}),u=await n.json();if(u.success&&u.data){const t=u.data;let s="";if(t.released)try{let e=t.released,a=!1;e.match(/^\d{4}-\d{2}-00$/)&&(a=!0,e=e.replace("-00","-01"));const o=e.split("-"),n=parseInt(o[0]),i=parseInt(o[1])-1,l=parseInt(o[2]),r=new Date(n,i,l);if(isNaN(r.getTime()))s=t.released;else{const e=r.getMonth(),t=r.getDate();s=a||11===e&&31===t?n.toString():r.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}}catch(e){s=t.released}let a="";if(t.rating_count){const e=1===t.rating_count?"review":"reviews";a=t.has_reviews_with_content?`<span class="rating-count">(based on <a href="${t.discogs_url}#release-reviews" target="_blank" rel="noopener noreferrer" style="padding-left: .25em;">${t.rating_count} ${e}</a>)</span>`:`<span class="rating-count">(based on ${t.rating_count} ${e})</span>`}const o=e=>{if(!e)return e;return e.replace(/\\u([0-9a-fA-F]{4})/g,(e,t)=>String.fromCharCode(parseInt(t,16))).split(",").map(e=>e.trim()).join(", ")};let n=`\n                  <div><strong>Artist:</strong> <span><a href="javascript:void(0)" class="tracklist-artist-link" data-artist="${this.escapeHtml(e)}">${this.escapeHtml(e)}</a></span></div>\n                  ${s?`<div><strong>Year:</strong> <span><a href="javascript:void(0)" class="tracklist-year-link" data-year="${s}">${s}</a></span></div>`:""}\n              `;if(this.shouldShowLabel()&&t.label&&(n+=`<div><strong>Label:</strong> <span><a href="javascript:void(0)" class="tracklist-label-link" data-label="${this.escapeHtml(t.label)}">${this.cleanDiscogsNumbering(t.label)}</a></span></div>`),this.shouldShowFormat()&&t.format&&(n+=`<div><strong>Format:</strong> <a href="javascript:void(0)" class="tracklist-format-link" data-format-encoded="${btoa(encodeURIComponent(t.format))}">${o(t.format)}</a></div>`),this.shouldShowProducer()&&t.producer&&(n+=`<div><strong>Producer:</strong> <a href="javascript:void(0)" class="tracklist-producer-link" data-producer-encoded="${btoa(encodeURIComponent(t.producer))}">${o(this.cleanDiscogsNumbering(t.producer))}</a></div>`),this.shouldShowReleased()&&t.year&&(n+=`<div><strong>Released:</strong> <span>${t.year}</span></div>`),this.shouldShowRating()&&t.rating&&(n+=`<div><strong>Rating:</strong> <span class="rating-content">${t.rating}${this.generateStarRating(t.rating)}<br>${a}</span></div>`),i.innerHTML=n,this.addTracklistFilterEventListeners(i),!g&&t.cover_url){const e=t.cover_url_medium||t.cover_url;e.includes("api/image_proxy.php")?(d.style.display="none",c.style.display="none",c.textContent=""):(c.textContent="Loading Cover...",c.style.display="flex",d.style.display="none"),d.src=e;const s=setTimeout(()=>{"none"===d.style.display&&(d.style.display="none",c.textContent="No Cover",c.style.display="flex")},1e4);d.onload=function(){clearTimeout(s),d.style.display="block",c.style.display="none",d.classList.add("loaded")},d.onerror=function(){clearTimeout(s),d.style.display="none",c.textContent="No Cover",c.style.display="flex"}}else g||t.cover_url||(d.style.display="none",c.textContent="No Cover",c.style.display="flex");if(r.href=t.discogs_url,t.matched_reason){const e=document.createElement("div");e.className="tracklist-match-info",e.innerHTML=`<small>Matched: ${t.matched_reason}</small>`,l.appendChild(e)}t.tracklist&&t.tracklist.length>0?l.innerHTML=`\n                      <div class="tracklist-modal-tracks">\n                          ${t.tracklist.map(e=>`\n                              <div class="track-item">\n                                  <span class="track-position">${e.position}</span>\n                                  <span class="track-title">${this.escapeHtml(e.title)}</span>\n                                  <span class="track-duration">${e.duration||""}</span>\n                                  ${this.renderLyricsLinks(e)}\n                              </div>\n                          `).join("")}\n                      </div>\n                      ${this.renderArtistWebsite(t.artist_website)}\n                  `:l.innerHTML='<div class="tracklist-error">No tracklist available for this album</div>'}else{let s="Could not load tracklist";u.message&&!u.message.includes("Discogs API request failed")&&(s=u.message),l.innerHTML=`<div class="tracklist-error">${s}</div>`,r.href=`https://www.discogs.com/search/?q=${encodeURIComponent(e+" "+t)}&type=release`}}catch(s){l.innerHTML='<div class="tracklist-error">Could not load tracklist. Please try again later.</div>',r.href=`https://www.discogs.com/search/?q=${encodeURIComponent(e+" "+t)}&type=release`}}addTracklistFilterEventListeners(e){const t=e.querySelector(".tracklist-artist-link");t&&t.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();const s=t.dataset.artist;this.filterByArtist(s),this.hideTracklistModal()});e.querySelectorAll(".tracklist-year-link").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation();const s=e.dataset.year;this.filterByYear(s),this.hideTracklistModal()})});const s=e.querySelector(".tracklist-label-link");s&&s.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();const t=s.dataset.label;this.filterByLabel(t),this.hideTracklistModal()});const a=e.querySelector(".tracklist-format-link");if(a){const t=a.dataset.formatEncoded,s=decodeURIComponent(atob(t)).split(",").map(e=>{let t=e.trim();return t=t.replace(/\\"/g,'"'),t=t.replace(/\\u([0-9a-fA-F]{4})/g,(e,t)=>String.fromCharCode(parseInt(t,16))),t});a.outerHTML=`<span class="format-links-container">${s.map(e=>`<a href="javascript:void(0)" class="tracklist-format-type-link" data-format-encoded="${btoa(encodeURIComponent(e))}">${this.escapeHtml(e)}</a>`).join(", ")}</span>`;e.querySelectorAll(".tracklist-format-type-link").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation();const s=e.dataset.formatEncoded,a=decodeURIComponent(atob(s));this.filterByFormat(a),this.hideTracklistModal()})})}const o=e.querySelector(".tracklist-producer-link");if(o){const t=o.dataset.producerEncoded,s=decodeURIComponent(atob(t)).split(",").map(e=>e.trim());o.outerHTML=`<span class="producer-links-container">${s.map(e=>{const t=this.cleanDiscogsNumbering(e);return`<a href="javascript:void(0)" class="tracklist-producer-type-link" data-producer="${this.escapeHtml(e)}">${this.escapeHtml(t)}</a>`}).join(", ")}</span>`;e.querySelectorAll(".tracklist-producer-type-link").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation();const s=e.dataset.producer;this.filterByProducer(s),this.hideTracklistModal()})})}}hideTracklistModal(){document.getElementById("tracklistModal").style.display="none"}handleTracklistEdit(){const e=document.getElementById("tracklistEditBtn");if(!e||!e.dataset.albumId)return;const t=e.dataset.albumId;this.hideTracklistModal(),this.editAlbum(parseInt(t))}showLoginModal(){document.getElementById("loginModal").style.display="block",document.getElementById("password").focus(),document.getElementById("loginMessage").style.display="none"}showStatsModal(){document.getElementById("statsModal").style.display="block"}hideStatsModal(){document.getElementById("statsModal").style.display="none"}showResetPasswordModal(){this.isAuthenticated||document.body.classList.contains("setup-page")?(document.getElementById("resetPasswordMessage").style.display="none",document.getElementById("resetPasswordForm").reset(),document.getElementById("resetPasswordModal").style.display="block",document.getElementById("reset_current_password").focus()):this.showLoginModal()}hideResetPasswordModal(){document.getElementById("resetPasswordModal").style.display="none",document.getElementById("resetPasswordForm").reset(),document.getElementById("resetPasswordMessage").style.display="none"}async handleResetPassword(e){e.preventDefault();const t=document.getElementById("reset_current_password").value,s=document.getElementById("reset_new_password").value,a=document.getElementById("reset_confirm_password").value,o=document.getElementById("resetPasswordMessage");try{const e=await fetch("api/music_api.php?action=reset_password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({current_password:t,new_password:s,confirm_password:a})}),n=await e.json();n.success?(o.textContent=n.message,o.className="modal-message success",o.style.display="block",document.getElementById("resetPasswordForm").reset(),setTimeout(()=>{this.hideResetPasswordModal()},3e3)):(o.textContent=n.message,o.className="modal-message error",o.style.display="block")}catch(e){o.textContent="Network error. Please try again.",o.className="modal-message error",o.style.display="block"}}initDemoManager(){(window.location.hostname.includes("railway.app")||window.location.hostname.includes("herokuapp.com")||window.location.hostname.includes("netlify.app")||window.location.hostname.includes("vercel.app"))&&window.DemoManager&&(this.demoManager=new window.DemoManager(this))}async handleDemoReset(){this.demoManager&&this.demoManager.handleDemoReset()}startNotificationPolling(){localStorage.getItem("browserId")||localStorage.setItem("browserId","browser_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)),this.browserId=localStorage.getItem("browserId"),setInterval(()=>{this.checkForNotifications()},1e4),setTimeout(()=>{this.checkForNotifications()},2e3)}async checkForNotifications(){try{const e=await fetch("api/music_api.php?action=get_notifications");if(e.ok){const t=await e.json();t.success&&t.notifications&&t.notifications.length>0&&this.showNotifications(t.notifications)}}catch(e){}}showNotifications(e){const t="shownNotifications_"+this.browserId,s=JSON.parse(localStorage.getItem(t)||"[]");s.length>50&&(s.splice(0,s.length-50),localStorage.setItem(t,JSON.stringify(s)));const a=e.map(e=>e.id);document.querySelectorAll(".notification-toast").forEach(e=>{const t=parseInt(e.dataset.notificationId);a.includes(t)||e.remove()}),e.forEach(e=>{s.includes(e.id)||(s.push(e.id),localStorage.setItem(t,JSON.stringify(s)),this.showNotificationToast(e))})}showNotificationToast(e){this.demoManager&&this.demoManager.handleDemoResetNotification(e)}async showSetupModal(){this.isAuthenticated?(this.loadSetupStatus(),document.getElementById("setupMessage").style.display="none",document.getElementById("setupForm").reset(),document.getElementById("setupModal").style.display="block",await this.setupThemeCustomization(),document.getElementById("setup_discogs_api_key").focus()):this.showLoginModal()}hideSetupModal(){document.getElementById("setupModal").style.display="none",document.getElementById("setupForm").reset(),document.getElementById("setupMessage").style.display="none"}async initSetupPage(){this.loadSetupStatus(),await this.loadDisplayMode(),await this.setupThemeCustomization(),this.setupPageEventListeners()}setupPageEventListeners(){const e=document.getElementById("setupForm");e&&e.addEventListener("submit",e=>{e.preventDefault(),this.handleSetupConfig(e)});const t=document.getElementById("setupPasswordBtn");t&&t.addEventListener("click",()=>{this.handlePasswordSetup()});[{inputId:"reset_current_password",buttonId:"toggleResetCurrentPassword"},{inputId:"reset_new_password",buttonId:"toggleResetNewPassword"},{inputId:"reset_confirm_password",buttonId:"toggleResetConfirmPassword"}].forEach(e=>{const t=document.getElementById(e.buttonId),s=document.getElementById(e.inputId);if(t&&s){const e=t.querySelector(".eye-icon"),a=t.querySelector(".eye-slash-icon");t.addEventListener("click",()=>{const t="password"===s.getAttribute("type")?"text":"password";s.setAttribute("type",t),"text"===t?(e.style.display="none",a.style.display="block"):(e.style.display="block",a.style.display="none")})}});const s=document.getElementById("resetPasswordForm");s&&s.addEventListener("submit",e=>{e.preventDefault(),this.handleResetPassword(e)});const a=document.querySelector("#resetPasswordModal .btn-cancel");a&&a.addEventListener("click",()=>{this.hideResetPasswordModal()});const o=document.querySelector("#resetPasswordModal .close");o&&o.addEventListener("click",()=>{this.hideResetPasswordModal()});const n=document.getElementById("saveDisplayModeBtn");n&&n.addEventListener("click",()=>{this.saveDisplayMode()});const i=document.getElementById("saveThemeBtn");i&&i.addEventListener("click",()=>{this.saveThemeColors()});const l=document.getElementById("resetThemeBtn");l&&l.addEventListener("click",()=>{this.resetThemeColors()}),this.setupColorPickerSync(),this.setupTabFunctionality(),this.setupSettingsFunctionality(),this.setupStatsFunctionality()}handlePasswordSetup(){document.body.classList.contains("setup-page")||this.isAuthenticated?this.showResetPasswordModal():window.location.href="index.php?login=required"}setupTabFunctionality(){const e=document.querySelectorAll(".tab-button"),t=document.querySelectorAll(".tab-panel");e.forEach(s=>{s.addEventListener("click",()=>{const a=s.getAttribute("data-tab");e.forEach(e=>e.classList.remove("active")),t.forEach(e=>e.classList.remove("active")),s.classList.add("active");const o=document.getElementById(a);o&&o.classList.add("active")})})}setupColorPickerSync(){const e=document.querySelectorAll('input[type="color"]');document.querySelectorAll('input[type="text"][pattern*="hex"]');e.forEach(e=>{const t=document.getElementById(e.id+"Hex");t&&(e.addEventListener("input",()=>{t.value=e.value}),t.addEventListener("input",()=>{/^#[0-9A-Fa-f]{6}$/.test(t.value)&&(e.value=t.value)}))})}setupSettingsFunctionality(){this.loadSettings();const e=document.getElementById("saveSettingsBtn");e&&e.addEventListener("click",()=>{this.saveSettings()});const t=document.getElementById("resetSettingsBtn");t&&t.addEventListener("click",()=>{this.resetSettings()});const s=document.getElementById("selectAllArtistLinks");s&&s.addEventListener("click",()=>{this.selectAllArtistLinks()});const a=document.getElementById("selectNoneArtistLinks");a&&a.addEventListener("click",()=>{this.selectNoneArtistLinks()});const o=document.getElementById("selectAllAlbumInfo");o&&o.addEventListener("click",()=>{this.selectAllAlbumInfo()});const n=document.getElementById("selectNoneAlbumInfo");n&&n.addEventListener("click",()=>{this.selectNoneAlbumInfo()})}setupStatsFunctionality(){this.loadStatsSettings();const e=document.getElementById("showTotalAlbums"),t=document.getElementById("showOwnedAlbums"),s=document.getElementById("showWantedAlbums");e&&e.addEventListener("change",()=>{this.updateButtonDisplay()}),t&&t.addEventListener("change",()=>{this.updateButtonDisplay()}),s&&s.addEventListener("change",()=>{this.updateButtonDisplay()});const a=document.getElementById("showYearChart"),o=document.getElementById("showStyleChart"),n=document.getElementById("showFormatChart"),i=document.getElementById("showLabelChart");a&&a.addEventListener("change",()=>{this.updateChartDisplay()}),o&&o.addEventListener("change",()=>{this.updateChartDisplay()}),n&&n.addEventListener("change",()=>{this.updateChartDisplay()}),i&&i.addEventListener("change",()=>{this.updateChartDisplay()});const l=document.getElementById("showModalStyles"),r=document.getElementById("showModalYears"),d=document.getElementById("showModalFormats"),c=document.getElementById("showModalLabels");l&&l.addEventListener("change",()=>{this.updateModalDisplay()}),r&&r.addEventListener("change",()=>{this.updateModalDisplay()}),d&&d.addEventListener("change",()=>{this.updateModalDisplay()}),c&&c.addEventListener("change",()=>{this.updateModalDisplay()});const u=document.getElementById("selectAllCollectionStats"),h=document.getElementById("selectNoneCollectionStats"),m=document.getElementById("selectAllChartStats"),p=document.getElementById("selectNoneChartStats"),y=document.getElementById("selectAllModalStats"),g=document.getElementById("selectNoneModalStats");u&&u.addEventListener("click",()=>{document.getElementById("showTotalAlbums").checked=!0,document.getElementById("showOwnedAlbums").checked=!0,document.getElementById("showWantedAlbums").checked=!0,this.updateButtonDisplay()}),h&&h.addEventListener("click",()=>{document.getElementById("showTotalAlbums").checked=!1,document.getElementById("showOwnedAlbums").checked=!1,document.getElementById("showWantedAlbums").checked=!1,this.updateButtonDisplay()}),m&&m.addEventListener("click",()=>{document.getElementById("showYearChart").checked=!0,document.getElementById("showStyleChart").checked=!0,document.getElementById("showFormatChart").checked=!0,document.getElementById("showLabelChart").checked=!0,this.updateChartDisplay()}),p&&p.addEventListener("click",()=>{document.getElementById("showYearChart").checked=!1,document.getElementById("showStyleChart").checked=!1,document.getElementById("showFormatChart").checked=!1,document.getElementById("showLabelChart").checked=!1,this.updateChartDisplay()}),y&&y.addEventListener("click",()=>{document.getElementById("showModalStyles").checked=!0,document.getElementById("showModalYears").checked=!0,document.getElementById("showModalFormats").checked=!0,document.getElementById("showModalLabels").checked=!0,this.updateModalDisplay()}),g&&g.addEventListener("click",()=>{document.getElementById("showModalStyles").checked=!1,document.getElementById("showModalYears").checked=!1,document.getElementById("showModalFormats").checked=!1,document.getElementById("showModalLabels").checked=!1,this.updateModalDisplay()});const b=document.getElementById("saveStatsBtn");b&&b.addEventListener("click",()=>{this.saveStatsSettings()});const w=document.getElementById("resetStatsBtn");w&&w.addEventListener("click",()=>{this.resetStatsSettings()})}updateButtonDisplay(){const e=this.getStatsSettings(),t=document.querySelector('[data-filter="owned"]'),s=document.querySelector('[data-filter="wanted"]'),a=document.querySelector('[data-filter="all"]');if(t){const s=t.textContent,a=s.match(/\d+/)?.[0]||"0";e.show_owned_albums?t.textContent=`${a} Owned`:t.textContent="Owned"}if(s){const t=s.textContent,a=t.match(/\d+/)?.[0]||"0";e.show_wanted_albums?s.textContent=`${a} Want`:s.textContent="Want"}if(a){const t=a.textContent,s=t.match(/\d+/)?.[0]||"0";e.show_total_albums?a.textContent=`${s} Total`:a.textContent="Total"}}updateChartDisplay(){const e=this.getStatsSettings(),t=document.querySelector("#sidebarYearChart"),s=document.querySelector("#sidebarStyleChart"),a=document.querySelector("#sidebarFormatChart"),o=document.querySelector("#sidebarLabelChart");if(!(t&&s&&a&&o))return;const n=t.closest(".sidebar-stat-section"),i=s.closest(".sidebar-stat-section"),l=a.closest(".sidebar-stat-section"),r=o.closest(".sidebar-stat-section");n&&(n.style.display=e.show_year_chart?"block":"none"),i&&(i.style.display=e.show_style_chart?"block":"none"),l&&(l.style.display=e.show_format_chart?"block":"none"),r&&(r.style.display=e.show_label_chart?"block":"none");const d=e.show_year_chart||e.show_style_chart||e.show_format_chart||e.show_label_chart,c=document.getElementById("sidebarStats"),u=document.querySelector(".sidebar"),h=document.querySelector(".main-content"),m=document.querySelector(".content-with-sidebar");c&&u&&h&&m&&(d?(c.style.display="block",u.style.display="block",h.classList.remove("full-width"),m.classList.remove("no-sidebar")):(c.style.display="none",u.style.display="none",h.classList.add("full-width"),m.classList.add("no-sidebar")))}updateModalDisplay(){const e=this.getStatsSettings(),t=document.querySelector(".style-stats-container"),s=document.querySelector(".year-stats-container"),a=document.querySelector(".format-stats-container"),o=document.querySelector(".label-stats-container");if(!(t&&s&&a&&o))return;t&&(t.style.display=e.show_modal_styles?"block":"none"),s&&(s.style.display=e.show_modal_years?"block":"none"),a&&(a.style.display=e.show_modal_formats?"block":"none"),o&&(o.style.display=e.show_modal_labels?"block":"none");const n=e.show_modal_styles||e.show_modal_years||e.show_modal_formats||e.show_modal_labels,i=document.getElementById("statsBtn");i&&(i.style.display=n?"flex":"none")}async loadStatsSettings(){try{const e=await fetch("api/theme_api.php?type=stats_display_settings"),t=await e.json();if(t.success){const e=t.data;this.serverStatsSettings=e,this.applyStatsSettingsToUI(e),this.updateButtonDisplay(),this.updateChartDisplay(),this.updateModalDisplay()}}catch(e){}}applyStatsSettingsToUI(e){Object.keys(e).forEach(t=>{let s=t.replace(/_([a-z])/g,(e,t)=>t.toUpperCase());const a=document.getElementById(s);a&&(a.checked=e[t])})}async saveStatsSettings(){const e={show_total_albums:document.getElementById("showTotalAlbums")?.checked||!1,show_owned_albums:document.getElementById("showOwnedAlbums")?.checked||!1,show_wanted_albums:document.getElementById("showWantedAlbums")?.checked||!1,show_year_chart:document.getElementById("showYearChart")?.checked||!1,show_style_chart:document.getElementById("showStyleChart")?.checked||!1,show_format_chart:document.getElementById("showFormatChart")?.checked||!1,show_label_chart:document.getElementById("showLabelChart")?.checked||!1,show_modal_styles:document.getElementById("showModalStyles")?.checked||!1,show_modal_years:document.getElementById("showModalYears")?.checked||!1,show_modal_formats:document.getElementById("showModalFormats")?.checked||!1,show_modal_labels:document.getElementById("showModalLabels")?.checked||!1};try{const t=await fetch("api/theme_api.php?type=stats_display_settings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});(await t.json()).success?this.showMessage("Stats settings saved successfully!","success"):this.showMessage("Stats settings save failed on server","error")}catch(e){this.showMessage("Failed to save stats settings to server","error")}}resetStatsSettings(){const e={show_total_albums:!0,show_owned_albums:!0,show_wanted_albums:!0,show_year_chart:!0,show_style_chart:!0,show_format_chart:!0,show_label_chart:!0,show_modal_styles:!0,show_modal_years:!0,show_modal_formats:!0,show_modal_labels:!0};this.applyStatsSettingsToUI(e),this.saveDefaultStatsSettingsToServer(e)}async saveDefaultStatsSettingsToServer(e){try{const t=await fetch("api/theme_api.php?type=stats_display_settings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});(await t.json()).success?(this.showMessage("Stats settings reset to defaults!","success"),this.updateChartDisplay(),this.updateModalDisplay()):this.showMessage("Stats settings reset failed on server","error")}catch(e){this.showMessage("Stats settings reset failed on server","error")}}getStatsSettings(){const e={show_total_albums:!0,show_owned_albums:!0,show_wanted_albums:!0,show_year_chart:!0,show_style_chart:!0,show_format_chart:!0,show_label_chart:!0,show_modal_styles:!0,show_modal_years:!0,show_modal_formats:!0,show_modal_labels:!0};return this.serverStatsSettings?{...e,...this.serverStatsSettings}:e}async loadSettings(){try{const e=await fetch("api/theme_api.php?type=album_display_settings"),t=await e.json();if(t.success){const e=t.data;this.serverSettings=e,this.applySettingsToUI(e),!document.body.classList.contains("setup-page")&&this.albums&&this.albums.length>0&&this.renderAlbums(this.albums)}}catch(e){}}applySettingsToUI(e){Object.keys(e).forEach(t=>{if("show_lyrics"===t){const s=document.getElementById("lyricsToggle");s&&(s.checked=e[t])}else if(!t.startsWith("show_")||"show_producer"!==t&&"show_label"!==t&&"show_released"!==t&&"show_rating"!==t&&"show_format"!==t){let s=t.replace(/_([a-z])/g,(e,t)=>t.toUpperCase());"show_youtube"===t?s="showYouTube":"show_soundcloud"===t&&(s="showSoundCloud");const a=document.getElementById(s);a&&(a.checked=e[t])}else{const s=t.replace("show_","")+"Toggle",a=document.getElementById(s);a&&(a.checked=e[t])}})}async saveSettings(){console.log("saveSettings() called");const e={show_facebook:document.getElementById("showFacebook")?.checked||!1,show_twitter:document.getElementById("showTwitter")?.checked||!1,show_instagram:document.getElementById("showInstagram")?.checked||!1,show_youtube:document.getElementById("showYouTube")?.checked||!1,show_bandcamp:document.getElementById("showBandcamp")?.checked||!1,show_soundcloud:document.getElementById("showSoundCloud")?.checked||!1,show_wikipedia:document.getElementById("showWikipedia")?.checked||!1,show_lastfm:document.getElementById("showLastfm")?.checked||!1,show_imdb:document.getElementById("showImdb")?.checked||!1,show_bluesky:document.getElementById("showBluesky")?.checked||!1,show_discogs:document.getElementById("showDiscogs")?.checked||!1,show_official_website:document.getElementById("showOfficialWebsite")?.checked||!1,show_album_count:document.getElementById("showAlbumCount")?.checked||!1,show_year_range:document.getElementById("showYearRange")?.checked||!1,enable_animations:document.getElementById("enableAnimations")?.checked||!1,show_lyrics:document.getElementById("lyricsToggle")?.checked||!1,show_producer:document.getElementById("producerToggle")?.checked||!1,show_label:document.getElementById("labelToggle")?.checked||!1,show_released:document.getElementById("releasedToggle")?.checked||!1,show_rating:document.getElementById("ratingToggle")?.checked||!1,show_format:document.getElementById("formatToggle")?.checked||!1};console.log("Settings to save:",e);try{const t=await fetch("api/theme_api.php?type=album_display_settings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});(await t.json()).success?(this.showMessage("Settings saved successfully!","success"),document.body.classList.contains("setup-page")||this.refreshArtistLinks()):this.showMessage("Server rejected settings","error")}catch(e){this.showMessage("Failed to save settings to server","error")}}resetSettings(){const e={show_facebook:!0,show_twitter:!0,show_instagram:!0,show_youtube:!0,show_bandcamp:!0,show_soundcloud:!0,show_wikipedia:!0,show_lastfm:!0,show_imdb:!0,show_bluesky:!0,show_discogs:!0,show_official_website:!0,show_album_count:!0,show_year_range:!0,enable_animations:!0,show_lyrics:!0,show_producer:!0,show_label:!0,show_released:!0,show_rating:!0,show_format:!0};this.applySettingsToUI(e),this.saveDefaultSettingsToServer(e)}async saveDefaultSettingsToServer(e){try{const t=await fetch("api/theme_api.php?type=album_display_settings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});(await t.json()).success?this.showMessage("Settings reset to defaults!","success"):this.showMessage("Settings reset failed on server","error")}catch(e){this.showMessage("Settings reset failed on server","error")}}showMessage(e,t="info"){const s=document.getElementById("message");s&&(s.textContent=e,s.className=`message ${t}`,s.classList.add("show"),setTimeout(()=>{s.classList.remove("show")},3e3))}selectAllArtistLinks(){["showFacebook","showTwitter","showInstagram","showYouTube","showBandcamp","showSoundCloud","showWikipedia","showLastfm","showImdb","showBluesky","showDiscogs","showOfficialWebsite"].forEach(e=>{const t=document.getElementById(e);t&&(t.checked=!0)})}selectNoneArtistLinks(){["showFacebook","showTwitter","showInstagram","showYouTube","showBandcamp","showSoundCloud","showWikipedia","showLastfm","showImdb","showBluesky","showDiscogs","showOfficialWebsite"].forEach(e=>{const t=document.getElementById(e);t&&(t.checked=!1)})}selectAllAlbumInfo(){["labelToggle","formatToggle","producerToggle","releasedToggle","ratingToggle","lyricsToggle"].forEach(e=>{const t=document.getElementById(e);t&&(t.checked=!0)})}selectNoneAlbumInfo(){["labelToggle","formatToggle","producerToggle","releasedToggle","ratingToggle","lyricsToggle"].forEach(e=>{const t=document.getElementById(e);t&&(t.checked=!1)})}getSettings(){const e={show_facebook:!0,show_twitter:!0,show_instagram:!0,show_youtube:!0,show_bandcamp:!0,show_soundcloud:!0,show_wikipedia:!0,show_lastfm:!0,show_imdb:!0,show_bluesky:!0,show_discogs:!0,show_official_website:!0,show_album_count:!0,show_year_range:!0,enable_animations:!0,show_lyrics:!0,show_producer:!0,show_label:!0,show_released:!0,show_rating:!0,show_format:!0};return this.serverSettings?{...e,...this.serverSettings}:e}shouldShowLink(e){return!0===this.getSettings()[`show_${e.toLowerCase().replace(" ","_")}`]}hasAnyArtistLinksEnabled(){const e=this.getSettings();return["show_facebook","show_twitter","show_instagram","show_youtube","show_bandcamp","show_soundcloud","show_wikipedia","show_lastfm","show_imdb","show_bluesky","show_discogs","show_official_website"].some(t=>!0===e[t])}shouldShowLyrics(){return!0===this.getSettings().show_lyrics}shouldShowProducer(){return!0===this.getSettings().show_producer}shouldShowLabel(){return!0===this.getSettings().show_label}shouldShowReleased(){return!0===this.getSettings().show_released}shouldShowRating(){return!0===this.getSettings().show_rating}shouldShowFormat(){return!0===this.getSettings().show_format}refreshArtistLinks(){document.querySelectorAll(".artist-website-section").forEach(e=>{const t=e.closest(".artist-info")?.querySelector(".artist-name")?.textContent;t&&this.loadArtistWebsites(t.trim()).then(t=>{if(t){const s=this.renderArtistWebsites(t);e.outerHTML=s}})})}async loadSetupStatus(){try{const e=await fetch("api/music_api.php?action=get_setup_status"),t=await e.json();if(t.success){const e=t.data,s=document.getElementById("apiKeyStatus"),a=document.getElementById("apiKeyDetails"),o=document.getElementById("currentApiKeyDisplay");document.getElementById("currentApiKeyText");if(e.api_key_set){let t="";"environment"===e.api_key_source?t=" (from environment variable)":"config_file"===e.api_key_source&&(t=" (from config file)"),a.textContent=e.current_api_key+t,a.style.display="inline",s.textContent="✅ Set",s.className="status-value set",o.style.display="none"}else a.style.display="none",s.textContent="❌ Not set",s.className="status-value not-set",o.style.display="none";document.getElementById("passwordActionText").textContent="Change Password"}}catch(e){console.error("Error loading setup status:",e)}}async handleSetupConfig(e){e.preventDefault();const t=document.getElementById("setup_discogs_api_key").value,s=document.getElementById("setupMessage");try{const e=await fetch("api/music_api.php?action=setup_config",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({discogs_api_key:t})}),a=await e.json();a.success?(s.textContent=a.message,s.className="setup-message success",s.style.display="block",document.getElementById("setupForm").reset(),this.loadSetupStatus(),setTimeout(()=>{s.style.display="none"},3e3)):(s.textContent=a.message,s.className="setup-message error",s.style.display="block")}catch(e){s.textContent="Network error. Please try again.",s.className="setup-message error",s.style.display="block"}}hideLoginModal(){const e=document.getElementById("loginModal");e&&(e.style.display="none"),document.getElementById("password").value="";const t=document.getElementById("loginMessage");t&&(t.style.display="none")}async handleLogin(e){e.preventDefault();const t=document.getElementById("password").value,s=document.getElementById("loginMessage");if(!t)return s.textContent="Please enter a password.",s.className="modal-message error",void(s.style.display="block");try{const e=new AbortController,a=setTimeout(()=>e.abort(),1e4),o=await fetch("api/music_api.php?action=login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:t}),signal:e.signal});clearTimeout(a);const n=await o.json();n.success?(await this.checkAuthStatus(),this.hideLoginModal(),this.showMessage("Login successful","success")):(s.textContent=n.message,s.className="modal-message error",s.style.display="block")}catch(e){"AbortError"===e.name?s.textContent="Login request timed out. Please try again.":s.textContent="Login failed. Please try again.",s.className="modal-message error",s.style.display="block"}}async handleLogout(){try{const e=await fetch("api/music_api.php?action=logout",{method:"POST",headers:{"Content-Type":"application/json"}});(await e.json()).success&&(await this.checkAuthStatus(),this.showMessage("Logged out successfully","success"))}catch(e){}}initLazyLoading(){if("IntersectionObserver"in window){const e=new IntersectionObserver((e,t)=>{e.forEach(e=>{if(e.isIntersecting){const s=e.target;this.loadOptimizedImage(s,s.dataset.src),s.classList.remove("lazy"),s.classList.add("loaded"),t.unobserve(s)}})},{rootMargin:"50px 0px",threshold:.01});document.querySelectorAll("img.lazy").forEach(t=>{e.observe(t)})}else this.loadLazyImagesFallback()}loadLazyImagesFallback(){const e=document.querySelectorAll("img.lazy"),t=e=>{e.dataset.src&&(this.loadOptimizedImage(e,e.dataset.src),e.classList.remove("lazy"))};e.forEach(e=>{this.isElementInViewport(e)&&t(e)});const s=()=>{e.forEach(e=>{e.classList.contains("lazy")&&this.isElementInViewport(e)&&t(e)})};window.addEventListener("scroll",s),window.addEventListener("resize",s)}isElementInViewport(e){const t=e.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&t.right<=(window.innerWidth||document.documentElement.clientWidth)}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}renderLyricsLinks(e){if(!this.shouldShowLyrics())return"";if(!e.lyrics_urls)return"";const t=e.lyrics_urls;let s='<div class="lyrics-links">';return e.has_lyrics&&(s+='<span class="lyrics-indicator" title="Lyrics available">🎵</span>'),s+='<div class="lyrics-dropdown">',s+='<button class="lyrics-btn" title="Search for lyrics">Lyrics</button>',s+='<div class="lyrics-menu">',t.genius&&(s+=`<a href="${t.genius}" target="_blank" rel="noopener noreferrer">Genius</a>`),t.google&&(s+=`<a href="${t.google}" target="_blank" rel="noopener noreferrer">Google Search</a>`),s+="</div></div></div>",s}renderArtistWebsite(e){if(!e||!e.websites||0===e.websites.length)return"";const t=e.websites,s=e.discogs_url,a=t.filter(e=>this.shouldShowLink(e.type)),o=s&&this.shouldShowLink("Discogs");return 0===a.length&&!o||!this.hasAnyArtistLinksEnabled()?"":`\n          <div class="artist-website-section">\n              <div class="artist-website-header">\n                  <span class="artist-website-icon">🌐</span>\n                  <strong>Artist Links</strong>\n              </div>\n              <div class="artist-website-links">\n                  ${a.map(e=>`\n                      <a href="${e.url}" target="_blank" rel="noopener noreferrer" class="artist-website-link">\n                          ${e.type}\n                      </a>\n                  `).join("")}\n                  ${o?`<a href="${s}" target="_blank" rel="noopener noreferrer" class="artist-website-link discogs-link">Artist Profile</a>`:""}\n              </div>\n          </div>\n      `}cleanDiscogsNumbering(e){return e?e.replace(/\s*\(\d+\)\s*$/,""):e}decodeHtmlEntities(e){const t=document.createElement("div");return t.innerHTML=e,t.textContent}formatDate(e){if(!e)return"-";return new Date(e).toLocaleDateString()}loadOptimizedImage(e,t,s=null){if(this.isWebPSupported()&&t.includes("discogs.com")&&!t.includes("fm=webp")){const a=t.includes("?")?t+"&fm=webp":t+"?fm=webp";e.src=a,e.onerror=()=>{e.src=t,s&&(e.onerror=()=>{e.src=s})}}else e.src=t,s&&(e.onerror=()=>{e.src=s})}isWebPSupported(){const e=document.createElement("canvas");return e.width=1,e.height=1,0===e.toDataURL("image/webp").indexOf("data:image/webp")}generateStarRating(e){const t=Math.floor(e),s=e%1;let a="";s>=.875?a="filled":s>=.625?a="three-quarter":s>=.375?a="half":s>=.125&&(a="quarter");const o=5-(t+(a?1:0));let n='<span class="stars">';for(let e=0;e<t;e++)n+='<span class="star filled">★</span>';a&&"filled"!==a?n+=`<span class="star ${a}">★</span>`:"filled"===a&&(n+='<span class="star filled">★</span>');for(let e=0;e<o;e++)n+='<span class="star empty">☆</span>';return n+="</span>",n}adjustAutocompletePosition(e,t){const s=e.closest(".modal");if(!s)return;const a=s.querySelector(".modal-content"),o=e.getBoundingClientRect(),n=a.getBoundingClientRect();t.style.top="100%",t.style.bottom="auto",t.style.maxHeight="1200px";const i=n.bottom-o.bottom-20,l=o.top-n.top-20,r=Math.min(t.scrollHeight,1200);i<200&&l>i+100?(t.style.top="auto",t.style.bottom="100%",t.style.maxHeight=`${Math.min(l-20,1200)}px`,t.style.overflowY="auto",t.style.overflowX="hidden"):(t.style.top="100%",t.style.bottom="auto",t.style.maxHeight=i<r?`${Math.max(i-20,300)}px`:`${Math.min(i-20,1200)}px`,t.style.overflowY="auto",t.style.overflowX="hidden");const d=t.offsetWidth,c=e.offsetWidth;d>c&&(t.style.width=`${c}px`),t.style.zIndex="10000",t.style.visibility="visible",t.style.opacity="1"}moveAutocompleteToBody(e,t){if(e.closest(".modal")&&t.parentNode!==document.body){document.body.appendChild(t);const s=e.getBoundingClientRect();t.style.position="fixed",t.style.top=s.bottom+window.scrollY+"px",t.style.left=s.left+"px",t.style.width=s.width+"px",t.style.zIndex="10000",t.style.backgroundColor="white",t.style.border="1px solid #ddd",t.style.borderRadius="4px",t.style.boxShadow="0 2px 8px rgba(0,0,0,0.1)",t.style.display="block",t.style.visibility="visible",t.style.opacity="1",t.dataset.originalContainer=e.id}}async setupThemeCustomization(){await this.loadThemeColors(),await this.setupDisplayMode();const e=document.getElementById("gradientColor1"),t=document.getElementById("gradientColor2"),s=document.getElementById("gradientColor1Hex"),a=document.getElementById("gradientColor2Hex"),o=document.getElementById("resetThemeBtn"),n=document.getElementById("saveThemeBtn");e&&e.addEventListener("change",e=>{s.value=e.target.value,this.previewTheme()}),t&&t.addEventListener("change",e=>{a.value=e.target.value,this.previewTheme()}),s&&s.addEventListener("input",t=>{const s=t.target.value;this.isValidHexColor(s)&&(e.value=s,this.previewTheme())}),a&&a.addEventListener("input",e=>{const s=e.target.value;this.isValidHexColor(s)&&(t.value=s,this.previewTheme())}),o&&o.addEventListener("click",()=>{this.resetTheme()}),n&&n.addEventListener("click",()=>{this.saveThemeColors(),this.showThemeMessage("Theme colors saved successfully!","success")})}async loadThemeColors(){try{const e=await fetch("api/theme_api.php"),t=await e.json();if(t.success){const e=t.data.gradient_color_1,s=t.data.gradient_color_2,a=localStorage.getItem("gradientColor1"),o=localStorage.getItem("gradientColor2");a&&o&&(a!==e||o!==s)&&(console.log("localStorage colors differ from server, updating localStorage"),localStorage.setItem("gradientColor1",e),localStorage.setItem("gradientColor2",s)),this.updateColorPickerInputs(e,s),this.applyThemeColors(e,s)}else console.warn("Server theme load failed:",t.message),this.fallbackToLocalStorage()}catch(e){console.warn("Server theme load error:",e),this.fallbackToLocalStorage()}}fallbackToLocalStorage(){const e=localStorage.getItem("gradientColor1")||"#667eea",t=localStorage.getItem("gradientColor2")||"#764ba2";console.log("Falling back to localStorage:",e,t),this.updateColorPickerInputs(e,t),this.applyThemeColors(e,t)}updateColorPickerInputs(e,t){const s=document.getElementById("gradientColor1"),a=document.getElementById("gradientColor1Hex"),o=document.getElementById("gradientColor2"),n=document.getElementById("gradientColor2Hex");s&&a&&o&&n&&(s.value=e,a.value=e,o.value=t,n.value=t)}async saveThemeColors(){const e=document.getElementById("gradientColor1").value,t=document.getElementById("gradientColor2").value;localStorage.setItem("gradientColor1",e),localStorage.setItem("gradientColor2",t),this.applyThemeColors(e,t);try{const s=await fetch("api/theme_api.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({gradient_color_1:e,gradient_color_2:t})}),a=await s.json();a.success||console.warn("Failed to save theme to server:",a.message)}catch(e){console.warn("Failed to save theme to server:",e)}}applyThemeColors(e,t){document.body.style.background=`linear-gradient(135deg, ${e} 0%, ${t} 100%)`}previewTheme(){const e=document.getElementById("gradientColor1").value,t=document.getElementById("gradientColor2").value;this.applyThemeColors(e,t)}resetTheme(){const e="#667eea",t="#764ba2",s=document.getElementById("gradientColor1"),a=document.getElementById("gradientColor1Hex"),o=document.getElementById("gradientColor2"),n=document.getElementById("gradientColor2Hex");s&&a&&o&&n&&(s.value=e,a.value=e,o.value=t,n.value=t,this.applyThemeColors(e,t),this.saveThemeColors())}async setupDisplayMode(){await this.loadDisplayMode();const e=document.getElementById("lightMode"),t=document.getElementById("darkMode");e&&t&&(e.addEventListener("change",()=>{this.updateRadioButtonStyles()}),t.addEventListener("change",()=>{this.updateRadioButtonStyles()}));const s=document.getElementById("saveDisplayModeBtn");s&&s.addEventListener("click",()=>{this.saveDisplayMode()})}async loadDisplayMode(){try{const e=await fetch("api/theme_api.php?type=display_mode"),t=await e.json();if(t.success){const e=t.data.theme,s=localStorage.getItem("theme");s&&s!==e&&localStorage.setItem("theme",e),this.applyDisplayMode(e),this.updateDisplayModeRadioButtons(e)}else this.loadDisplayModeFromLocalStorage()}catch(e){this.loadDisplayModeFromLocalStorage()}}loadDisplayModeFromLocalStorage(){const e=localStorage.getItem("theme")||"light";this.applyDisplayMode(e),this.updateDisplayModeRadioButtons(e)}updateDisplayModeRadioButtons(e){const t=document.getElementById("lightMode"),s=document.getElementById("darkMode");t&&s&&("dark"===e?s.checked=!0:t.checked=!0,this.updateRadioButtonStyles())}async saveDisplayMode(){const e=document.getElementById("lightMode"),t=document.getElementById("darkMode");if(!e||!t)return;const s=e.checked?"light":"dark";try{const e=await fetch("api/theme_api.php?type=display_mode",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({theme:s})}),t=await e.json();t.success?(localStorage.setItem("theme",s),this.applyDisplayMode(s),this.showMessage("Display mode saved successfully!","success")):this.showMessage("Failed to save display mode: "+t.message,"error")}catch(e){localStorage.setItem("theme",s),this.applyDisplayMode(s),this.showMessage("Display mode saved locally (server unavailable)","warning")}}applyDisplayMode(e){document.documentElement.getAttribute("data-theme")!==e&&("dark"===e?document.documentElement.setAttribute("data-theme","dark"):document.documentElement.setAttribute("data-theme","light"))}updateRadioButtonStyles(){const e=document.getElementById("lightMode"),t=document.getElementById("darkMode");e&&t&&(e.closest(".radio-option")?.classList.remove("checked"),t.closest(".radio-option")?.classList.remove("checked"),e.checked?e.closest(".radio-option")?.classList.add("checked"):t.checked&&t.closest(".radio-option")?.classList.add("checked"))}isValidHexColor(e){return/^#[0-9A-Fa-f]{6}$/.test(e)}showSetupMessage(e,t){const s=document.getElementById("setupMessage");s&&(s.textContent=e,s.className=`modal-message ${t}`,s.style.display="block",setTimeout(()=>{s.style.display="none"},3e3))}showThemeMessage(e,t){const s=document.getElementById("themeMessage");s&&(s.textContent=e,s.className=`modal-message ${t}`,s.style.display="block",setTimeout(()=>{s.style.display="none"},3e3))}async clearAllCaches(){try{if("caches"in window){const e=await caches.keys();await Promise.all(e.map(e=>caches.delete(e)))}const e="shownNotifications_"+this.browserId,t=localStorage.getItem(e),s=localStorage.getItem("browserId");localStorage.clear(),sessionStorage.clear(),s&&localStorage.setItem("browserId",s),t&&localStorage.setItem(e,t),this.selectedArtist=null,this.selectedAlbum=null,this.selectedCoverUrl=null,this.selectedDiscogsReleaseId=null;const a=new URL(window.location.href);a.searchParams.set("_cache_clear",Date.now()),a.searchParams.set("cache_cleared","true"),window.location.href=a.toString()}catch(e){console.error("Error clearing caches:",e),this.showMessage("Error clearing caches. Please try again.","error")}}handleSort(e){this.currentSort.field===e?this.currentSort.direction="asc"===this.currentSort.direction?"desc":"asc":(this.currentSort.field=e,this.currentSort.direction="asc"),this.updateSortIndicators(),this.renderAlbumsWithSort()}updateSortIndicators(){document.querySelectorAll(".sortable-header").forEach(e=>{e.classList.remove("sort-asc","sort-desc")});const e=document.querySelector(`[data-sort="${this.currentSort.field}"]`);e&&e.classList.add(`sort-${this.currentSort.direction}`)}renderAlbumsWithSort(){const e=document.querySelector("#albumsTable tbody"),t=Array.from(e.querySelectorAll("tr")).map(e=>{if(e.classList.contains("empty-state"))return null;const t=e.querySelector(".artist-name")?.textContent||"",s=e.querySelector(".album-name a")?.textContent||"",a=e.querySelector(".year-link"),o=a?a.dataset.year:"",n="✓"===e.querySelector("td:nth-child(4) .checkmark")?.textContent,i="✓"===e.querySelector("td:nth-child(5) .checkmark")?.textContent;return{id:e.dataset.id,artist_name:t,album_name:s,release_year:o,is_owned:n?1:0,want_to_own:i?1:0,cover_url:e.querySelector(".album-cover")?.dataset.src||"",cover_url_medium:e.querySelector(".album-cover")?.dataset.medium||"",cover_url_large:e.querySelector(".album-cover")?.dataset.large||"",artist_type:e.dataset.artistType||null}}).filter(e=>null!==e),s=this.sortAlbums(t);this.renderAlbums(s)}sortAlbums(e){return e.sort((e,t)=>{const s=e.artist_type||null,a=t.artist_type||null;if("year"===this.currentSort.field){const o=parseInt(e.release_year)||0,n=parseInt(t.release_year)||0;return"desc"===this.currentSort.direction?o!==n?n-o:this.getSortableArtistName(e.artist_name,s).localeCompare(this.getSortableArtistName(t.artist_name,a)):o!==n?o-n:this.getSortableArtistName(e.artist_name,s).localeCompare(this.getSortableArtistName(t.artist_name,a))}if("album"===this.currentSort.field){const o=this.getSortableArtistName(e.artist_name,s).localeCompare(this.getSortableArtistName(t.artist_name,a));if("desc"===this.currentSort.direction){if(0!==o)return-o;const s=parseInt(e.release_year)||0,a=parseInt(t.release_year)||0;return s!==a?s-a:this.getSortableAlbumName(e.album_name).localeCompare(this.getSortableAlbumName(t.album_name))}{if(0!==o)return o;const s=parseInt(e.release_year)||0,a=parseInt(t.release_year)||0;return s!==a?s-a:this.getSortableAlbumName(e.album_name).localeCompare(this.getSortableAlbumName(t.album_name))}}return this.getSortableArtistName(e.artist_name,s).localeCompare(this.getSortableArtistName(t.artist_name,a))})}getSortableArtistName(e,t=null){if(!e)return"";const s=e.trim(),a=s.toLowerCase();if(a.includes("elvis costello")&&a.includes("attractions"))return"Costello, Elvis & The Attractions";const o=["the ","a ","an "];for(const e of o)if(a.startsWith(e))return s.substring(e.length).trim();if(t){if("group"===t.toLowerCase())return s;if("person"===t.toLowerCase()){const e=s.split(" ");if(2===e.length){const t=e[0],s=e[1];return["jr","sr","ii","iii","iv","v","vi","vii","viii","ix","x"].includes(s.toLowerCase())&&e.length>2?e[e.length-2]+", "+e.slice(0,-2).join(" ")+" "+e[e.length-1]:s+", "+t}return s}}const n=s.split(" "),i=["&","and","featuring","feat","ft","with","vs","versus"].some(e=>a.includes(e)),l=n[n.length-1],r=/^\d+$/.test(l);if(!(i||r||n.length>3)&&2===n.length){const e=n[0],t=n[1];return["jr","sr","ii","iii","iv","v","vi","vii","viii","ix","x"].includes(t.toLowerCase())&&n.length>2?n[n.length-2]+", "+n.slice(0,-2).join(" ")+" "+n[n.length-1]:t+", "+e}return s}getSortableAlbumName(e){if(!e)return"";const t=e.trim(),s=t.toLowerCase(),a=["the ","a ","an "];for(const e of a)if(s.startsWith(e))return t.substring(e.length).trim();return t}}document.addEventListener("DOMContentLoaded",async()=>{window.app=new MusicCollectionApp,document.body.classList.contains("setup-page")?await window.app.initSetupPage():await window.app.init()});