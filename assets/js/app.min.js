class MusicCollectionApp{constructor(){this.currentFilter='owned';this.currentSearch='';this.currentStyleFilter='';this.currentFormatFilter='';this.currentYearFilter='';this.editingAlbum=null;this.autocompleteTimeout=null;this.artistAutocompleteTimeout=null;this.albumAutocompleteTimeout=null;this.isAuthenticated=!1;this.currentSort={field:'artist',direction:'asc'}}
async fetchWithCache(url,options={}){const defaultOptions={cache:'default',headers:{'Content-Type':'application/json',...options.headers}};return fetch(url,{...defaultOptions,...options})}
async init(){this.checkAuthStatus();this.loadStats();this.loadAlbums();this.bindEvents();this.setupAutocomplete();await this.loadThemeColors();this.updateSortIndicators();const urlParams=new URLSearchParams(window.location.search);if(urlParams.get('cache_cleared')==='true'){this.showMessage('All caches cleared successfully. Fresh data loaded.','success');urlParams.delete('cache_cleared');urlParams.delete('_cache_clear');const newUrl=window.location.pathname+(urlParams.toString()?'?'+urlParams.toString():'');window.history.replaceState({},'',newUrl)}}
async checkAuthStatus(){try{const response=await fetch('api/music_api.php?action=auth_status',{cache:'no-cache',headers:{'Content-Type':'application/json'}});const data=await response.json();if(data.success){this.isAuthenticated=data.data.authenticated}}catch(error){this.isAuthenticated=!1}
this.updateAuthUI()}
updateAuthUI(){const addBtn=document.getElementById('addAlbumBtn');const loginBtn=document.getElementById('loginBtn');const logoutBtn=document.getElementById('logoutBtn');if(addBtn){if(this.isAuthenticated){addBtn.textContent='+ Add Album';addBtn.style.display='block';addBtn.style.opacity='1';addBtn.style.cursor='pointer'}else{addBtn.style.display='none'}}
if(loginBtn){loginBtn.style.display=this.isAuthenticated?'none':'flex'}
if(logoutBtn){logoutBtn.style.display=this.isAuthenticated?'flex':'none'}
const editButtons=document.querySelectorAll('.btn-edit');const deleteButtons=document.querySelectorAll('.btn-delete');editButtons.forEach(btn=>{btn.style.display=this.isAuthenticated?'inline-block':'none'});deleteButtons.forEach(btn=>{btn.style.display=this.isAuthenticated?'inline-block':'none'});const actionsHeader=document.querySelector('th:last-child');const actionCells=document.querySelectorAll('td:last-child');if(actionsHeader){actionsHeader.style.display=this.isAuthenticated?'table-cell':'none'}
actionCells.forEach(cell=>{cell.style.display=this.isAuthenticated?'table-cell':'none'});const clearCacheBtn=document.getElementById('clearCacheBtn');if(clearCacheBtn){clearCacheBtn.style.display=this.isAuthenticated?'flex':'none'}
const setupBtn=document.getElementById('setupBtn');if(setupBtn){setupBtn.style.display=this.isAuthenticated?'flex':'none'}
const resetPasswordBtn=document.getElementById('resetPasswordBtn');if(resetPasswordBtn){resetPasswordBtn.style.display=this.isAuthenticated?'flex':'none'}}
bindEvents(){const searchInput=document.getElementById('searchInput');const clearSearchBtn=document.getElementById('clearSearch');searchInput.addEventListener('input',(e)=>{this.currentSearch=e.target.value;this.debounceSearch();if(e.target.value.length>0){clearSearchBtn.classList.add('visible')}else{clearSearchBtn.classList.remove('visible')}
this.handleStyleSearchSuggestions(e.target.value)});clearSearchBtn.addEventListener('click',()=>{searchInput.value='';this.currentSearch='';this.currentStyleFilter='';this.currentFormatFilter='';this.currentYearFilter='';searchInput.disabled=!1;this.debounceSearch();clearSearchBtn.classList.remove('visible');searchInput.focus();const messageEl=document.getElementById('message');if(messageEl&&messageEl.classList.contains('info')){messageEl.style.display='none'}
this.loadStats()});const togglePasswordBtn=document.getElementById('togglePassword');const passwordInput=document.getElementById('password');const eyeIcon=togglePasswordBtn.querySelector('.eye-icon');const eyeSlashIcon=togglePasswordBtn.querySelector('.eye-slash-icon');togglePasswordBtn.addEventListener('click',()=>{const type=passwordInput.getAttribute('type')==='password'?'text':'password';passwordInput.setAttribute('type',type);if(type==='text'){eyeIcon.style.display='none';eyeSlashIcon.style.display='block'}else{eyeIcon.style.display='block';eyeSlashIcon.style.display='none'}});const resetPasswordFields=[{inputId:'reset_current_password',buttonId:'toggleResetCurrentPassword'},{inputId:'reset_new_password',buttonId:'toggleResetNewPassword'},{inputId:'reset_confirm_password',buttonId:'toggleResetConfirmPassword'}];resetPasswordFields.forEach(field=>{const toggleBtn=document.getElementById(field.buttonId);const passwordInput=document.getElementById(field.inputId);const eyeIcon=toggleBtn.querySelector('.eye-icon');const eyeSlashIcon=toggleBtn.querySelector('.eye-slash-icon');toggleBtn.addEventListener('click',()=>{const type=passwordInput.getAttribute('type')==='password'?'text':'password';passwordInput.setAttribute('type',type);if(type==='text'){eyeIcon.style.display='none';eyeSlashIcon.style.display='block'}else{eyeIcon.style.display='block';eyeSlashIcon.style.display='none'}})});document.querySelectorAll('.filter-btn').forEach(btn=>{btn.addEventListener('click',(e)=>{this.setFilter(e.target.dataset.filter)})});document.getElementById('addAlbumBtn').addEventListener('click',()=>{this.showModal()});const viewRecordBtn=document.getElementById('viewRecordBtn');if(viewRecordBtn){viewRecordBtn.addEventListener('click',()=>{this.showViewRecordModal()})}
const viewRecordModalClose=document.querySelector('#viewRecordModal .close');if(viewRecordModalClose){viewRecordModalClose.addEventListener('click',()=>{this.hideViewRecordModal()})}
const viewRecordModalCancel=document.querySelector('#viewRecordModal .btn-cancel');if(viewRecordModalCancel){viewRecordModalCancel.addEventListener('click',()=>{this.hideViewRecordModal()})}
const viewRecordCloseBtn=document.getElementById('viewRecordCloseBtn');if(viewRecordCloseBtn){viewRecordCloseBtn.addEventListener('click',()=>{this.hideViewRecordModal()})}
const editRecordBtn=document.getElementById('editRecordBtn');if(editRecordBtn){editRecordBtn.addEventListener('click',()=>{this.enableRecordEditing()})}
const saveRecordBtn=document.getElementById('saveRecordBtn');if(saveRecordBtn){saveRecordBtn.addEventListener('click',()=>{this.saveRecordChanges()})}
const cancelEditBtn=document.getElementById('cancelEditBtn');if(cancelEditBtn){cancelEditBtn.addEventListener('click',()=>{this.cancelRecordEditing()})}
const clearCacheBtn=document.getElementById('clearCacheBtn');if(clearCacheBtn){clearCacheBtn.addEventListener('click',()=>{this.clearAllCaches()})}
document.getElementById('albumModal').addEventListener('click',(e)=>{if(e.target.id==='albumModal'){this.hideModal()}});document.getElementById('coverModal').addEventListener('click',(e)=>{if(e.target.id==='coverModal'){this.hideCoverModal()}});document.getElementById('tracklistModal').addEventListener('click',(e)=>{if(e.target.id==='tracklistModal'){this.hideTracklistModal()}});document.getElementById('tracklistEditBtn').addEventListener('click',(e)=>{e.preventDefault();e.stopPropagation();this.handleTracklistEdit()});document.querySelectorAll('.close').forEach(closeBtn=>{closeBtn.addEventListener('click',(e)=>{e.preventDefault();e.stopPropagation();const modal=closeBtn.closest('.modal');if(modal){if(modal.id==='albumModal'){this.hideModal()}else if(modal.id==='coverModal'){this.hideCoverModal()}else if(modal.id==='tracklistModal'){this.hideTracklistModal()}else if(modal.id==='loginModal'){this.hideLoginModal()}else if(modal.id==='statsModal'){this.hideStatsModal()}else if(modal.id==='resetPasswordModal'){this.hideResetPasswordModal()}else if(modal.id==='setupModal'){this.hideSetupModal()}else if(modal.id==='viewRecordModal'){this.hideViewRecordModal()}}});closeBtn.addEventListener('touchend',(e)=>{e.preventDefault();e.stopPropagation();const modal=closeBtn.closest('.modal');if(modal){if(modal.id==='albumModal'){this.hideModal()}else if(modal.id==='coverModal'){this.hideCoverModal()}else if(modal.id==='tracklistModal'){this.hideTracklistModal()}else if(modal.id==='loginModal'){this.hideLoginModal()}else if(modal.id==='statsModal'){this.hideStatsModal()}else if(modal.id==='resetPasswordModal'){this.hideResetPasswordModal()}else if(modal.id==='setupModal'){this.hideSetupModal()}else if(modal.id==='viewRecordModal'){this.hideViewRecordModal()}}})});document.getElementById('loginModal').addEventListener('click',(e)=>{if(e.target.id==='loginModal'){this.hideLoginModal()}});document.getElementById('loginForm').addEventListener('submit',(e)=>{e.preventDefault();this.handleLogin(e)});document.querySelector('#loginModal .btn-cancel').addEventListener('click',()=>{this.hideLoginModal()});document.getElementById('statsModal').addEventListener('click',(e)=>{if(e.target.id==='statsModal'){this.hideStatsModal()}});document.querySelector('#statsModal .btn-cancel').addEventListener('click',()=>{this.hideStatsModal()});document.getElementById('resetPasswordModal').addEventListener('click',(e)=>{if(e.target.id==='resetPasswordModal'){this.hideResetPasswordModal()}});document.getElementById('resetPasswordForm').addEventListener('submit',(e)=>{e.preventDefault();this.handleResetPassword(e)});document.querySelector('#resetPasswordModal .btn-cancel').addEventListener('click',()=>{this.hideResetPasswordModal()});document.querySelector('#resetPasswordModal .close').addEventListener('click',()=>{this.hideResetPasswordModal()});document.getElementById('setupModal').addEventListener('click',(e)=>{if(e.target.id==='setupModal'){this.hideSetupModal()}});document.getElementById('setupForm').addEventListener('submit',(e)=>{e.preventDefault();this.handleSetupConfig(e)});document.querySelector('#setupModal .btn-cancel').addEventListener('click',()=>{this.hideSetupModal()});document.querySelector('#setupModal .close').addEventListener('click',()=>{this.hideSetupModal()});document.getElementById('setupPasswordBtn').addEventListener('click',()=>{this.hideSetupModal();this.showResetPasswordModal()});document.getElementById('albumsTable').addEventListener('click',(e)=>{if(e.target.classList.contains('album-cover')){const artist=e.target.dataset.artist;const album=e.target.dataset.album;const year=e.target.dataset.year;const cover=e.target.dataset.cover;const albumId=e.target.closest('tr').dataset.id;this.showCoverModal(artist,album,year,cover,albumId)}
if(e.target.classList.contains('album-link')){e.preventDefault();const artist=e.target.dataset.artist;const album=e.target.dataset.album;const year=e.target.dataset.year;const albumId=e.target.closest('tr').dataset.id;this.showTracklist(artist,album,year,albumId)}
if(e.target.classList.contains('year-link')||e.target.closest('.year-link')){e.preventDefault();const yearLink=e.target.classList.contains('year-link')?e.target:e.target.closest('.year-link');const year=yearLink.dataset.year;if(year){this.filterByYear(year)}}
if(e.target.classList.contains('btn-edit')){const id=e.target.dataset.id;if(id){this.editAlbum(parseInt(id))}}
if(e.target.classList.contains('btn-delete')){const id=e.target.dataset.id;if(id){this.deleteAlbum(parseInt(id))}}});document.getElementById('albumForm').addEventListener('submit',(e)=>{e.preventDefault();this.saveAlbum()});const releaseYearInput=document.getElementById('releaseYear');const albumFormatInput=document.getElementById('albumFormat');if(releaseYearInput){releaseYearInput.addEventListener('input',()=>{this.updateSaveButtonState()});releaseYearInput.addEventListener('change',()=>{this.updateSaveButtonState()})}
if(albumFormatInput){albumFormatInput.addEventListener('input',()=>{this.updateSaveButtonState()});albumFormatInput.addEventListener('change',()=>{this.updateSaveButtonState()})}
document.getElementById('cancelBtn').addEventListener('click',()=>{this.hideModal()});document.querySelectorAll('.sortable-header').forEach(header=>{header.addEventListener('click',(e)=>{const sortField=e.currentTarget.dataset.sort;this.handleSort(sortField)})})}
setupAutocomplete(){const artistInput=document.getElementById('artistName');const albumInput=document.getElementById('albumName');this.updateAlbumInputState();artistInput.addEventListener('input',(e)=>{this.debounceArtistAutocomplete(e.target.value);this.updateAlbumInputState()});albumInput.addEventListener('input',(e)=>{const artistValue=artistInput.value.trim();if(artistValue&&artistValue.length>0){this.debounceAlbumAutocomplete(artistValue,e.target.value)}else{this.hideAutocomplete('albumAutocomplete')}});artistInput.addEventListener('input',(e)=>{if(!e.target.value.trim()){this.hideAutocomplete('albumAutocomplete');albumInput.value='';this.updateAlbumInputState()}});artistInput.addEventListener('blur',(e)=>{setTimeout(()=>{this.hideAutocomplete('artistAutocomplete')},500)});albumInput.addEventListener('blur',(e)=>{setTimeout(()=>{this.hideAutocomplete('albumAutocomplete')},500)});document.addEventListener('click',(e)=>{if(!e.target.closest('.autocomplete-container')){this.hideAutocomplete('artistAutocomplete');this.hideAutocomplete('albumAutocomplete')}});const formatFilter=document.getElementById('formatFilter');if(formatFilter){formatFilter.addEventListener('change',(e)=>{const artistValue=artistInput.value.trim();const albumValue=albumInput.value.trim();if(artistValue&&albumValue&&albumValue.length>=2){this.debounceAlbumAutocomplete(artistValue,albumValue)}})}
this.setupDropdown()}
setupDropdown(){const dropdown=document.querySelector('.dropdown');const dropdownMenu=document.querySelector('.dropdown-menu');if(dropdown&&dropdownMenu){dropdownMenu.addEventListener('click',(e)=>{e.stopPropagation()});document.addEventListener('click',(e)=>{if(!dropdown.contains(e.target)){dropdown.classList.remove('active')}});dropdown.addEventListener('keydown',(e)=>{if(e.key==='Escape'){dropdown.classList.remove('active');dropdown.querySelector('.dropdown-toggle').blur()}})}}
updateAlbumInputState(){const artistInput=document.getElementById('artistName');const albumInput=document.getElementById('albumName');if(artistInput&&albumInput){const artistValue=artistInput.value.trim();if(artistValue&&artistValue.length>0){albumInput.disabled=!1;albumInput.placeholder='Enter album name...'}else{albumInput.disabled=!0;albumInput.placeholder='Select an artist first...'}}
this.updateSaveButtonState()}
updateSaveButtonState(){const saveButton=document.querySelector('#albumForm .btn-save');const releaseYearInput=document.getElementById('releaseYear');const albumFormatInput=document.getElementById('albumFormat');if(saveButton&&releaseYearInput&&albumFormatInput){const hasReleaseYear=releaseYearInput.value.trim()!=='';const hasAlbumFormat=albumFormatInput.value.trim()!=='';if(hasReleaseYear&&hasAlbumFormat){saveButton.disabled=!1;saveButton.style.opacity='1';saveButton.style.cursor='pointer'}else{saveButton.disabled=!0;saveButton.style.opacity='0.5';saveButton.style.cursor='not-allowed'}}}
debounceArtistAutocomplete(search){clearTimeout(this.artistAutocompleteTimeout);this.artistAutocompleteTimeout=setTimeout(()=>{this.handleArtistAutocomplete(search)},300)}
debounceAlbumAutocomplete(artist,search){clearTimeout(this.albumAutocompleteTimeout);this.albumAutocompleteTimeout=setTimeout(()=>{this.handleAlbumAutocomplete(artist,search)},300)}
async handleArtistAutocomplete(search){if(search.length<2){this.hideAutocomplete('artistAutocomplete');return}
this.showAutocompleteLoading('artistAutocomplete');try{const url=`api/music_api.php?action=artists&search=${encodeURIComponent(search)}`;const response=await this.fetchWithCache(url);const data=await response.json();if(data.success){this.showAutocomplete('artistAutocomplete',data.data,'artist_name')}else{this.hideAutocomplete('artistAutocomplete')}}catch(error){this.hideAutocomplete('artistAutocomplete')}}
async handleAlbumAutocomplete(artist,search){if(search.length<2){this.hideAutocomplete('albumAutocomplete');return}
this.showAutocompleteLoading('albumAutocomplete');try{const formatFilter=document.getElementById('formatFilter')?.value||'';let url=`api/music_api.php?action=albums_by_artist&artist=${encodeURIComponent(artist)}&search=${encodeURIComponent(search)}`;if(formatFilter){url+=`&format=${encodeURIComponent(formatFilter)}`}
const response=await this.fetchWithCache(url);const data=await response.json();if(data.success){this.showAutocomplete('albumAutocomplete',data.data,'album_name')}else{this.hideAutocomplete('albumAutocomplete')}}catch(error){this.hideAutocomplete('albumAutocomplete')}}
showAutocomplete(containerId,items,field){const container=document.getElementById(containerId);let list=container.querySelector('.autocomplete-list');if(!list){list=document.querySelector(`[data-original-container="${containerId}"]`)}
if(!list){return}
list.innerHTML='';items.forEach(item=>{if(item&&item[field]&&item[field]!=='undefined'){const div=document.createElement('div');div.className='autocomplete-item';const textSpan=document.createElement('span');if(field==='album_name'&&item.year){textSpan.textContent=`${item[field]} (${item.year})`}else{textSpan.textContent=item[field]}
if(field==='album_name'&&item.format){textSpan.innerHTML=textSpan.textContent+'<br><span class="format-text">'+item.format+'</span>'}
div.appendChild(textSpan);if(item.cover_url){const coverImg=document.createElement('img');coverImg.src=item.cover_url;coverImg.className='autocomplete-cover';coverImg.alt='Album cover';coverImg.onerror=()=>{coverImg.remove()};coverImg.onload=()=>{};div.appendChild(coverImg)}
div.addEventListener('click',(e)=>{e.preventDefault();e.stopPropagation();this.selectAutocompleteItem(containerId,item[field],item)});list.appendChild(div)}});if(list.children.length>0){list.style.display='block';list.style.visibility='visible';list.style.opacity='1';list.style.zIndex='10000';list.style.position='absolute';list.style.backgroundColor='white';list.style.border='1px solid #ddd';list.style.borderRadius='4px';list.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)';list.style.maxHeight='1200px';list.style.overflowY='auto';this.adjustAutocompletePosition(container,list);setTimeout(()=>{this.adjustAutocompletePosition(container,list)},10)}else{list.style.display='none'}}
showAutocompleteLoading(containerId){const container=document.getElementById(containerId);let list=container.querySelector('.autocomplete-list');if(!list){list=document.querySelector(`[data-original-container="${containerId}"]`)}
if(list){list.innerHTML='<div class="autocomplete-loading">Searching...</div>';list.style.display='block'}}
hideAutocomplete(containerId){const container=document.getElementById(containerId);let list=container.querySelector('.autocomplete-list');if(!list){list=document.querySelector(`[data-original-container="${containerId}"]`)}
if(list){list.style.display='none';list.style.visibility='hidden';list.style.opacity='0';if(list.parentNode===document.body&&list.dataset.originalContainer){const originalContainer=document.getElementById(list.dataset.originalContainer);if(originalContainer){originalContainer.appendChild(list);list.style.position='';list.style.top='';list.style.left='';list.style.width='';list.style.zIndex='';delete list.dataset.originalContainer}}}}
selectAutocompleteItem(containerId,value,item=null){const container=document.getElementById(containerId);const input=container.querySelector('input');if(input){if(containerId==='albumAutocomplete'){input.value=value}else{input.value=value}
if(item){if(containerId==='artistAutocomplete'){this.selectedArtist=item}else if(containerId==='albumAutocomplete'){this.selectedAlbum=item;this.selectedDiscogsReleaseId=item.id||null;this.selectedCoverUrl=item.cover_url||null;const yearInput=document.getElementById('releaseYear');if(yearInput){if(item.master_year){yearInput.value=item.master_year}else if(item.id){yearInput.value='';this.fetchMasterYearForSelection(item.id,yearInput,item.year)}else{yearInput.value=item.year||''}}
const formatInput=document.getElementById('albumFormat');if(formatInput&&item.format){formatInput.value=item.format;formatInput.readOnly=!1}
this.updateSaveButtonState()}}}
this.hideAutocomplete(containerId)}
debounceSearch(){clearTimeout(this.autocompleteTimeout);this.autocompleteTimeout=setTimeout(()=>{this.loadAlbums()},300)}
setFilter(filter){this.currentFilter=filter;document.querySelectorAll('.filter-btn').forEach(btn=>{btn.classList.remove('active')});document.querySelector(`[data-filter="${filter}"]`).classList.add('active');this.loadAlbums()}
filterByStyle(style){this.hideStatsModal();this.currentStyleFilter=style;const originalFilter=this.currentFilter;this.currentFilter='all';const searchInput=document.getElementById('searchInput');const clearSearchBtn=document.getElementById('clearSearch');if(searchInput){searchInput.value=`Style: ${style}`;searchInput.disabled=!0;clearSearchBtn.classList.add('visible')}
this.showMessage(`Filtering by style: ${style}`,'info');this.loadAlbums();this.currentFilter=originalFilter}
filterByFormat(format){this.hideStatsModal();this.currentFormatFilter=format;const originalFilter=this.currentFilter;this.currentFilter='all';const searchInput=document.getElementById('searchInput');const clearSearchBtn=document.getElementById('clearSearch');if(searchInput){searchInput.value=`Format: ${format}`;searchInput.disabled=!0;clearSearchBtn.classList.add('visible')}
this.showMessage(`Filtering by format: ${format}`,'info');this.loadAlbums();this.currentFilter=originalFilter}
clearStyleFilter(){this.currentStyleFilter='';this.currentFormatFilter='';this.currentYearFilter='';const searchInput=document.getElementById('searchInput');if(searchInput){searchInput.value='';searchInput.disabled=!1}
this.loadAlbums()}
clearFormatFilter(){this.currentFormatFilter='';this.currentStyleFilter='';this.currentYearFilter='';const searchInput=document.getElementById('searchInput');if(searchInput){searchInput.value='';searchInput.disabled=!1}
this.loadAlbums()}
filterByYear(year){this.hideStatsModal();this.currentYearFilter=year;const originalFilter=this.currentFilter;this.currentFilter='all';const searchInput=document.getElementById('searchInput');const clearSearchBtn=document.getElementById('clearSearch');if(searchInput){searchInput.value=`Year: ${year}`;searchInput.disabled=!0;clearSearchBtn.classList.add('visible')}
this.showMessage(`Filtering by year: ${year}`,'info');this.loadAlbums();this.currentFilter=originalFilter}
clearYearFilter(){this.currentYearFilter='';this.currentStyleFilter='';this.currentFormatFilter='';const searchInput=document.getElementById('searchInput');if(searchInput){searchInput.value='';searchInput.disabled=!1}
this.loadAlbums()}
handleStyleSearchSuggestions(searchValue){const searchLower=searchValue.toLowerCase();if(searchLower.startsWith('style:')||searchLower.startsWith('genre:')||searchLower.startsWith('type:')){const styleTerm=searchValue.replace(/^(style|genre|type):\s*/i,'').trim();if(styleTerm===''){this.showMessage('Type a style name after "style:" (e.g., style: rock, style: jazz)','info')}else if(styleTerm.length>0){const messageEl=document.getElementById('message');if(messageEl&&messageEl.classList.contains('info')){messageEl.style.display='none'}}}}
async loadStats(){try{const response=await fetch('api/music_api.php?action=stats');const data=await response.json();if(data.success){this.updateStats(data.data)}}catch(error){}}
updateStats(stats){const ownButton=document.querySelector('[data-filter="owned"]');const wantButton=document.querySelector('[data-filter="wanted"]');const allButton=document.querySelector('[data-filter="all"]');if(ownButton){const ownedCount=stats.owned_count||0;ownButton.textContent=`${ownedCount} Owned`}
if(wantButton){const wantedCount=stats.wanted_count||0;wantButton.textContent=`${wantedCount} Want`}
if(allButton){const totalCount=stats.total_albums||0;allButton.textContent=`${totalCount} Total`}
const styleStatsList=document.getElementById('styleStatsList');if(styleStatsList&&stats.style_counts){const styleEntries=Object.entries(stats.style_counts);if(styleEntries.length>0){const allStyles=styleEntries;styleStatsList.innerHTML=allStyles.map(([style,count])=>`
                  <div class="style-stat-item" data-style="${this.escapeHtml(style)}">
                      <span class="style-name">${this.escapeHtml(style)}</span>
                      <span class="style-count">${count}</span>
                  </div>
              `).join('');styleStatsList.querySelectorAll('.style-stat-item').forEach(item=>{item.addEventListener('click',(e)=>{e.preventDefault();const style=item.dataset.style;this.filterByStyle(style)})})}else{styleStatsList.innerHTML='<p class="no-styles">No style information available</p>'}}
const formatStatsList=document.getElementById('formatStatsList');if(formatStatsList&&stats.format_counts){const formatEntries=Object.entries(stats.format_counts);if(formatEntries.length>0){const allFormats=formatEntries;formatStatsList.innerHTML=allFormats.map(([format,count])=>`
                  <div class="format-stat-item" data-format="${encodeURIComponent(format)}">
                      <span class="format-name">${this.escapeHtml(format)}</span>
                      <span class="format-count">${count}</span>
                  </div>
              `).join('');formatStatsList.querySelectorAll('.format-stat-item').forEach(item=>{item.addEventListener('click',(e)=>{e.preventDefault();const format=decodeURIComponent(item.dataset.format);this.filterByFormat(format)})})}else{formatStatsList.innerHTML='<p class="no-formats">No format information available</p>'}}
const yearStatsList=document.getElementById('yearStatsList');if(yearStatsList&&stats.year_counts){const yearEntries=Object.entries(stats.year_counts);yearEntries.sort((a,b)=>{const countDiff=b[1]-a[1];if(countDiff!==0)return countDiff;return b[0]-a[0]});if(yearEntries.length>0){yearStatsList.innerHTML=yearEntries.map(([year,count])=>`
                  <div class="year-stat-item" data-year="${year}">
                      <span class="year-name">${this.escapeHtml(year)}</span>
                      <span class="year-count">${count}</span>
                  </div>
              `).join('');yearStatsList.querySelectorAll('.year-stat-item').forEach(item=>{item.addEventListener('click',(e)=>{e.preventDefault();const year=item.dataset.year;this.filterByYear(year)})})}else{yearStatsList.innerHTML='<p class="no-years">No year information available</p>'}}}
updateFilterButtonsWithFilteredCount(filteredAlbums){const hasActiveFilters=this.currentSearch||this.currentStyleFilter||this.currentFormatFilter||this.currentYearFilter;if(!hasActiveFilters){return}
const totalCount=filteredAlbums.length;const ownedCount=filteredAlbums.filter(album=>album.is_owned==1).length;const wantedCount=filteredAlbums.filter(album=>album.want_to_own==1).length;const ownButton=document.querySelector('[data-filter="owned"]');const wantButton=document.querySelector('[data-filter="wanted"]');const allButton=document.querySelector('[data-filter="all"]');if(ownButton){ownButton.textContent=`${ownedCount} Owned`}
if(wantButton){wantButton.textContent=`${wantedCount} Want`}
if(allButton){allButton.textContent=`${totalCount} Total`}}
async loadAlbums(){this.showLoading();const tableContainer=document.querySelector('.table-container');if(tableContainer){tableContainer.classList.add('loading')}
try{const searchLower=this.currentSearch.toLowerCase();const styleKeywords=['style:','genre:','type:'];const isStyleSearch=styleKeywords.some(keyword=>searchLower.startsWith(keyword));const searchParam=isStyleSearch?'':this.currentSearch;const hasActiveFilters=this.currentSearch||this.currentStyleFilter||this.currentFormatFilter||this.currentYearFilter;const filterToUse=hasActiveFilters?'all':this.currentFilter;const params=new URLSearchParams({action:'albums',filter:filterToUse,search:searchParam});const response=await this.fetchWithCache(`api/music_api.php?${params}`);const data=await response.json();if(data.success){let albums=data.data;if(this.currentStyleFilter){albums=albums.filter(album=>{if(!album.style)return!1;const styles=album.style.split(',').map(s=>s.trim());return styles.includes(this.currentStyleFilter)})}
if(this.currentFormatFilter){albums=albums.filter(album=>{if(!album.format)return!1;const formats=album.format.split(',').map(f=>f.trim());return formats.some(format=>{const unescapedFormat=format.replace(/\\"/g,'"');return unescapedFormat===this.currentFormatFilter})})}
if(this.currentYearFilter){albums=albums.filter(album=>{return album.release_year==this.currentYearFilter})}
if(this.currentSearch&&!this.currentStyleFilter){const searchLower=this.currentSearch.toLowerCase();const styleKeywords=['style:','genre:','type:'];const hasStyleKeyword=styleKeywords.some(keyword=>searchLower.startsWith(keyword));if(hasStyleKeyword){const styleSearchTerm=this.currentSearch.replace(/^(style|genre|type):\s*/i,'').trim();if(styleSearchTerm){albums=albums.filter(album=>{if(!album.style)return!1;const styles=album.style.toLowerCase();const searchTerm=styleSearchTerm.toLowerCase();const styleArray=styles.split(',').map(s=>s.trim().toLowerCase());return styleArray.some(style=>style.includes(searchTerm))})}}}
this.updateFilterButtonsWithFilteredCount(albums);if(this.currentFilter!=='all'){albums=albums.filter(album=>{if(this.currentFilter==='owned'){return album.is_owned==1}else if(this.currentFilter==='wanted'){return album.want_to_own==1}
return!0})}
try{const sortedAlbums=this.sortAlbums(albums);this.renderAlbums(sortedAlbums)}catch(error){console.error('Sorting error:',error);this.renderAlbums(albums)}}else{this.showMessage('Error loading albums: '+data.message,'error')}}catch(error){this.showMessage('Error loading albums','error')}finally{this.hideLoading();if(tableContainer){tableContainer.classList.remove('loading')}}}
renderAlbums(albums){const tbody=document.querySelector('#albumsTable tbody');if(albums.length===0){tbody.innerHTML=`
              <tr>
                  <td colspan="6" class="empty-state">
                      <h3>No albums found</h3>
                      <p>Try adjusting your search or filter criteria</p>
                  </td>
              </tr>
          `;return}
tbody.innerHTML=albums.map(album=>`
          <tr data-id="${album.id}" data-artist-type="${album.artist_type || ''}">
              <td class="cover-cell">
                  ${album.cover_url ? 
                      `<img data-src="${album.cover_url}" data-medium="${album.cover_url_medium || album.cover_url}" data-large="${album.cover_url_large || album.cover_url}" class="album-cover lazy" alt="Album cover" data-artist="${this.escapeHtml(album.artist_name)}" data-album="${this.escapeHtml(album.album_name)}" data-year="${album.release_year || ''}" data-cover="${album.cover_url_large || album.cover_url}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" onload="this.classList.add('loaded')" width="60" height="60"><div class="no-cover" style="display: none;">No Cover</div>` : 
                      '<div class="no-cover">No Cover</div>'
                  }
                  <div class="mobile-status">
                      ${album.is_owned ? '<span class="status-owned">Own</span>' : ''}
                      ${album.want_to_own ? '<span class="status-wanted">Want</span>' : ''}
                      ${!album.is_owned && !album.want_to_own ? '<span class="status-none">-</span>' : ''}
                  </div>
              </td>
              <td>
                  <div class="album-info">
                      <div class="artist-name">${this.escapeHtml(album.artist_name)}</div>
                      <div class="album-name">
                          <a href="#" class="album-link" data-artist="${this.escapeHtml(album.artist_name)}" data-album="${this.escapeHtml(album.album_name)}" data-year="${album.release_year || ''}">
                              ${this.escapeHtml(album.album_name)}
                          </a>
                      </div>
                      <div class="mobile-year">${album.release_year ? `<button type="button" class="year-link" data-year="${album.release_year}"><span class="year-badge">${album.release_year}</span></button>` : '<span class="year-badge">-</span>'}</div>
                      <div class="mobile-actions">
                          <button class="btn-edit" data-id="${album.id}">
                              <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="Edit" style="vertical-align: text-top;">
                                <title>edit</title>
                                <path d="M4 20h4l10.5-10.5a2 2 0 0 0 0-2.8l-1.2-1.2a2 2 0 0 0-2.8 0L4 16v4z" />
                                <path d="M13.5 6.5l4 4" />
                              </svg>
                              Edit
                          </button>
                          <button class="btn-delete" data-id="${album.id}">
                              &times; 
                              Delete
                          </button>
                      </div>
                  </div>
              </td>
              <td>
                  ${album.release_year ? `<button type="button" class="year-link" data-year="${album.release_year}"><span class="year-badge">${album.release_year}</span></button>` : '<span class="year-badge">-</span>'}
              </td>
              <td>
                  ${album.is_owned ? '<span class="checkmark">✓</span>' : '<span class="checkmark">&nbsp;</span>'}
              </td>
              <td>
                  ${album.want_to_own ? '<span class="checkmark">✓</span>' : '<span class="checkmark">&nbsp;</span>'}
              </td>
              <td>
                  <div class="action-buttons">
                      <button class="btn-edit" data-id="${album.id}">
                          <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="Edit" style="vertical-align: text-top;">
                            <title>edit</title>
                            <path d="M4 20h4l10.5-10.5a2 2 0 0 0 0-2.8l-1.2-1.2a2 2 0 0 0-2.8 0L4 16v4z" />
                            <path d="M13.5 6.5l4 4" />
                          </svg>
                          Edit
                      </button>
                      <button class="btn-delete" data-id="${album.id}">
                          &times; 
                          Delete
                      </button>
                  </div>
              </td>
          </tr>
      `).join('');this.initLazyLoading();this.updateAuthUI()}
async fetchMasterYearForSelection(releaseId,yearInput,fallbackYear=null){try{const response=await this.fetchWithCache(`api/music_api.php?action=master_year&release_id=${releaseId}`);const data=await response.json();if(data.success&&data.data&&data.data.master_year){if(yearInput){yearInput.value=data.data.master_year}}else if(fallbackYear){if(yearInput){yearInput.value=fallbackYear}}}catch(error){if(fallbackYear&&yearInput){yearInput.value=fallbackYear}}
this.updateSaveButtonState()}
async editAlbum(id){try{const response=await this.fetchWithCache(`api/music_api.php?action=album&id=${id}`);const data=await response.json();if(data.success){this.editingAlbum=data.data;this.showModal(data.data)}else{this.showMessage('Error loading album: '+data.message,'error')}}catch(error){this.showMessage('Error loading album','error')}}
async deleteAlbum(id){if(!this.isAuthenticated){this.showLoginModal();return}
if(!confirm('Are you sure you want to delete this album?')){return}
try{const controller=new AbortController();const timeoutId=setTimeout(()=>controller.abort(),10000);const response=await fetch('api/music_api.php?action=delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:id}),signal:controller.signal});clearTimeout(timeoutId);const data=await response.json();if(data.success){this.showMessage('Album deleted successfully','success');this.loadAlbums();this.loadStats()}else{if(data.auth_required){this.showLoginModal()}else{this.showMessage('Error deleting album: '+data.message,'error')}}}catch(error){if(error.name==='AbortError'){this.showMessage('Delete request timed out. Please try again.','error')}else{this.showMessage('Error deleting album','error')}}}
showModal(album=null){const modal=document.getElementById('albumModal');const form=document.getElementById('albumForm');const title=document.querySelector('#albumModal h2');const viewRecordBtn=document.getElementById('viewRecordBtn');form.reset();this.hideModalMessage();if(album){title.textContent='Edit Album';document.getElementById('artistName').value=album.artist_name;document.getElementById('albumName').value=album.album_name;document.getElementById('releaseYear').value=album.release_year||'';const formatInput=document.getElementById('albumFormat');formatInput.value=album.format||'';formatInput.readOnly=!1;this.selectedCoverUrl=album.cover_url||null;this.selectedDiscogsReleaseId=album.discogs_release_id||null;if(album.is_owned==1){document.getElementById('isOwned').checked=!0}else if(album.want_to_own==1){document.getElementById('wantToOwn').checked=!0}
const albumInput=document.getElementById('albumName');albumInput.disabled=!1;albumInput.placeholder='Enter album name...';viewRecordBtn.style.display='block';this.editingAlbum=album;this.updateSaveButtonState()}else{title.textContent='Add New Album';this.editingAlbum=null;viewRecordBtn.style.display='none';this.selectedCoverUrl=null;this.selectedDiscogsReleaseId=null;const formatInput=document.getElementById('albumFormat');formatInput.value='';formatInput.readOnly=!0;this.updateAlbumInputState()}
modal.style.display='block';this.updateSaveButtonState();document.getElementById('artistName').focus()}
hideModal(){document.getElementById('albumModal').style.display='none';this.editingAlbum=null;this.selectedCoverUrl=null;this.selectedDiscogsReleaseId=null;this.hideModalMessage()}
async showViewRecordModal(){if(!this.editingAlbum){return}
const modal=document.getElementById('viewRecordModal');const recordData=document.getElementById('recordData');try{const response=await this.fetchWithCache(`api/music_api.php?action=album&id=${this.editingAlbum.id}`);const data=await response.json();if(data.success&&data.data){this.originalAlbumData=data.data;const formattedData=JSON.stringify(data.data,null,2);recordData.textContent=formattedData}else{recordData.textContent='Error loading album data: '+(data.message||'Unknown error')}}catch(error){recordData.textContent='Error loading album data: '+error.message}
modal.style.display='block'}
hideViewRecordModal(){const modal=document.getElementById('viewRecordModal');modal.style.display='none';this.cancelRecordEditing();this.hideModal()}
enableRecordEditing(){const recordData=document.getElementById('recordData');const editBtn=document.getElementById('editRecordBtn');const saveBtn=document.getElementById('saveRecordBtn');const cancelBtn=document.getElementById('cancelEditBtn');const editWarning=document.getElementById('editWarning');const editError=document.getElementById('editError');this.originalRecordData=recordData.textContent;this.createProtectedJsonEditor();editBtn.style.display='none';saveBtn.style.display='block';cancelBtn.style.display='block';editWarning.style.display='block';editError.style.display='none'}
cancelRecordEditing(){const recordData=document.getElementById('recordData');const editBtn=document.getElementById('editRecordBtn');const saveBtn=document.getElementById('saveRecordBtn');const cancelBtn=document.getElementById('cancelEditBtn');const editWarning=document.getElementById('editWarning');const editError=document.getElementById('editError');if(this.originalRecordData){recordData.textContent=this.originalRecordData}
recordData.contentEditable=!1;editBtn.style.display='block';saveBtn.style.display='none';cancelBtn.style.display='none';editWarning.style.display='none';editError.style.display='none';this.originalRecordData=null;this.originalAlbumData=null}
createProtectedJsonEditor(){const recordData=document.getElementById('recordData');const albumData=this.originalAlbumData;if(!albumData)return;recordData.innerHTML='';recordData.contentEditable=!1;const editorContainer=document.createElement('div');editorContainer.className='protected-json-editor';editorContainer.style.fontFamily='monospace';editorContainer.style.whiteSpace='pre';editorContainer.style.lineHeight='1.4';let indentLevel=1;Object.entries(albumData).forEach(([key,value],index)=>{const indent='  '.repeat(indentLevel);const isLast=index===Object.keys(albumData).length-1;const comma=isLast?'':',';const keySpan=document.createElement('span');keySpan.textContent=`"${key}":`;keySpan.style.color='#0066cc';keySpan.style.fontWeight='bold';keySpan.contentEditable=!1;const valueInput=document.createElement('span');valueInput.textContent=typeof value==='string'?`"${value}"`:value;if(key==='id'){valueInput.contentEditable=!1;valueInput.style.color='#6c757d';valueInput.style.fontStyle='italic';valueInput.style.backgroundColor='#f8f9fa';valueInput.style.padding='2px 4px';valueInput.style.borderRadius='3px';valueInput.style.border='1px solid #dee2e6'}else{valueInput.contentEditable=!0;valueInput.style.outline='none';valueInput.style.border='1px solid transparent';valueInput.style.borderRadius='2px';valueInput.style.padding='2px 4px';valueInput.style.backgroundColor='#ffffff';valueInput.style.color='#212529';valueInput.style.fontWeight='500'}
valueInput.dataset.key=key;valueInput.dataset.originalValue=value;if(key!=='id'){valueInput.addEventListener('mouseenter',()=>{valueInput.style.backgroundColor='#e3f2fd';valueInput.style.borderColor='#007bff'});valueInput.addEventListener('mouseleave',()=>{valueInput.style.backgroundColor='#ffffff';valueInput.style.borderColor='transparent'});valueInput.addEventListener('focus',()=>{valueInput.style.backgroundColor='#e3f2fd';valueInput.style.borderColor='#007bff';valueInput.style.boxShadow='0 0 0 2px rgba(0, 123, 255, 0.25)'});valueInput.addEventListener('blur',()=>{valueInput.style.backgroundColor='#ffffff';valueInput.style.borderColor='transparent';valueInput.style.boxShadow='none'})}
const lineDiv=document.createElement('div');lineDiv.style.marginLeft=`${indentLevel * 20}px`;lineDiv.appendChild(keySpan);lineDiv.appendChild(valueInput);if(!isLast){const commaSpan=document.createElement('span');commaSpan.textContent=',';lineDiv.appendChild(commaSpan)}
editorContainer.appendChild(lineDiv)});recordData.appendChild(editorContainer);const firstValueInput=recordData.querySelector('[contenteditable="true"]');if(firstValueInput){firstValueInput.focus()}}
collectDataFromProtectedEditor(){const recordData=document.getElementById('recordData');const albumData={...this.originalAlbumData};const editableFields=recordData.querySelectorAll('[contenteditable="true"]');editableFields.forEach(field=>{const key=field.dataset.key;const originalValue=field.dataset.originalValue;let newValue=field.textContent.trim();if(typeof originalValue==='string'){if(newValue.startsWith('"')&&newValue.endsWith('"')){newValue=newValue.slice(1,-1)}
albumData[key]=newValue}else if(typeof originalValue==='number'){albumData[key]=parseFloat(newValue)||originalValue}else if(typeof originalValue==='boolean'){albumData[key]=newValue.toLowerCase()==='true'}else if(originalValue===null){albumData[key]=newValue==='null'?null:newValue}else{albumData[key]=newValue}});return albumData}
async saveRecordChanges(){const recordData=document.getElementById('recordData');const editBtn=document.getElementById('editRecordBtn');const saveBtn=document.getElementById('saveRecordBtn');const cancelBtn=document.getElementById('cancelEditBtn');try{const editedData=this.collectDataFromProtectedEditor();if(!editedData.artist_name||!editedData.album_name){throw new Error('Artist name and album name are required')}
if(editedData.id!==this.editingAlbum.id){throw new Error('Cannot change the album ID. This field is protected to prevent data conflicts.')}
const response=await fetch('api/music_api.php?action=update_raw',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(editedData)});const data=await response.json();if(data.success){this.editingAlbum=editedData;recordData.textContent=JSON.stringify(editedData,null,2);recordData.contentEditable=!1;editBtn.style.display='block';saveBtn.style.display='none';cancelBtn.style.display='none';const editWarning=document.getElementById('editWarning');editWarning.style.display='none';this.originalRecordData=null;this.showMessage('Record updated successfully','success');this.loadAlbums();this.hideViewRecordModal()}else{throw new Error(data.message||'Failed to update record')}}catch(error){const editError=document.getElementById('editError');editError.innerHTML=`<strong>❌ Error:</strong> ${error.message}`;editError.style.display='block';if(this.originalRecordData){recordData.textContent=this.originalRecordData}}}
hideModalMessage(){const messageEl=document.getElementById('modalMessage');messageEl.style.display='none';messageEl.textContent='';messageEl.className='modal-message'}
async saveAlbum(){if(!this.isAuthenticated){this.showLoginModal();return}
const form=document.getElementById('albumForm');const formData=new FormData(form);const albumStatus=formData.get('albumStatus');if(!albumStatus){this.showModalMessage('Please select either "I own this album" or "I want to own this album"','error');return}
const albumData={artist_name:formData.get('artistName'),album_name:formData.get('albumName'),release_year:formData.get('releaseYear'),format:formData.get('albumFormat'),is_owned:albumStatus==='owned',want_to_own:albumStatus==='wanted',cover_url:this.selectedCoverUrl||null,discogs_release_id:this.selectedDiscogsReleaseId||null};const action=this.editingAlbum?'update':'add';if(this.editingAlbum){albumData.id=this.editingAlbum.id}
try{const response=await fetch(`api/music_api.php?action=${action}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(albumData)});if(!response.ok){throw new Error(`HTTP ${response.status}: ${response.statusText}`)}
const responseText=await response.text();if(!responseText.trim()){throw new Error('Empty response from server')}
let data;try{data=JSON.parse(responseText)}catch(jsonError){throw new Error(`Invalid JSON response: ${jsonError.message}`)}
if(data.success){this.hideModal();this.showMessage(data.message,'success');this.loadAlbums();this.loadStats();this.editingAlbum=null}else{if(data.auth_required){this.showLoginModal()}else{this.showModalMessage(data.message||'Unknown error occurred','error')}}}catch(error){this.showModalMessage('Network error: '+error.message,'error')}}
showLoading(){document.getElementById('loading').style.display='block'}
hideLoading(){document.getElementById('loading').style.display='none'}
showModalMessage(message,type){const messageEl=document.getElementById('modalMessage');messageEl.textContent=message;messageEl.className=`modal-message ${type}`;messageEl.style.display='block';setTimeout(()=>{messageEl.style.display='none'},5000)}
showMessage(message,type){const messageEl=document.getElementById('message');messageEl.textContent=message;messageEl.className=`message ${type}`;messageEl.style.display='block';setTimeout(()=>{messageEl.style.display='none'},5000)}
async showCoverModal(artistName,albumName,releaseYear,coverUrl,albumId=null){const modal=document.getElementById('coverModal');const image=document.getElementById('coverModalImage');const info=document.getElementById('coverModalInfo');image.src=coverUrl;image.alt=`${albumName} by ${artistName}`;info.innerHTML=`
          <div class="artist-name">${this.escapeHtml(artistName)}</div>
          <div class="album-name"><a href="javascript:void(0)" class="album-link" data-artist="${this.escapeHtml(artistName)}" data-album="${this.escapeHtml(albumName)}" data-year="${releaseYear || ''}" data-album-id="${albumId || ''}">${this.escapeHtml(albumName)}</a></div>
          ${releaseYear ? `<div class="album-year">${releaseYear}</div>` : ''}
      `;const albumLink=info.querySelector('.album-link');if(albumLink){albumLink.addEventListener('click',(e)=>{e.preventDefault();e.stopPropagation();const artist=albumLink.dataset.artist;const album=albumLink.dataset.album;const year=albumLink.dataset.year;const albumId=albumLink.dataset.albumId;this.showTracklist(artist,album,year,albumId);this.hideCoverModal()})}
modal.style.display='block';if(albumId){try{const params=new URLSearchParams({artist:artistName,album:albumName});if(releaseYear){params.append('year',releaseYear)}
params.append('album_id',albumId);const response=await this.fetchWithCache(`api/tracklist_api.php?${params}`);const data=await response.json();if(data.success&&data.data&&data.data.master_year){const yearElement=info.querySelector('.album-year');if(yearElement){yearElement.textContent=data.data.master_year}}}catch(error){}}}
hideCoverModal(){document.getElementById('coverModal').style.display='none'}
async showTracklist(artistName,albumName,releaseYear,albumId=null){const modal=document.getElementById('tracklistModal');const title=document.getElementById('tracklistModalTitle');const info=document.getElementById('tracklistModalInfo');const tracks=document.getElementById('tracklistModalTracks');const discogsLink=document.getElementById('tracklistModalDiscogsLink');const coverImage=document.getElementById('tracklistModalCover');const noCover=document.getElementById('tracklistModalNoCover');title.textContent=`${albumName}`;info.innerHTML=`
          <div><strong>Artist:</strong> ${artistName}</div>
          ${releaseYear ? `<div><strong>Year:</strong>${releaseYear}</div>` : ''}
      `;coverImage.style.display='none';noCover.style.display='none';noCover.textContent='';let existingImage=null;if(albumId){const tableRow=document.querySelector(`tr[data-id="${albumId}"]`);if(tableRow){const tableImage=tableRow.querySelector('.album-cover');if(tableImage&&tableImage.src&&tableImage.src!==window.location.href){existingImage=tableImage.src}}}
if(existingImage){coverImage.src=existingImage;coverImage.style.display='block';noCover.style.display='none';coverImage.classList.add('loaded')}
tracks.innerHTML='<div class="tracklist-loading">Loading tracklist...</div>';modal.style.display='block';const editBtn=document.getElementById('tracklistEditBtn');if(editBtn){if(this.isAuthenticated&&albumId){editBtn.style.display='flex';editBtn.dataset.albumId=albumId;editBtn.dataset.artistName=artistName;editBtn.dataset.albumName=albumName;editBtn.dataset.releaseYear=releaseYear||''}else{editBtn.style.display='none'}}
try{const params=new URLSearchParams({artist:artistName,album:albumName});if(releaseYear){params.append('year',releaseYear)}
if(albumId){params.append('album_id',albumId)}
const response=await fetch(`api/tracklist_api.php?${params}`,{cache:'no-cache',headers:{'Content-Type':'application/json'}});const data=await response.json();if(data.success&&data.data){const albumData=data.data;let formattedReleased='';if(albumData.released){try{let dateString=albumData.released;let hasDay00=!1;if(dateString.match(/^\d{4}-\d{2}-00$/)){hasDay00=!0;dateString=dateString.replace('-00','-01')}
const dateParts=dateString.split('-');const year=parseInt(dateParts[0]);const month=parseInt(dateParts[1])-1;const day=parseInt(dateParts[2]);const date=new Date(year,month,day);if(!isNaN(date.getTime())){const month=date.getMonth();const day=date.getDate();if(hasDay00||(month===11&&day===31)){formattedReleased=year.toString()}else{formattedReleased=date.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}}else{formattedReleased=albumData.released}}catch(e){formattedReleased=albumData.released}}
let reviewsDisplay='';if(albumData.rating_count){const reviewText=albumData.rating_count===1?'review':'reviews';if(albumData.has_reviews_with_content){reviewsDisplay=`<div class="rating-count">(based on <a href="${albumData.discogs_url}#release-reviews" target="_blank" rel="noopener noreferrer" style="padding-left: .25em;">${albumData.rating_count} ${reviewText}</a>)</div>`}else{reviewsDisplay=`<div class="rating-count">(based on ${albumData.rating_count} ${reviewText})</div>`}}
const removeTrailingNumbers=(text)=>{if(!text)return text;return text.replace(/\s*\(\d+\)\s*$/,'')};info.innerHTML=`
                  <div><strong>Artist:</strong> <span>${removeTrailingNumbers(albumData.artist)}</span></div>
                  ${formattedReleased ? `<div><strong>Year:</strong><span>${formattedReleased}</span></div>` : ''}
                  ${albumData.label ? `<div><strong>Label:</strong><span>${removeTrailingNumbers(albumData.label)}</span></div>` : ''}
                  ${albumData.year ? `<div><strong>Released:</strong><span>${albumData.year}</span></div>` : ''}
                  ${albumData.format ? `<div><strong>Format:</strong><span>${albumData.format}</span></div>` : ''}
                  ${albumData.producer ? `<div><strong>Producer:</strong><span>${removeTrailingNumbers(albumData.producer)}</span></div>` : ''}
                  ${albumData.rating ? `<div><strong>Rating:</strong><span class="rating-value">${albumData.rating}${this.generateStarRating(albumData.rating)}</span>${reviewsDisplay}</div>` : ''}
              `;if(!existingImage&&albumData.cover_url){const coverUrl=albumData.cover_url_medium||albumData.cover_url;const isCachedImage=coverUrl.includes('api/image_proxy.php');if(isCachedImage){coverImage.style.display='none';noCover.style.display='none';noCover.textContent=''}else{noCover.textContent='Loading Cover...';noCover.style.display='flex';coverImage.style.display='none'}
coverImage.src=coverUrl;const imageTimeout=setTimeout(()=>{if(coverImage.style.display==='none'){coverImage.style.display='none';noCover.textContent='No Cover';noCover.style.display='flex'}},10000);coverImage.onload=function(){clearTimeout(imageTimeout);coverImage.style.display='block';noCover.style.display='none';coverImage.classList.add('loaded')};coverImage.onerror=function(){clearTimeout(imageTimeout);coverImage.style.display='none';noCover.textContent='No Cover';noCover.style.display='flex'}}else if(!existingImage&&!albumData.cover_url){coverImage.style.display='none';noCover.textContent='No Cover';noCover.style.display='flex'}
discogsLink.href=albumData.discogs_url;if(albumData.matched_reason){const matchInfo=document.createElement('div');matchInfo.className='tracklist-match-info';matchInfo.innerHTML=`<small>Matched: ${albumData.matched_reason}</small>`;tracks.appendChild(matchInfo)}
if(albumData.tracklist&&albumData.tracklist.length>0){tracks.innerHTML=`
                      <div class="tracklist-modal-tracks">
                          ${albumData.tracklist.map(track => `<div class="track-item"><span class="track-position">${track.position}</span><span class="track-title">${this.escapeHtml(track.title)}</span><span class="track-duration">${track.duration||''}</span></div>`).join('')}
                      </div>
                  `}else{tracks.innerHTML='<div class="tracklist-error">No tracklist available for this album</div>'}}else{let errorMessage='Could not load tracklist';if(data.message&&!data.message.includes('Discogs API request failed')){errorMessage=data.message}
tracks.innerHTML=`<div class="tracklist-error">${errorMessage}</div>`;discogsLink.href=`https://www.discogs.com/search/?q=${encodeURIComponent(artistName + ' ' + albumName)}&type=release`}}catch(error){tracks.innerHTML='<div class="tracklist-error">Could not load tracklist. Please try again later.</div>';discogsLink.href=`https://www.discogs.com/search/?q=${encodeURIComponent(artistName + ' ' + albumName)}&type=release`}}
hideTracklistModal(){document.getElementById('tracklistModal').style.display='none'}
handleTracklistEdit(){const editBtn=document.getElementById('tracklistEditBtn');if(!editBtn||!editBtn.dataset.albumId){return}
const albumId=editBtn.dataset.albumId;this.hideTracklistModal();this.editAlbum(parseInt(albumId))}
showLoginModal(){document.getElementById('loginModal').style.display='block';document.getElementById('password').focus();document.getElementById('loginMessage').style.display='none'}
showStatsModal(){document.getElementById('statsModal').style.display='block'}
hideStatsModal(){document.getElementById('statsModal').style.display='none'}
showResetPasswordModal(){if(!this.isAuthenticated){this.showLoginModal();return}
document.getElementById('resetPasswordMessage').style.display='none';document.getElementById('resetPasswordForm').reset();document.getElementById('resetPasswordModal').style.display='block';document.getElementById('reset_current_password').focus()}
hideResetPasswordModal(){document.getElementById('resetPasswordModal').style.display='none';document.getElementById('resetPasswordForm').reset();document.getElementById('resetPasswordMessage').style.display='none'}
async handleResetPassword(event){event.preventDefault();const currentPassword=document.getElementById('reset_current_password').value;const newPassword=document.getElementById('reset_new_password').value;const confirmPassword=document.getElementById('reset_confirm_password').value;const messageDiv=document.getElementById('resetPasswordMessage');try{const response=await fetch('api/music_api.php?action=reset_password',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({current_password:currentPassword,new_password:newPassword,confirm_password:confirmPassword})});const data=await response.json();if(data.success){messageDiv.textContent=data.message;messageDiv.className='modal-message success';messageDiv.style.display='block';document.getElementById('resetPasswordForm').reset();setTimeout(()=>{this.hideResetPasswordModal()},3000)}else{messageDiv.textContent=data.message;messageDiv.className='modal-message error';messageDiv.style.display='block'}}catch(error){messageDiv.textContent='Network error. Please try again.';messageDiv.className='modal-message error';messageDiv.style.display='block'}}
showSetupModal(){if(!this.isAuthenticated){this.showLoginModal();return}
this.loadSetupStatus();document.getElementById('setupMessage').style.display='none';document.getElementById('setupForm').reset();document.getElementById('setupModal').style.display='block';this.setupThemeCustomization();document.getElementById('setup_discogs_api_key').focus()}
hideSetupModal(){document.getElementById('setupModal').style.display='none';document.getElementById('setupForm').reset();document.getElementById('setupMessage').style.display='none'}
async loadSetupStatus(){try{const response=await fetch('api/music_api.php?action=get_setup_status');const data=await response.json();if(data.success){const statusData=data.data;const apiKeyStatus=document.getElementById('apiKeyStatus');const currentApiKeyDisplay=document.getElementById('currentApiKeyDisplay');const currentApiKeyText=document.getElementById('currentApiKeyText');if(statusData.api_key_set){apiKeyStatus.textContent='✅ Set';apiKeyStatus.className='status-value set';currentApiKeyDisplay.style.display='block';currentApiKeyText.textContent=statusData.current_api_key}else{apiKeyStatus.textContent='❌ Not set';apiKeyStatus.className='status-value not-set';currentApiKeyDisplay.style.display='none'}
const passwordActionText=document.getElementById('passwordActionText');passwordActionText.textContent='Change Password';const overallStatus=document.getElementById('overallStatus');if(statusData.api_key_set){overallStatus.textContent='✅ Complete';overallStatus.className='status-value set'}else{overallStatus.textContent='⚠️ Incomplete';overallStatus.className='status-value not-set'}}}catch(error){console.error('Error loading setup status:',error)}}
async handleSetupConfig(event){event.preventDefault();const discogsApiKey=document.getElementById('setup_discogs_api_key').value;const messageDiv=document.getElementById('setupMessage');try{const response=await fetch('api/music_api.php?action=setup_config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({discogs_api_key:discogsApiKey})});const data=await response.json();if(data.success){messageDiv.textContent=data.message;messageDiv.className='modal-message success';messageDiv.style.display='block';document.getElementById('setupForm').reset();this.loadSetupStatus();setTimeout(()=>{this.hideSetupModal()},3000)}else{messageDiv.textContent=data.message;messageDiv.className='modal-message error';messageDiv.style.display='block'}}catch(error){messageDiv.textContent='Network error. Please try again.';messageDiv.className='modal-message error';messageDiv.style.display='block'}}
hideLoginModal(){const modal=document.getElementById('loginModal');if(modal){modal.style.display='none'}
document.getElementById('password').value='';const messageDiv=document.getElementById('loginMessage');if(messageDiv){messageDiv.style.display='none'}}
async handleLogin(event){event.preventDefault();const password=document.getElementById('password').value;const messageDiv=document.getElementById('loginMessage');if(!password){messageDiv.textContent='Please enter a password.';messageDiv.className='modal-message error';messageDiv.style.display='block';return}
try{const controller=new AbortController();const timeoutId=setTimeout(()=>controller.abort(),10000);const response=await fetch('api/music_api.php?action=login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({password:password}),signal:controller.signal});clearTimeout(timeoutId);const data=await response.json();if(data.success){await this.checkAuthStatus();this.hideLoginModal();this.showMessage('Login successful','success')}else{messageDiv.textContent=data.message;messageDiv.className='modal-message error';messageDiv.style.display='block'}}catch(error){if(error.name==='AbortError'){messageDiv.textContent='Login request timed out. Please try again.'}else{messageDiv.textContent='Login failed. Please try again.'}
messageDiv.className='modal-message error';messageDiv.style.display='block'}}
async handleLogout(){try{const response=await fetch('api/music_api.php?action=logout',{method:'POST',headers:{'Content-Type':'application/json'}});const data=await response.json();if(data.success){await this.checkAuthStatus();this.showMessage('Logged out successfully','success')}}catch(error){}}
initLazyLoading(){if('IntersectionObserver' in window){const imageObserver=new IntersectionObserver((entries,observer)=>{entries.forEach(entry=>{if(entry.isIntersecting){const img=entry.target;this.loadOptimizedImage(img,img.dataset.src);img.classList.remove('lazy');img.classList.add('loaded');observer.unobserve(img)}})},{rootMargin:'50px 0px',threshold:0.01});document.querySelectorAll('img.lazy').forEach(img=>{imageObserver.observe(img)})}else{this.loadLazyImagesFallback()}}
loadLazyImagesFallback(){const lazyImages=document.querySelectorAll('img.lazy');const loadImage=(img)=>{if(img.dataset.src){this.loadOptimizedImage(img,img.dataset.src);img.classList.remove('lazy')}};lazyImages.forEach(img=>{if(this.isElementInViewport(img)){loadImage(img)}});const scrollHandler=()=>{lazyImages.forEach(img=>{if(img.classList.contains('lazy')&&this.isElementInViewport(img)){loadImage(img)}})};window.addEventListener('scroll',scrollHandler);window.addEventListener('resize',scrollHandler)}
isElementInViewport(el){const rect=el.getBoundingClientRect();return(rect.top>=0&&rect.left>=0&&rect.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&rect.right<=(window.innerWidth||document.documentElement.clientWidth))}
escapeHtml(text){const div=document.createElement('div');div.textContent=text;return div.innerHTML}
decodeHtmlEntities(text){const div=document.createElement('div');div.innerHTML=text;return div.textContent}
formatDate(dateString){if(!dateString)return'-';const date=new Date(dateString);return date.toLocaleDateString()}
loadOptimizedImage(img,src,fallbackSrc=null){const webpSupported=this.isWebPSupported();if(webpSupported&&src.includes('discogs.com')&&!src.includes('fm=webp')){const webpSrc=src.includes('?')?src+'&fm=webp':src+'?fm=webp';img.src=webpSrc;img.onerror=()=>{img.src=src;if(fallbackSrc){img.onerror=()=>{img.src=fallbackSrc}}}}else{img.src=src;if(fallbackSrc){img.onerror=()=>{img.src=fallbackSrc}}}}
isWebPSupported(){const canvas=document.createElement('canvas');canvas.width=1;canvas.height=1;return canvas.toDataURL('image/webp').indexOf('data:image/webp')===0}
generateStarRating(rating){const fullStars=Math.floor(rating);const decimal=rating%1;let fractionalStar='';if(decimal>=0.875){fractionalStar='filled'}else if(decimal>=0.625){fractionalStar='three-quarter'}else if(decimal>=0.375){fractionalStar='half'}else if(decimal>=0.125){fractionalStar='quarter'}
const totalStars=fullStars+(fractionalStar?1:0);const emptyStars=5-totalStars;let starsHTML='<span class="stars">';for(let i=0;i<fullStars;i++){starsHTML+='<span class="star filled">★</span>'}
if(fractionalStar&&fractionalStar!=='filled'){starsHTML+=`<span class="star ${fractionalStar}">★</span>`}else if(fractionalStar==='filled'){starsHTML+='<span class="star filled">★</span>'}
for(let i=0;i<emptyStars;i++){starsHTML+='<span class="star empty">☆</span>'}
starsHTML+='</span>';return starsHTML}
adjustAutocompletePosition(container,list){const modal=container.closest('.modal');if(!modal)return;const modalContent=modal.querySelector('.modal-content');const containerRect=container.getBoundingClientRect();const modalRect=modalContent.getBoundingClientRect();list.style.top='100%';list.style.bottom='auto';list.style.maxHeight='1200px';const spaceBelow=modalRect.bottom-containerRect.bottom-20;const spaceAbove=containerRect.top-modalRect.top-20;const listHeight=Math.min(list.scrollHeight,1200);if(spaceBelow<200&&spaceAbove>spaceBelow+100){list.style.top='auto';list.style.bottom='100%';list.style.maxHeight=`${Math.min(spaceAbove - 20, 1200)}px`;list.style.overflowY='auto';list.style.overflowX='hidden'}else{list.style.top='100%';list.style.bottom='auto';if(spaceBelow<listHeight){list.style.maxHeight=`${Math.max(spaceBelow - 20, 300)}px`}else{list.style.maxHeight=`${Math.min(spaceBelow - 20, 1200)}px`}
list.style.overflowY='auto';list.style.overflowX='hidden'}
const listWidth=list.offsetWidth;const containerWidth=container.offsetWidth;if(listWidth>containerWidth){list.style.width=`${containerWidth}px`}
list.style.zIndex='10000';list.style.visibility='visible';list.style.opacity='1'}
moveAutocompleteToBody(container,list){const modal=container.closest('.modal');if(!modal)return;if(list.parentNode!==document.body){document.body.appendChild(list);const containerRect=container.getBoundingClientRect();list.style.position='fixed';list.style.top=(containerRect.bottom+window.scrollY)+'px';list.style.left=containerRect.left+'px';list.style.width=containerRect.width+'px';list.style.zIndex='10000';list.style.backgroundColor='white';list.style.border='1px solid #ddd';list.style.borderRadius='4px';list.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)';list.style.display='block';list.style.visibility='visible';list.style.opacity='1';list.dataset.originalContainer=container.id}}
setupThemeCustomization(){this.loadThemeColors();const color1Picker=document.getElementById('gradientColor1');const color2Picker=document.getElementById('gradientColor2');const color1Hex=document.getElementById('gradientColor1Hex');const color2Hex=document.getElementById('gradientColor2Hex');const resetBtn=document.getElementById('resetThemeBtn');const saveBtn=document.getElementById('saveThemeBtn');if(color1Picker){color1Picker.addEventListener('change',(e)=>{color1Hex.value=e.target.value;this.previewTheme()})}
if(color2Picker){color2Picker.addEventListener('change',(e)=>{color2Hex.value=e.target.value;this.previewTheme()})}
if(color1Hex){color1Hex.addEventListener('input',(e)=>{const color=e.target.value;if(this.isValidHexColor(color)){color1Picker.value=color;this.previewTheme()}})}
if(color2Hex){color2Hex.addEventListener('input',(e)=>{const color=e.target.value;if(this.isValidHexColor(color)){color2Picker.value=color;this.previewTheme()}})}
if(resetBtn){resetBtn.addEventListener('click',()=>{this.resetTheme()})}
if(saveBtn){saveBtn.addEventListener('click',()=>{this.saveThemeColors();this.showThemeMessage('Theme colors saved successfully!','success')})}}
async loadThemeColors(){try{const response=await fetch('api/theme_api.php');const data=await response.json();if(data.success){const serverColor1=data.data.gradient_color_1;const serverColor2=data.data.gradient_color_2;const localColor1=localStorage.getItem('gradientColor1');const localColor2=localStorage.getItem('gradientColor2');if(localColor1&&localColor2&&(localColor1!==serverColor1||localColor2!==serverColor2)){console.log('localStorage colors differ from server, updating localStorage');localStorage.setItem('gradientColor1',serverColor1);localStorage.setItem('gradientColor2',serverColor2)}
this.updateColorPickerInputs(serverColor1,serverColor2);this.applyThemeColors(serverColor1,serverColor2)}else{console.warn('Server theme load failed:',data.message);this.fallbackToLocalStorage()}}catch(error){console.warn('Server theme load error:',error);this.fallbackToLocalStorage()}}
fallbackToLocalStorage(){const localColor1=localStorage.getItem('gradientColor1')||'#667eea';const localColor2=localStorage.getItem('gradientColor2')||'#764ba2';console.log('Falling back to localStorage:',localColor1,localColor2);this.updateColorPickerInputs(localColor1,localColor2);this.applyThemeColors(localColor1,localColor2)}
updateColorPickerInputs(color1,color2){const color1Picker=document.getElementById('gradientColor1');const color1Hex=document.getElementById('gradientColor1Hex');const color2Picker=document.getElementById('gradientColor2');const color2Hex=document.getElementById('gradientColor2Hex');if(color1Picker&&color1Hex&&color2Picker&&color2Hex){color1Picker.value=color1;color1Hex.value=color1;color2Picker.value=color2;color2Hex.value=color2}}
async saveThemeColors(){const color1=document.getElementById('gradientColor1').value;const color2=document.getElementById('gradientColor2').value;localStorage.setItem('gradientColor1',color1);localStorage.setItem('gradientColor2',color2);this.applyThemeColors(color1,color2);try{const response=await fetch('api/theme_api.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({gradient_color_1:color1,gradient_color_2:color2})});const data=await response.json();if(!data.success){console.warn('Failed to save theme to server:',data.message)}}catch(error){console.warn('Failed to save theme to server:',error)}}
applyThemeColors(color1,color2){document.body.style.background=`linear-gradient(135deg, ${color1} 0%, ${color2} 100%)`}
previewTheme(){const color1=document.getElementById('gradientColor1').value;const color2=document.getElementById('gradientColor2').value;this.applyThemeColors(color1,color2)}
resetTheme(){const defaultColor1='#667eea';const defaultColor2='#764ba2';const color1Picker=document.getElementById('gradientColor1');const color1Hex=document.getElementById('gradientColor1Hex');const color2Picker=document.getElementById('gradientColor2');const color2Hex=document.getElementById('gradientColor2Hex');if(color1Picker&&color1Hex&&color2Picker&&color2Hex){color1Picker.value=defaultColor1;color1Hex.value=defaultColor1;color2Picker.value=defaultColor2;color2Hex.value=defaultColor2;this.applyThemeColors(defaultColor1,defaultColor2);this.saveThemeColors()}}
isValidHexColor(color){return/^#[0-9A-Fa-f]{6}$/.test(color)}
showSetupMessage(message,type){const messageDiv=document.getElementById('setupMessage');if(messageDiv){messageDiv.textContent=message;messageDiv.className=`modal-message ${type}`;messageDiv.style.display='block';setTimeout(()=>{messageDiv.style.display='none'},3000)}}
showThemeMessage(message,type){const messageDiv=document.getElementById('themeMessage');if(messageDiv){messageDiv.textContent=message;messageDiv.className=`modal-message ${type}`;messageDiv.style.display='block';setTimeout(()=>{messageDiv.style.display='none'},3000)}}
async clearAllCaches(){try{if('caches' in window){const cacheNames=await caches.keys();await Promise.all(cacheNames.map(cacheName=>caches.delete(cacheName)))}
localStorage.clear();sessionStorage.clear();this.selectedArtist=null;this.selectedAlbum=null;this.selectedCoverUrl=null;this.selectedDiscogsReleaseId=null;const currentUrl=new URL(window.location.href);currentUrl.searchParams.set('_cache_clear',Date.now());currentUrl.searchParams.set('cache_cleared','true');window.location.href=currentUrl.toString()}catch(error){console.error('Error clearing caches:',error);this.showMessage('Error clearing caches. Please try again.','error')}}
handleSort(sortField){if(this.currentSort.field===sortField){this.currentSort.direction=this.currentSort.direction==='asc'?'desc':'asc'}else{this.currentSort.field=sortField;this.currentSort.direction='asc'}
this.updateSortIndicators();this.renderAlbumsWithSort()}
updateSortIndicators(){document.querySelectorAll('.sortable-header').forEach(header=>{header.classList.remove('sort-asc','sort-desc')});const currentHeader=document.querySelector(`[data-sort="${this.currentSort.field}"]`);if(currentHeader){currentHeader.classList.add(`sort-${this.currentSort.direction}`)}}
renderAlbumsWithSort(){const tbody=document.querySelector('#albumsTable tbody');const rows=Array.from(tbody.querySelectorAll('tr'));const albums=rows.map(row=>{if(row.classList.contains('empty-state'))return null;const artistName=row.querySelector('.artist-name')?.textContent||'';const albumName=row.querySelector('.album-name a')?.textContent||'';const yearElement=row.querySelector('.year-link');const releaseYear=yearElement?yearElement.dataset.year:'';const isOwned=row.querySelector('td:nth-child(4) .checkmark')?.textContent==='✓';const wantToOwn=row.querySelector('td:nth-child(5) .checkmark')?.textContent==='✓';return{id:row.dataset.id,artist_name:artistName,album_name:albumName,release_year:releaseYear,is_owned:isOwned?1:0,want_to_own:wantToOwn?1:0,cover_url:row.querySelector('.album-cover')?.dataset.src||'',cover_url_medium:row.querySelector('.album-cover')?.dataset.medium||'',cover_url_large:row.querySelector('.album-cover')?.dataset.large||'',artist_type:row.dataset.artistType||null}}).filter(album=>album!==null);const sortedAlbums=this.sortAlbums(albums);this.renderAlbums(sortedAlbums)}
sortAlbums(albums){return albums.sort((a,b)=>{const artistTypeA=a.artist_type||null;const artistTypeB=b.artist_type||null;if(this.currentSort.field==='year'){const yearA=parseInt(a.release_year)||0;const yearB=parseInt(b.release_year)||0;if(this.currentSort.direction==='desc'){if(yearA!==yearB){return yearB-yearA}
return this.getSortableArtistName(a.artist_name,artistTypeA).localeCompare(this.getSortableArtistName(b.artist_name,artistTypeB))}else{if(yearA!==yearB){return yearA-yearB}
return this.getSortableArtistName(a.artist_name,artistTypeA).localeCompare(this.getSortableArtistName(b.artist_name,artistTypeB))}}else if(this.currentSort.field==='album'){const artistComparison=this.getSortableArtistName(a.artist_name,artistTypeA).localeCompare(this.getSortableArtistName(b.artist_name,artistTypeB));if(this.currentSort.direction==='desc'){if(artistComparison!==0){return-artistComparison}
const yearA=parseInt(a.release_year)||0;const yearB=parseInt(b.release_year)||0;if(yearA!==yearB){return yearA-yearB}
return this.getSortableAlbumName(a.album_name).localeCompare(this.getSortableAlbumName(b.album_name))}else{if(artistComparison!==0){return artistComparison}
const yearA=parseInt(a.release_year)||0;const yearB=parseInt(b.release_year)||0;if(yearA!==yearB){return yearA-yearB}
return this.getSortableAlbumName(a.album_name).localeCompare(this.getSortableAlbumName(b.album_name))}}else{return this.getSortableArtistName(a.artist_name,artistTypeA).localeCompare(this.getSortableArtistName(b.artist_name,artistTypeB))}})}
getSortableArtistName(artistName,artistType=null){if(!artistName)return'';const name=artistName.trim();const lowerName=name.toLowerCase();if(lowerName.includes('elvis costello')&&lowerName.includes('attractions')){return'Costello, Elvis & The Attractions'}
const prefixes=['the ','a ','an '];for(const prefix of prefixes){if(lowerName.startsWith(prefix)){return name.substring(prefix.length).trim()}}
if(artistType){if(artistType.toLowerCase()==='group'){return name}else if(artistType.toLowerCase()==='person'){const parts=name.split(' ');if(parts.length===2){const firstName=parts[0];const lastName=parts[1];const commonSuffixes=['jr','sr','ii','iii','iv','v','vi','vii','viii','ix','x'];if(commonSuffixes.includes(lastName.toLowerCase())&&parts.length>2){return parts[parts.length-2]+', '+parts.slice(0,-2).join(' ')+' '+parts[parts.length-1]}else{return lastName+', '+firstName}}
return name}}
const parts=name.split(' ');const bandIndicators=['&','and','featuring','feat','ft','with','vs','versus'];const hasBandIndicator=bandIndicators.some(indicator=>lowerName.includes(indicator));const lastWord=parts[parts.length-1];const hasNumberSuffix=/^\d+$/.test(lastWord);const isLikelyBand=hasBandIndicator||hasNumberSuffix||parts.length>3;if(!isLikelyBand&&parts.length===2){const firstName=parts[0];const lastName=parts[1];const commonSuffixes=['jr','sr','ii','iii','iv','v','vi','vii','viii','ix','x'];if(commonSuffixes.includes(lastName.toLowerCase())&&parts.length>2){return parts[parts.length-2]+', '+parts.slice(0,-2).join(' ')+' '+parts[parts.length-1]}else{return lastName+', '+firstName}}
return name}
getSortableAlbumName(albumName){if(!albumName)return'';const name=albumName.trim();const lowerName=name.toLowerCase();const prefixes=['the ','a ','an '];for(const prefix of prefixes){if(lowerName.startsWith(prefix)){return name.substring(prefix.length).trim()}}
return name}}
document.addEventListener('DOMContentLoaded',async()=>{window.app=new MusicCollectionApp();await window.app.init()})